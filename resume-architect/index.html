<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BABA Studio - Elite HD Resume Engine</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- Cropper.js for professional photo framing -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,400&family=Poppins:wght@300;400;500;600;700;900&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Inter"', 'sans-serif'],
                        serif: ['"Merriweather"', 'serif'],
                        poppins: ['"Poppins"', 'sans-serif'],
                        mono: ['"Roboto Mono"', 'monospace']
                    },
                    colors: {
                        ios: { blue: '#007AFF', pink: '#FF2D55', purple: '#5856D6' }
                    }
                }
            }
        }
    </script>

    <style>
        :root { --accent-color: #0D9488; --accent-gradient: linear-gradient(135deg, #0D9488 0%, #0F766E 100%); }
        * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; text-rendering: optimizeLegibility; box-sizing: border-box; }
        
        /* Animated Liquid Background */
        @keyframes liquidGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%; 
            background: linear-gradient(-45deg, #f8fafc, #e0e7ff, #f3e8ff, #ccfbf1);
            background-size: 400% 400%;
            animation: liquidGradient 15s ease infinite;
            font-family: 'Inter', sans-serif; overflow: hidden; 
        }

        /* Dashboard */
        #view-dashboard { height: 100vh; overflow-y: auto; scroll-behavior: smooth; z-index: 5; }
        .landing-section { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 6rem 2rem; position: relative; }
        
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob { animation: blob 10s infinite; }
        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }
        
        @keyframes float3d {
            0% { transform: translateY(0px) rotateX(5deg) rotateY(-15deg); }
            50% { transform: translateY(-20px) rotateX(8deg) rotateY(-12deg); }
            100% { transform: translateY(0px) rotateX(5deg) rotateY(-15deg); }
        }
        .animate-float-3d { animation: float3d 8s ease-in-out infinite; transform-style: preserve-3d; }
        
        @keyframes floatBadge {
            0% { transform: translateY(0px) translateZ(40px); }
            50% { transform: translateY(-10px) translateZ(60px); }
            100% { transform: translateY(0px) translateZ(40px); }
        }
        .animate-float-badge { animation: floatBadge 5s ease-in-out infinite reverse; transform-style: preserve-3d; }
        
        .perspective-1000 { perspective: 1000px; }

        /* View Switching */
        .view-section { position: fixed; inset: 0; opacity: 0; pointer-events: none; transition: opacity 0.4s ease; z-index: 0; display: none; }
        .view-active { opacity: 1; pointer-events: auto; display: flex !important; flex-direction: column; z-index: 10; }
        
        /* Gradients */
        .text-gradient { background: linear-gradient(135deg, #2563EB 0%, #9333EA 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .text-gradient-teal { background: linear-gradient(135deg, #0D9488 0%, #2563EB 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-gradient { background: linear-gradient(135deg, #2563EB 0%, #4F46E5 100%); color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2); transition: all 0.2s; border: none; }
        .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 12px 30px rgba(37, 99, 235, 0.35); }

        /* Premium 3D Glassmorphism */
        .ios-glass { 
            background: rgba(255, 255, 255, 0.55); 
            backdrop-filter: blur(40px) saturate(200%); 
            -webkit-backdrop-filter: blur(40px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.8); 
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.05), inset 0 2px 2px rgba(255,255,255,0.8); 
        }
        
        .input-label { color: #475569; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.7rem; margin-bottom: 0.4rem; display: flex; justify-content: space-between; align-items: center; text-shadow: 0 1px 1px rgba(255,255,255,0.5); }
        .ios-input { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid #E2E8F0; border-radius: 12px; padding: 12px 14px; font-size: 14px; width: 100%; color: #1E293B; font-weight: 600; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
        .ios-input:focus { border-color: var(--accent-color); background: #ffffff; outline: none; box-shadow: 0 0 0 4px rgba(13, 148, 136, 0.15), inset 0 2px 4px rgba(0,0,0,0.01); transform: translateY(-1px); }

        /* 3D Segmented Control (Tabs) */
        .ios-segmented-control { 
            background: rgba(226, 232, 240, 0.6); 
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.06), inset 0 1px 2px rgba(0,0,0,0.04);
            border-radius: 16px; 
            padding: 6px; 
            display: flex; 
            width: 100%; 
            gap: 6px; 
        }
        .ios-tab { 
            flex: 1; text-align: center; padding: 12px 0; border-radius: 12px; 
            font-size: 13px; font-weight: 800; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            cursor: pointer; border: none; text-transform: uppercase; letter-spacing: 0.05em; 
            position: relative;
        }
        .ios-tab-active { 
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%); 
            box-shadow: 0 6px 12px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.05), inset 0 2px 0 rgba(255,255,255,1); 
            color: #2563EB; 
            transform: translateY(-1px);
        }
        .ios-tab-inactive { color: #64748B; background: transparent; }
        .ios-tab-inactive:hover { color: #334155; transform: translateY(-1px); }

        /* Preview Canvas & Typography Variables */
        #preview-viewport { flex: 1; overflow: auto; display: flex; justify-content: center; padding: 40px; }
        .page-container { 
            width: 210mm; 
            min-height: 297mm; 
            background: #FFFFFF; 
            transform-origin: top center; 
            color: #1E293B; 
            box-shadow: 0 30px 80px rgba(0,0,0,0.12); 
            position: relative; 
            overflow: visible; 
            font-family: var(--font-family, 'Inter', sans-serif);
            background-image: linear-gradient(to bottom, transparent 296.5mm, #94A3B8 296.5mm, #94A3B8 297.5mm, transparent 297.5mm);
            background-size: 100% 297mm;
            border-radius: 4px;
        }
        
        .resume-content { line-height: 1.5; font-size: var(--body-size, 9.5pt); color: #334155; }
        .resume-content strong, .resume-content b { font-weight: 700; color: #0F172A; }
        
        .resume-section { margin-bottom: 24px; page-break-inside: avoid; break-inside: avoid; position: relative; }
        .resume-section h2 { 
            font-size: calc(var(--body-size, 9.5pt) + 1.5pt); 
            font-weight: var(--heading-weight, 900); 
            padding: 4px 12px; margin-bottom: 12px; 
            text-transform: uppercase; letter-spacing: 2px; color: #fff; background: var(--accent-gradient); 
            display: inline-block; border-radius: 4px; page-break-after: avoid; 
        }
        
        .entry-box { background: rgba(0,0,0,0.02); padding: 18px; border-radius: 12px; margin-bottom: 14px; border: 1px solid rgba(0,0,0,0.04); page-break-inside: avoid; break-inside: avoid; }
        .date-badge { background: #F1F5F9; padding: 2px 10px; border-radius: 100px; font-size: calc(var(--body-size, 9.5pt) - 1pt); font-weight: 700; color: #475569; float: right; }
        .entry-title { font-weight: var(--heading-weight, 700); font-size: calc(var(--body-size, 9.5pt) + 0.5pt); }

        .brand-logo-fixed { position: absolute; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: var(--accent-color); font-size: 28pt; z-index: 10; user-select: none; }
        .brand-logo-fixed:active { cursor: grabbing !important; }

        /* Modal */
        #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(15px); z-index: 100; display: none; align-items: center; justify-content: center; }
        #crop-modal { position: fixed; inset: 0; background: rgba(255,255,255,0.7); backdrop-filter: blur(25px); z-index: 200; display: none; align-items: center; justify-content: center; }
        .crop-container { width: 100%; max-width: 500px; height: 400px; background: #000; border-radius: 24px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 30px 60px rgba(0,0,0,0.2);}
        #crop-image { max-width: 100%; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.5); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.8); }

        /* Styling Selectors in Mastery */
        .design-card { background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); padding: 12px; border-radius: 14px; border: 1.5px solid transparent; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .design-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.05); border-color: rgba(203, 213, 225, 0.5); }
        .design-card-active { border-color: var(--accent-color); background: #ffffff; box-shadow: 0 8px 20px rgba(0,0,0,0.08), inset 0 2px 0 var(--accent-color); transform: translateY(-2px); }

        /* AutoComplete Styles */
        .autocomplete-suggestions { position: absolute; border: 1px solid rgba(255,255,255,0.8); border-top: none; z-index: 1000; top: 100%; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(15px); border-radius: 0 0 14px 14px; overflow-y: auto; max-height: 180px; box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .autocomplete-suggestions div { padding: 12px 16px; cursor: pointer; background-color: transparent; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.85rem; font-weight: 600; color: #475569; transition: background 0.2s;}
        .autocomplete-suggestions div:hover { background-color: rgba(239, 246, 255, 0.9); color: #2563EB; }

        /* Upload Button Override */
        .upload-btn {
            background: linear-gradient(180deg, #ffffff 0%, #f1f5f9 100%); color: #334155; font-weight: 800; text-transform: uppercase; font-size: 10px;
            padding: 12px 24px; border-radius: 12px; cursor: pointer; display: inline-block; letter-spacing: 0.1em;
            border: 1px solid #CBD5E1; box-shadow: 0 4px 10px rgba(0,0,0,0.05), inset 0 2px 0 rgba(255,255,255,1); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .upload-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 15px rgba(0,0,0,0.08), inset 0 2px 0 rgba(255,255,255,1); color: #2563EB; border-color: #94A3B8;}
        
        .photo-preview-container { width: 90px; height: 90px; border-radius: 50%; border: 4px solid #fff; background: rgba(0,0,0,0.04); overflow: hidden; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 30px rgba(0,0,0,0.06); }
    </style>
</head>
<body class="text-slate-800">

    <!-- TOAST NOTIFICATION FOR AUTO-SAVE -->
    <div id="toast-notification" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-sm z-[1000] transition-all duration-500 opacity-0 -translate-y-full pointer-events-none flex items-center gap-3">
        <i class="fa-solid fa-circle-check text-teal-400"></i>
        <span id="toast-message">Session restored successfully.</span>
    </div>

    <!-- MODAL: ADD CUSTOM SECTION -->
    <div id="modal-overlay">
        <div class="ios-glass p-10 rounded-[40px] w-full max-w-md shadow-2xl text-center">
            <h3 class="text-xl font-black mb-6 text-slate-800 uppercase tracking-tight">Add Module</h3>
            <input type="text" id="modal-input" class="ios-input mb-6 text-center text-lg" placeholder="e.g. Certifications" autofocus>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-4 rounded-2xl font-bold bg-white text-slate-600 hover:bg-slate-50 uppercase text-[10px] tracking-widest border border-slate-200 shadow-sm transition-all">Cancel</button>
                <button onclick="confirmAddSection()" class="flex-1 py-4 rounded-2xl font-bold btn-gradient text-white uppercase text-[10px] tracking-widest border-none">Create</button>
            </div>
        </div>
    </div>

    <!-- MODAL: CROPPER -->
    <div id="crop-modal">
        <div class="ios-glass p-8 rounded-[40px] w-full max-w-xl flex flex-col items-center shadow-2xl border border-white">
            <h3 class="text-xl font-black text-slate-800 uppercase tracking-tight mb-6">Frame Headshot</h3>
            <div class="crop-container"><img id="crop-image" src=""></div>
            <div class="flex gap-4 w-full">
                <button onclick="closeCropModal()" class="flex-1 py-4 rounded-2xl font-bold bg-white text-slate-600 uppercase text-[10px] tracking-widest border border-slate-200 shadow-sm hover:bg-slate-50 transition-all">Cancel</button>
                <button onclick="finalizeCrop()" class="flex-1 py-4 rounded-2xl font-bold btn-gradient text-white uppercase text-[10px] tracking-widest border-none">Apply Photo</button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="view-dashboard" class="view-section view-active relative overflow-hidden">
        
        <!-- Ambient Glowing Deep Space Orbs -->
        <div class="fixed top-20 left-10 w-[500px] h-[500px] bg-blue-500/20 rounded-full mix-blend-multiply filter blur-[120px] animate-blob pointer-events-none z-0"></div>
        <div class="fixed top-40 right-10 w-[500px] h-[500px] bg-purple-500/20 rounded-full mix-blend-multiply filter blur-[120px] animate-blob animation-delay-2000 pointer-events-none z-0"></div>
        <div class="fixed -bottom-20 left-1/2 transform -translate-x-1/2 w-[600px] h-[600px] bg-teal-400/20 rounded-full mix-blend-multiply filter blur-[120px] animate-blob animation-delay-4000 pointer-events-none z-0"></div>

        <nav class="fixed top-6 inset-x-6 z-50 flex items-center justify-between px-8 py-4 ios-glass rounded-[24px] max-w-7xl mx-auto shadow-sm border border-white/60">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 btn-gradient rounded-xl flex items-center justify-center text-white shadow-lg"><i class="fa-solid fa-feather-pointed"></i></div>
                <div class="flex flex-col justify-center">
                    <h1 class="text-xl font-black tracking-tight text-slate-900 uppercase leading-none">BABA Studio</h1>
                    <span class="text-[8px] font-bold text-slate-500 uppercase tracking-widest mt-0.5">Powered by Baba Tools</span>
                </div>
            </div>
            <button onclick="window.startNewResume()" class="dash-start-btn btn-gradient text-white px-8 py-3 rounded-full text-xs font-bold hover:scale-105 transition-all shadow-md uppercase tracking-wide border-none">Create Resume</button>
        </nav>

        <!-- HERO SECTION -->
        <section class="landing-section relative z-10 w-full py-24 h-auto">
            <div class="max-w-7xl w-full grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-16 xl:gap-24 items-center reveal-node visible pt-16">
                <!-- Left: Typography & CTA -->
                <div class="text-left space-y-6 lg:space-y-8 z-10">
                    <div class="inline-flex items-center gap-2 px-5 py-2 ios-glass rounded-full border border-white/80 text-[10px] font-bold uppercase tracking-widest text-slate-600 shadow-sm">
                        <span class="w-2 h-2 rounded-full bg-teal-500 animate-pulse"></span> Powered by BABA Tools
                    </div>
                    <h1 class="text-5xl md:text-6xl xl:text-7xl font-black tracking-tight uppercase leading-[1.05] text-slate-900 drop-shadow-sm">
                        BUILD WHAT <br><span class="text-gradient">HIRES YOU.</span>
                    </h1>
                    <p class="text-slate-600 text-lg md:text-xl xl:text-2xl font-bold leading-relaxed max-w-md">
                        100% free. No sign-up drama.
                    </p>
                    <div class="pt-4 flex flex-wrap gap-4">
                        <button onclick="window.startNewResume()" class="dash-start-btn btn-gradient px-8 py-4 md:px-10 md:py-4 rounded-[20px] text-sm md:text-base font-bold shadow-xl hover:shadow-blue-500/30 hover:-translate-y-1 transition-all border-none flex items-center gap-3">
                            Create My Resume <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                    <div class="flex flex-wrap items-center gap-4 md:gap-5 pt-4 text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-widest">
                        <span class="flex items-center gap-1 md:gap-2"><i class="fa-solid fa-check text-teal-500"></i> Local Storage Save</span>
                        <span class="flex items-center gap-1 md:gap-2"><i class="fa-solid fa-check text-teal-500"></i> Vector PDF Export</span>
                    </div>
                </div>

                <!-- Right: 3D Floating Resume Mockup -->
                <div class="relative hidden lg:flex h-[500px] perspective-1000 items-center justify-center">
                    <div class="absolute inset-0 flex items-center justify-center animate-float-3d scale-75 xl:scale-100 origin-center">
                        <!-- Main Glass Card -->
                        <div class="w-[380px] h-[500px] ios-glass rounded-[40px] border border-white/80 shadow-[0_30px_60px_rgba(0,0,0,0.08)] p-8 flex flex-col gap-6 relative overflow-hidden bg-white/40">
                            <!-- Header Skeleton -->
                            <div class="flex gap-5 items-center border-b border-slate-200/50 pb-5">
                                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 border-4 border-white shadow-sm"></div>
                                <div class="space-y-3 flex-1">
                                    <div class="h-4 w-3/4 bg-slate-800/80 rounded-full"></div>
                                    <div class="h-2 w-1/2 bg-blue-600/60 rounded-full"></div>
                                    <div class="h-1.5 w-full bg-slate-400/50 rounded-full mt-2"></div>
                                </div>
                            </div>
                            <!-- Body Skeletons -->
                            <div class="space-y-4 flex-1">
                                <div class="h-6 w-1/3 bg-teal-600/80 rounded-lg mb-4"></div>
                                <div class="h-20 w-full ios-glass rounded-2xl border border-white"></div>
                                <div class="h-20 w-full ios-glass rounded-2xl border border-white"></div>
                            </div>
                            
                            <!-- Floating Badge 1 -->
                            <div class="absolute -right-4 top-1/4 ios-glass p-3 rounded-2xl shadow-xl border border-white/80 animate-float-badge bg-white/90">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-600"><i class="fa-solid fa-file-pdf text-sm"></i></div>
                                    <div>
                                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Format</div>
                                        <div class="text-xs font-black text-slate-800">Vector HD</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Floating Badge 2 -->
                            <div class="absolute -left-6 bottom-1/4 ios-glass p-3 rounded-2xl shadow-xl border border-white/80 animate-float-badge bg-white/90" style="animation-delay: -2.5s;">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-teal-50 flex items-center justify-center text-teal-500"><i class="fa-solid fa-shield-check text-sm"></i></div>
                                    <div>
                                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Privacy</div>
                                        <div class="text-xs font-black text-slate-800">Local Save</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BENTO BOX FEATURES -->
        <section class="landing-section relative z-10 w-full bg-slate-50/30 backdrop-blur-md border-y border-white/50 py-24 h-auto">
            <div class="max-w-7xl w-full grid grid-cols-1 lg:grid-cols-3 gap-8 md:gap-10 reveal-node">
                <!-- Large Box 1 -->
                <div class="lg:col-span-2 ios-glass p-8 md:p-10 lg:p-14 rounded-[40px] flex flex-col justify-center overflow-hidden relative border border-white hover:shadow-xl transition-shadow duration-500 group">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-blue-400/10 to-transparent rounded-bl-[100px] -z-10 group-hover:scale-110 transition-transform duration-700"></div>
                    <div class="space-y-6 max-w-lg relative z-10">
                        <div class="w-12 h-12 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center text-xl shadow-sm border border-blue-100"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
                        <h3 class="text-3xl lg:text-4xl font-black text-slate-900 tracking-tight leading-[1.1]">Studio-Grade<br>Typography.</h3>
                        <p class="text-base font-medium text-slate-500 leading-relaxed">Instantly switch between pristine sans-serifs, authoritative serifs, and modern tech fonts. Adjust scaling and weight with millimeter precision.</p>
                    </div>
                </div>
                <!-- Small Box 1 -->
                <div class="ios-glass p-8 md:p-10 rounded-[40px] flex flex-col justify-center border border-white hover:shadow-xl transition-shadow duration-500 group">
                    <div class="space-y-5 relative z-10">
                        <div class="w-12 h-12 rounded-2xl bg-teal-50 text-teal-600 flex items-center justify-center text-xl shadow-sm border border-teal-100"><i class="fa-solid fa-lock"></i></div>
                        <h3 class="text-2xl font-black text-slate-900 tracking-tight leading-[1.1]">Zero<br>Data Track.</h3>
                        <p class="text-sm font-medium text-slate-500 leading-relaxed">Your data never leaves your device. Silent local auto-saves ensure you never lose your work.</p>
                    </div>
                </div>
                <!-- Small Box 2 -->
                <div class="ios-glass p-8 md:p-10 rounded-[40px] flex flex-col justify-center border border-white hover:shadow-xl transition-shadow duration-500 group">
                    <div class="space-y-5 relative z-10">
                        <div class="w-12 h-12 rounded-2xl bg-purple-50 text-purple-600 flex items-center justify-center text-xl shadow-sm border border-purple-100"><i class="fa-solid fa-palette"></i></div>
                        <h3 class="text-2xl font-black text-slate-900 tracking-tight leading-[1.1]">Dynamic<br>Templates.</h3>
                        <p class="text-sm font-medium text-slate-500 leading-relaxed">From vibrant sidebars to stark minimalist headers. Inject custom gradient accents to match your brand.</p>
                    </div>
                </div>
                 <!-- Large Box 2 -->
                 <div class="lg:col-span-2 ios-glass p-8 md:p-10 lg:p-14 rounded-[40px] flex flex-col justify-center overflow-hidden relative border border-white hover:shadow-xl transition-shadow duration-500 group bg-slate-900/95 backdrop-blur-xl">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-teal-400/10 to-transparent rounded-bl-[100px] -z-10 group-hover:scale-110 transition-transform duration-700"></div>
                    <div class="space-y-6 max-w-lg relative z-10">
                        <div class="w-12 h-12 rounded-2xl bg-white/10 text-teal-400 flex items-center justify-center text-xl border border-white/10"><i class="fa-solid fa-file-pdf"></i></div>
                        <h3 class="text-3xl lg:text-4xl font-black text-white tracking-tight leading-[1.1]">Flawless<br>PDF Export.</h3>
                        <p class="text-base font-medium text-slate-400 leading-relaxed">Unlike basic web tools, the BABA Engine generates perfectly scaled, text-selectable A4 vector PDFs that sail through Applicant Tracking Systems (ATS).</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- FINAL CTA -->
        <section class="landing-section relative z-10 min-h-[60vh] py-20">
            <div class="max-w-4xl w-full text-center space-y-8 reveal-node">
                <h2 class="text-5xl md:text-6xl lg:text-7xl font-black tracking-tight uppercase leading-[1.05] text-slate-900">THE WAIT <br><span class="text-gradient">IS OVER.</span></h2>
                <button onclick="window.startNewResume()" class="dash-start-btn btn-gradient px-10 py-4 md:px-12 md:py-5 rounded-[24px] text-base md:text-lg font-black flex items-center gap-4 hover:scale-105 transition-all mx-auto shadow-xl uppercase border-none">
                    <i class="fa-solid fa-bolt-lightning text-xl text-white/80"></i> Create Resume
                </button>
            </div>
        </section>
    </div>

    <!-- EDITOR -->
    <div id="view-editor" class="view-section hidden">
        <header class="h-20 px-8 ios-glass flex items-center justify-between shrink-0 m-5 rounded-[30px] shadow-sm text-slate-800 relative z-30">
            <div class="flex items-center gap-5">
                <button onclick="window.goToDashboard()" class="w-10 h-10 rounded-full bg-white hover:bg-slate-50 flex items-center justify-center transition-all border border-slate-200 shadow-sm"><i class="fa-solid fa-arrow-left text-slate-600"></i></button>
                <div class="h-6 w-px bg-slate-200"></div>
                <div class="flex items-center gap-2">
                    <button onclick="window.undo()" id="undo-btn" class="w-10 h-10 rounded-full bg-white hover:bg-slate-50 border border-transparent hover:border-slate-200 shadow-sm flex items-center justify-center disabled:opacity-30 transition-all"><i class="fa-solid fa-rotate-left text-slate-500"></i></button>
                    <button onclick="window.redo()" id="redo-btn" class="w-10 h-10 rounded-full bg-white hover:bg-slate-50 border border-transparent hover:border-slate-200 shadow-sm flex items-center justify-center disabled:opacity-30 transition-all"><i class="fa-solid fa-rotate-right text-slate-500"></i></button>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="window.togglePreview(true)" class="px-6 py-2.5 text-xs font-bold text-slate-700 bg-white rounded-full shadow-sm border border-slate-200 hover:bg-slate-50 hover:text-blue-600 transition-all focus:outline-none uppercase tracking-widest"><i class="fa-regular fa-eye mr-2"></i> <span id="preview-btn-text">Preview & Style</span></button>
                <button onclick="window.downloadPDF()" class="btn-gradient text-white px-8 py-2.5 rounded-full text-xs font-bold shadow-md active:scale-95 transition-all uppercase tracking-widest border-none"><i class="fa-solid fa-download mr-2"></i> Export PDF</button>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden relative px-5 pb-5 gap-5">
            <aside id="left-sidebar" class="w-80 flex flex-col ios-glass rounded-[32px] overflow-hidden shadow-lg relative z-20">
                <div class="p-5 border-b border-white/40">
                    <div class="ios-segmented-control">
                        <button onclick="window.switchSidebarTab('content')" id="tab-content" class="ios-tab ios-tab-active">Content</button>
                        <button onclick="window.switchSidebarTab('design')" id="tab-design" class="ios-tab ios-tab-inactive">Mastery</button>
                    </div>
                </div>
                
                <div id="sidebar-content" class="flex-1 overflow-y-auto px-5 pb-5 space-y-1 pt-4 font-bold text-slate-600">
                    <div id="section-list"></div>
                    <button onclick="window.openCustomSectionModal()" class="mt-4 w-full py-4 border-2 border-dashed border-slate-300 rounded-2xl text-[10px] font-bold text-slate-500 hover:text-blue-600 hover:border-blue-400 hover:bg-white/50 transition-all uppercase tracking-widest bg-transparent shadow-sm">+ Add Module</button>
                </div>
                
                <div id="sidebar-design" class="hidden flex-1 overflow-y-auto px-6 pb-8 space-y-10 pt-6 text-slate-800 font-bold">
                    <div id="typography-container"></div>
                    <div><h4 class="input-label font-black text-slate-900">HD Templates</h4><div id="template-grid" class="grid grid-cols-1 gap-3"></div></div>
                    <div><h4 class="input-label font-black text-slate-900">Branding Icon</h4><div id="brand-grid" class="grid grid-cols-2 gap-3"></div></div>
                    <div><h4 class="input-label font-black text-slate-900">Icon Position</h4><p class="text-[10px] font-medium text-slate-500">Drag the logo directly on the preview to position it anywhere.</p></div>
                    <div><h4 class="input-label font-black text-slate-900">Hierarchy</h4><p class="text-[9px] text-slate-500 mb-3 tracking-widest uppercase">Drag to reorder</p><div id="order-list" class="space-y-2"></div></div>
                    <div><h4 class="input-label font-black text-slate-900">Accent Gradient</h4><div id="color-picker" class="flex gap-3 flex-wrap bg-white/40 p-4 rounded-2xl border border-white shadow-sm"></div></div>
                </div>
            </aside>
            
            <div class="flex-1 overflow-y-auto ios-glass rounded-[40px] shadow-xl relative z-10" id="editor-panel">
                <div class="max-w-3xl mx-auto py-16 px-10 pb-48">
                    <div id="form-container" class="space-y-10 animate-fade-in text-slate-800" onkeydown="window.handleEnterNav(event)"></div>
                    <div class="flex justify-between mt-16 pt-10 border-t border-white/50">
                        <button onclick="window.goToPrevSection()" id="btn-prev-section" class="px-8 py-4 rounded-2xl border border-slate-300 text-slate-600 font-bold text-[10px] uppercase tracking-widest hover:bg-white transition-all shadow-sm">Back</button>
                        <button onclick="window.goToNextSection()" id="btn-next-section" class="btn-gradient text-white px-14 py-4 rounded-2xl text-[10px] font-bold uppercase tracking-widest transition-all shadow-md">Next Phase</button>
                    </div>
                </div>
            </div>
            
            <aside id="right-preview" class="absolute inset-y-0 right-0 w-full md:w-[850px] ios-glass shadow-2xl z-50 transform translate-x-full transition-transform duration-500 flex flex-col overflow-hidden">
                <div class="h-20 flex items-center justify-between px-10 border-b border-white/40 text-slate-800 bg-white/60 backdrop-blur-md z-10">
                    <div class="flex flex-col justify-center">
                        <span class="text-[12px] font-black text-slate-900 uppercase tracking-[0.15em] leading-none">Live Output</span>
                        <span class="text-[8px] font-bold text-slate-500 uppercase tracking-[0.2em] mt-1">Powered by Baba Tools</span>
                    </div>
                    <button onclick="window.togglePreview(false)" class="w-10 h-10 rounded-full bg-white flex items-center justify-center hover:bg-slate-50 transition-all text-slate-600 border border-slate-200 focus:outline-none shadow-sm"><i class="fa-solid fa-xmark text-lg"></i></button>
                </div>
                <div id="preview-viewport"><div id="resume-preview" class="page-container resume-content"></div></div>
            </aside>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const COUNTRY_CODES = [{code:'+91',name:'India'},{code:'+1',name:'USA'},{code:'+44',name:'UK'},{code:'+971',name:'UAE'},{code:'+81',name:'JPN'},{code:'+61',name:'AUS'}];
        const SECTORS = [
            {id:'none', name:'No Brand', icon:''},
            {id:'medical', name:'Medical Care', icon:'fa-stethoscope'},
            {id:'tech', name:'Tech Systems', icon:'fa-microchip'},
            {id:'eng', name:'Engineer Hub', icon:'fa-gears'},
            {id:'sales', name:'Global Sales', icon:'fa-chart-line'},
            {id:'finance', name:'Finance', icon:'fa-building-columns'}
        ];
        const JOB_TITLES = ['Software Engineer', 'Senior Software Engineer', 'Product Manager', 'Data Scientist', 'Data Analyst', 'Marketing Manager', 'Clinical Nurse', 'Registered Nurse', 'Sales Executive', 'Financial Analyst', 'Operations Manager', 'Project Manager', 'Graphic Designer', 'UX/UI Designer'];
        
        const SUMMARY_TEMPLATES = {
            'Tech/Engineering': "Results-driven Software Engineer with [X] years of experience architecting scalable web applications. Proven expertise in [Skill 1], [Skill 2], and driving agile development cycles to deliver high-impact solutions.",
            'Management/Operations': "Dynamic Operations Manager with a track record of streamlining processes and boosting productivity by [X]%. Adept at leading cross-functional teams, managing $ [X] budgets, and implementing strategic operational improvements.",
            'Healthcare/Medical': "Dedicated Clinical Professional with [X] years of experience providing top-tier patient care. Strong background in [Specialty], patient advocacy, and collaborating with multidisciplinary medical teams to improve health outcomes.",
            'Sales/Marketing': "High-performing Sales Executive who consistently exceeds quota by [X]%. Expert in B2B relationship building, strategic market positioning, and driving revenue growth in competitive territories."
        };

        const QUICK_SKILLS = ['Project Management', 'JavaScript', 'Python', 'Customer Service', 'Data Analysis', 'Agile/Scrum', 'Public Speaking', 'SEO', 'Sales', 'Team Leadership'];
        const QUICK_LANGUAGES = ['English', 'Spanish', 'French', 'German', 'Mandarin', 'Hindi', 'Arabic'];

        const TEMPLATES = [
            {id:'clinical', name:'Clinical Catalyst', desc:'Vibrant Sidebar IA (Optimized Space).'},
            {id:'modern', name:'Modern Pro', desc:'Full-Width Colored Banner IA.'}, 
            {id:'classic', name:'Classic Clean', desc:'Minimalist & Airy Center Align.'},
            {id:'audit', name:'Technical Audit', desc:'Mono Space Logging.'}
        ];
        
        const COLORS = [
            {hex: '#0D9488', grad: 'linear-gradient(135deg, #0D9488 0%, #0F766E 100%)'}, // Teal
            {hex: '#2563EB', grad: 'linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%)'}, // Royal Blue
            {hex: '#7C3AED', grad: 'linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%)'}, // Violet
            {hex: '#E11D48', grad: 'linear-gradient(135deg, #E11D48 0%, #BE123C 100%)'}, // Rose
            {hex: '#EA580C', grad: 'linear-gradient(135deg, #EA580C 0%, #C2410C 100%)'}, // Orange
            {hex: '#334155', grad: 'linear-gradient(135deg, #334155 0%, #1E293B 100%)'}  // Slate 
        ];
        
        const LANG_LEVELS = ['Native', 'Fluent', 'Professional', 'Intermediate', 'Beginner'];
        const SECTION_LABELS = { personal: 'Identity', summary: 'Professional Summary', experience: 'Work Experience', education: 'Academic History', skills: 'Expertise & Skills', languages: 'Languages', certifications: 'Certifications', passport: 'Passport Details' };
        
        let resumeData = { 
            settings: { 
                template: 'clinical', 
                color: '#0D9488', 
                gradient: 'linear-gradient(135deg, #0D9488 0%, #0F766E 100%)', 
                logoLeft: '10%', 
                logoTop: '5%',
                fontFamily: "'Inter', sans-serif",
                titleSize: 24,
                bodySize: 9.5,
                headingWeight: '900'
            }, 
            order: ['personal', 'summary', 'experience', 'education', 'skills', 'languages', 'certifications', 'passport'], 
            visibility: { personal: true, summary: true, experience: true, education: true, skills: true, languages: true, certifications: true, passport: true },
            personal: { photo: '', firstName: '', lastName: '', title: '', email: '', countryCode: '+91', phone: '', city: '', sector: 'none' }, 
            summary: { content: '' }, experience: [{}], education: [{}], skills: { items: [{name:''}] }, languages: { items: [{name:'', level:'Fluent'}] }, certifications: [{}], passport: { number: '', expiry: '' }
        };

        let historyStack = []; let redoStack = []; let activeSection = 'personal'; let cropper; let debounceTimer;
        let sortableInstance = null;

        // --- CORE LOCALSTORAGE ENGINE ---
        function saveState() { 
            historyStack.push(JSON.stringify(resumeData)); 
            redoStack = []; 
            updateUndoRedoUI(); 
            
            // Secure Local Auto-Save
            try {
                localStorage.setItem('baba_studio_resume_data', JSON.stringify(resumeData));
            } catch(e) {
                console.warn('Local Storage is disabled or full. Autosave skipped.');
            }
        }

        function loadFromStorage() {
            try {
                const savedData = localStorage.getItem('baba_studio_resume_data');
                if (savedData) {
                    resumeData = JSON.parse(savedData);
                    showToast("Welcome back! Your previous session was restored.");
                    
                    // Update Dashboard CTA if data exists
                    document.querySelectorAll('.dash-start-btn').forEach(btn => {
                        btn.innerHTML = '<i class="fa-solid fa-play mr-2"></i> Resume Building';
                    });
                    return true;
                }
            } catch(e) {
                console.warn('Failed to load from local storage.');
            }
            return false;
        }

        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            document.getElementById('toast-message').innerText = message;
            toast.classList.remove('opacity-0', '-translate-y-full');
            toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', '-translate-y-full');
            }, 3500);
        }

        window.undo = () => { if (historyStack.length === 0) return; redoStack.push(JSON.stringify(resumeData)); resumeData = JSON.parse(historyStack.pop()); syncUI(); localStorage.setItem('baba_studio_resume_data', JSON.stringify(resumeData)); }
        window.redo = () => { if (redoStack.length === 0) return; historyStack.push(JSON.stringify(resumeData)); resumeData = JSON.parse(redoStack.pop()); syncUI(); localStorage.setItem('baba_studio_resume_data', JSON.stringify(resumeData)); }
        function updateUndoRedoUI() { const u = document.getElementById('undo-btn'); const r = document.getElementById('redo-btn'); if(u) u.disabled = historyStack.length === 0; if(r) r.disabled = redoStack.length === 0; }
        function syncUI() { renderSidebar(); renderForm(); renderPreview(); updateUndoRedoUI(); }

        const revealObserver = new IntersectionObserver((entries) => { entries.forEach(entry => { if(entry.isIntersecting) entry.target.classList.add('visible'); else entry.target.classList.remove('visible'); }); }, { threshold: 0.15 });

        // --- UTILITIES ---
        window.handleInput = (fn) => { fn(); clearTimeout(debounceTimer); debounceTimer = setTimeout(() => saveState(), 800); }
        window.applyAutoCaps = (el) => { 
            const s = el.selectionStart; const e = el.selectionEnd;
            el.value = el.value.replace(/(^\w|\s\w)/g, m => m.toUpperCase()); 
            el.setSelectionRange(s, e);
        };
        window.handleEnterNav = (e) => { if (e.key === 'Enter') { if (e.target.tagName === 'TEXTAREA' && !e.shiftKey) { e.preventDefault(); moveFocus(e.target); } else if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') { e.preventDefault(); moveFocus(e.target); } } };
        function moveFocus(current) {
            const inputs = Array.from(document.querySelectorAll('#form-container input, #form-container select, #form-container textarea'));
            const idx = inputs.indexOf(current);
            if (idx < inputs.length - 1) inputs[idx + 1].focus();
            else window.goToNextSection();
        }

        // --- MARKDOWN PARSER (BOLD TEXT) ---
        const parseMD = (str) => {
            if(!str) return '';
            return str
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em style="font-style:italic;">$1</em>');
        };

        // --- TEMPLATE VAULT ---
        window.insertSummaryTemplate = (type) => {
            if(SUMMARY_TEMPLATES[type]) {
                resumeData.summary.content = SUMMARY_TEMPLATES[type];
                renderForm();
                renderPreview();
                saveState();
            }
        };

        // --- QUICK ADD CHIPS ---
        window.addQuickItem = (section, val, defaultLevel = 'Professional') => {
            saveState();
            const sec = resumeData[section];
            let added = false;
            if(sec.items) {
                if(sec.items.length === 1 && !sec.items[0].name) {
                    sec.items[0].name = val;
                    if(section === 'languages') sec.items[0].level = defaultLevel;
                    added = true;
                } else {
                    if(!sec.items.find(i => i.name.toLowerCase() === val.toLowerCase())) {
                        if(section === 'languages') {
                            sec.items.push({name: val, level: defaultLevel});
                        } else {
                            sec.items.push({name: val});
                        }
                        added = true;
                    }
                }
            }
            if(added) {
                renderForm();
                renderPreview();
            }
        }

        // --- SMART EMAIL AUTOCOMPLETE ---
        window.handleEmailInput = function(el) {
            const val = el.value;
            const parent = el.parentNode;
            let list = parent.querySelector('.autocomplete-suggestions');
            
            if (val.includes('@') && !val.includes('.')) {
                if(!list) {
                    list = document.createElement('div');
                    list.className = 'autocomplete-suggestions';
                    parent.appendChild(list);
                }
                const domainPart = val.split('@')[1] || '';
                const domains = ['gmail.com', 'yahoo.com', 'yahoo.in', 'outlook.com', 'icloud.com', 'hotmail.com'];
                const matched = domains.filter(d => d.startsWith(domainPart));
                
                list.innerHTML = matched.map(d => `<div onclick="selectEmail('${val.split('@')[0]}@${d}', this)">${val.split('@')[0]}@<strong>${d}</strong></div>`).join('');
                list.style.display = matched.length ? 'block' : 'none';
            } else if (list) {
                list.style.display = 'none';
            }
            window.handleInput(() => { resumeData.personal.email = val; renderPreview(); });
        }

        window.selectEmail = (fullEmail, el) => {
            const input = el.parentNode.parentNode.querySelector('input');
            input.value = fullEmail;
            resumeData.personal.email = fullEmail;
            el.parentNode.style.display = 'none';
            renderPreview(); saveState();
        };

        // --- SMART TITLE AUTOCOMPLETE ---
        window.handleTitleInput = function(el) {
            const val = el.value.toLowerCase();
            const parent = el.parentNode;
            let list = parent.querySelector('.autocomplete-suggestions');
            if(!list) {
                list = document.createElement('div');
                list.className = 'autocomplete-suggestions';
                parent.appendChild(list);
            }
            if(val.length > 0) {
                const matched = JOB_TITLES.filter(t => t.toLowerCase().includes(val));
                list.innerHTML = matched.map(t => `<div onclick="selectTitle('${t}', this)">${t}</div>`).join('');
                list.style.display = matched.length ? 'block' : 'none';
            } else {
                list.style.display = 'none';
            }
            window.handleInput(() => { window.applyAutoCaps(el); resumeData.personal.title = el.value; renderPreview(); });
        }

        window.selectTitle = (title, el) => {
            const input = el.parentNode.parentNode.querySelector('input');
            input.value = title;
            resumeData.personal.title = title;
            el.parentNode.style.display = 'none';
            renderPreview(); saveState();
        };

        // --- FIELD REMOVAL (GRANULAR CONTROL) ---
        window.hideField = (btn, section, idx, field) => {
            if(idx !== null) { resumeData[section][idx][field] = ''; } 
            else { resumeData[section][field] = ''; }
            const wrapper = btn.closest('.field-wrapper');
            if(wrapper) wrapper.style.display = 'none';
            renderPreview(); saveState();
        }

        // --- PHONE MASKING ---
        window.handlePhoneInput = function(el) {
            let v = el.value.replace(/\D/g, '').substring(0, 10);
            el.value = v;
            window.handleInput(() => { resumeData.personal.phone = v; renderPreview(); });
        }

        window.openCustomSectionModal = () => { document.getElementById('modal-overlay').style.display = 'flex'; document.getElementById('modal-input').focus(); };
        window.closeModal = () => { document.getElementById('modal-overlay').style.display = 'none'; document.getElementById('modal-input').value = ''; };
        
        window.confirmAddSection = () => {
            const t = document.getElementById('modal-input').value;
            if(t.trim()) { saveState(); const id = 'c' + Date.now(); resumeData[id] = { type: 'custom', title: t, items: [{ fields: [{label: 'Title', value: ''}, {label: 'Dates', value: ''}, {label: 'Details', value: ''}] }] }; resumeData.order.push(id); resumeData.visibility[id] = true; setActiveSection(id); closeModal(); renderPreview(); }
        };
        window.removeSection = (id) => { if(id === 'personal') return; saveState(); resumeData.order = resumeData.order.filter(k => k !== id); delete resumeData[id]; setActiveSection('personal'); renderPreview(); };
        
        function forceSwitchToEditor() {
            document.querySelectorAll('.view-section').forEach(e => {
                e.classList.remove('view-active');
                e.classList.add('hidden');
            });
            const editor = document.getElementById('view-editor');
            editor.classList.remove('hidden'); 
            editor.classList.add('view-active');
        }

        window.startNewResume = function() { 
            activeSection = 'personal'; 
            forceSwitchToEditor(); 
            renderForm();
            renderSidebar();
            renderPreview(); 
            setTimeout(() => { renderBrandList(); renderTemplateList(); renderTypographySettings(); }, 50);
        }
        
        window.goToDashboard = () => {
            document.querySelectorAll('.view-section').forEach(e => { e.classList.remove('view-active'); e.classList.add('hidden'); });
            const dash = document.getElementById('view-dashboard');
            dash.classList.remove('hidden'); dash.classList.add('view-active');
        };
        
        window.togglePreview = function(forceDesign) {
            const p = document.getElementById('right-preview'); const isOpen = !p.classList.contains('translate-x-full');
            if(isOpen) { 
                p.classList.add('translate-x-full'); 
                document.getElementById('preview-btn-text').innerText = "Preview & Style"; 
                window.switchSidebarTab('content'); 
            } else { 
                p.classList.remove('translate-x-full'); 
                document.getElementById('preview-btn-text').innerText = "Hide Preview"; 
                if(forceDesign) { 
                    window.switchSidebarTab('design'); 
                    setTimeout(() => { renderOrderList(); renderBrandList(); renderTemplateList(); renderTypographySettings(); }, 50); 
                } 
                renderPreview(); setTimeout(scalePreview, 310); 
            }
        }
        
        function scalePreview() { const container = document.getElementById('resume-preview'); const viewport = document.getElementById('preview-viewport'); if(!container || !viewport) return; const scale = Math.min(1, (viewport.clientWidth - 80) / 794); container.style.transform = `scale(${scale})`; }

        window.handlePhoto = (e) => { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (event) => { const img = document.getElementById('crop-image'); img.src = event.target.result; document.getElementById('crop-modal').style.display = 'flex'; if(cropper) cropper.destroy(); cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 }); }; reader.readAsDataURL(file); };
        window.closeCropModal = () => { document.getElementById('crop-modal').style.display = 'none'; if(cropper) cropper.destroy(); };
        window.finalizeCrop = () => { if(!cropper) return; saveState(); const canvas = cropper.getCroppedCanvas({ width: 400, height: 400 }); resumeData.personal.photo = canvas.toDataURL(); renderForm(); renderPreview(); closeCropModal(); };

        window.addItem = (s) => { saveState(); const sec = resumeData[s]; if(s === 'experience' || s === 'education' || s === 'certifications') sec.push({}); else if(sec.items) { if(sec.type === 'custom') { const f = JSON.parse(JSON.stringify(sec.items[0].fields)).map(v => ({...v, value: ''})); sec.items.push({fields: f}); } else { sec.items.push({name:''}); } } renderForm(); renderPreview(); }
        window.delItem = (s,i) => { saveState(); (Array.isArray(resumeData[s]) ? resumeData[s] : resumeData[s].items).splice(i,1); renderForm(); renderPreview(); }
        
        window.updateSetting = (k, v, extra) => { 
            saveState(); 
            resumeData.settings[k] = v; 
            if(k === 'color' && extra) {
                resumeData.settings.gradient = extra;
                document.documentElement.style.setProperty('--accent-color', v);
                document.documentElement.style.setProperty('--accent-gradient', extra);
            }
            renderPreview(); 
            if(k==='template') renderTemplateList(); 
            if(k==='fontFamily' || k==='headingWeight') renderTypographySettings();
        }

        window.adjustFontSize = (key, delta) => {
            saveState();
            resumeData.settings[key] = (parseFloat(resumeData.settings[key]) || (key==='bodySize'?9.5:24)) + delta;
            renderPreview();
        };

        window.switchSidebarTab = (t) => { 
            const c = document.getElementById('sidebar-content'); 
            const d = document.getElementById('sidebar-design'); 
            if (c && d) { 
                c.classList.toggle('hidden', t !== 'content'); 
                d.classList.toggle('hidden', t !== 'design'); 
                
                const tabC = document.getElementById('tab-content');
                const tabD = document.getElementById('tab-design');
                
                if (t === 'content') {
                    tabC.classList.add('ios-tab-active'); tabC.classList.remove('ios-tab-inactive');
                    tabD.classList.add('ios-tab-inactive'); tabD.classList.remove('ios-tab-active');
                } else {
                    tabD.classList.add('ios-tab-active'); tabD.classList.remove('ios-tab-inactive');
                    tabC.classList.add('ios-tab-inactive'); tabC.classList.remove('ios-tab-active');
                }
            } 
        }

        window.goToNextSection = () => { const idx = resumeData.order.indexOf(activeSection); if(idx < resumeData.order.length-1) setActiveSection(resumeData.order[idx+1]); else window.togglePreview(true); }
        window.goToPrevSection = () => { const idx = resumeData.order.indexOf(activeSection); if(idx > 0) setActiveSection(resumeData.order[idx-1]); }
        
        function setActiveSection(k) { 
            activeSection=k; 
            renderSidebar(); 
            renderForm(); 
            const panel = document.getElementById('editor-panel');
            if(panel) panel.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function renderSidebar() { 
            const list = document.getElementById('section-list'); 
            if(!list) return; 
            list.innerHTML = ''; 
            resumeData.order.forEach(key => { 
                const label = resumeData[key]?.type === 'custom' ? resumeData[key].title : key; 
                const isActive = activeSection === key; 
                
                // Pure Tailwind classes for robust layout that won't break in different browser states
                const activeClasses = "bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg shadow-blue-500/30 scale-[1.02] border-transparent";
                const inactiveClasses = "bg-white/50 text-slate-600 hover:bg-white border-transparent hover:border-slate-200 hover:shadow-sm";
                
                list.innerHTML += `
                <div class="flex items-center gap-2 mb-2 w-full">
                    <button onclick="setActiveSection('${key}')" class="flex-1 text-left px-5 py-3.5 rounded-2xl text-[11px] font-black uppercase tracking-widest transition-all duration-300 border ${isActive ? activeClasses : inactiveClasses}">
                        ${label}
                    </button>
                    ${key !== 'personal' ? `
                    <button onclick="window.removeSection('${key}')" class="flex-shrink-0 w-11 h-11 flex items-center justify-center rounded-xl bg-white/50 text-slate-400 hover:bg-red-50 hover:text-red-500 transition-colors border border-transparent hover:border-red-100 shadow-sm">
                        <i class="fa-solid fa-trash-can text-sm"></i>
                    </button>
                    ` : '<div class="w-11 h-11 flex-shrink-0"></div>'} 
                </div>`; 
            }); 
        }
        
        function renderForm() {
            const c = document.getElementById('form-container'); if(!c) return;
            const d = resumeData[activeSection]; const friendly = SECTION_LABELS[activeSection] || d.title;
            let h = `<h2 class="text-4xl font-black tracking-tighter text-slate-800 uppercase leading-[0.9] text-center mb-8 drop-shadow-sm">${friendly}</h2>`;
            if(activeSection === 'personal') {
                h += `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 text-slate-800">
                    <div class="col-span-full flex items-center gap-6 p-6 bg-white/60 backdrop-blur-md rounded-[24px] border border-white shadow-sm"><div class="photo-preview-container shadow-sm">${d.photo ? `<img src="${d.photo}" style="width:100%; height:100%; object-fit:cover;">` : `<i class="fa-solid fa-user-tie text-2xl text-slate-300"></i>`}</div><div class="flex-1"><label class="input-label">Identity Photo</label><button onclick="document.getElementById('file-upload').click()" class="upload-btn">Upload Profile Photo</button><input id="file-upload" type="file" accept="image/*" onchange="handlePhoto(event)" class="hidden"></div></div>
                    <div class="field-wrapper group"><label class="input-label">First Name <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, 'personal', null, 'firstName')"></i></label><input class="ios-input" value="${d.firstName||''}" oninput="window.handleInput(() => { window.applyAutoCaps(event.target); resumeData.personal.firstName=event.target.value; renderPreview(); })"></div>
                    <div class="field-wrapper group"><label class="input-label">Last Name <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, 'personal', null, 'lastName')"></i></label><input class="ios-input" value="${d.lastName||''}" oninput="window.handleInput(() => { window.applyAutoCaps(event.target); resumeData.personal.lastName=event.target.value; renderPreview(); })"></div>
                    <div class="col-span-full field-wrapper group relative"><label class="input-label">Target Title <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, 'personal', null, 'title')"></i></label><input class="ios-input" value="${d.title||''}" oninput="window.handleTitleInput(event.target)"></div>
                    <div class="relative field-wrapper group"><label class="input-label">Email <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, 'personal', null, 'email')"></i></label><input class="ios-input" value="${d.email||''}" oninput="window.handleEmailInput(event.target)"></div>
                    <div class="flex gap-3 field-wrapper group"><div><label class="input-label">Code</label><select class="ios-input w-24 px-2 text-center" onchange="window.handleInput(() => { resumeData.personal.countryCode=event.target.value; renderPreview(); })">${COUNTRY_CODES.map(cc=>`<option value="${cc.code}" ${d.countryCode===cc.code?'selected':''}>${cc.code}</option>`).join('')}</select></div><div class="flex-1"><label class="input-label">Phone <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, 'personal', null, 'phone')"></i></label><input class="ios-input" value="${d.phone||''}" placeholder="10-digit number" maxlength="10" oninput="window.handlePhoneInput(event.target)"></div></div>
                </div>`;
            } else if (activeSection === 'summary') {
                h += `<div class="mt-4 p-8 bg-white/60 backdrop-blur-md rounded-[32px] border border-white shadow-sm transition-all">
                    <div class="flex justify-between items-end mb-4">
                        <label class="input-label mb-0">Professional Summary</label>
                        <select class="ios-input py-1 px-2 text-[10px] w-auto bg-white/80 font-bold uppercase tracking-widest text-blue-600 cursor-pointer hover:bg-white" onchange="if(this.value) window.insertSummaryTemplate(this.value); this.value='';">
                            <option value="">+ Template Vault</option>
                            ${Object.keys(SUMMARY_TEMPLATES).map(k => `<option value="${k}">${k}</option>`).join('')}
                        </select>
                    </div>
                    <textarea class="ios-input h-64 resize-none shadow-inner" placeholder="E.g., Senior Operations Manager with 10+ years driving cross-functional team productivity..." oninput="window.handleInput(() => { resumeData.summary.content=event.target.value; renderPreview(); })">${d.content||''}</textarea><p class="text-[9px] text-slate-500 font-medium mt-3"><i class="fa-solid fa-circle-info mr-1"></i> Tip: Surround text with **asterisks** to make it **bold**.</p></div>`;
            } else if (activeSection === 'experience' || activeSection === 'education') {
                h += `<button onclick="window.removeSection('${activeSection}')" class="w-full py-3 mb-6 bg-white/40 text-red-500 rounded-xl font-bold uppercase text-[10px] tracking-widest hover:bg-white transition-all border border-white shadow-sm">Remove Entire Section</button>`;
                d.forEach((item, idx) => {
                    h += `<div class="bg-white/60 backdrop-blur-md p-8 rounded-[32px] relative mt-8 border border-white shadow-sm"><button onclick="delItem('${activeSection}',${idx})" class="absolute top-6 right-6 w-10 h-10 rounded-full bg-white text-slate-400 hover:text-red-500 shadow-sm border-none active:scale-90 transition-colors"><i class="fa-solid fa-trash"></i></button><div class="grid grid-cols-2 gap-5">`;
                    if(activeSection==='experience') h+=`<div class="col-span-2 field-wrapper group"><label class="input-label">Organization <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, '${activeSection}', ${idx}, 'company')"></i></label><input class="ios-input" value="${item.company||''}" oninput="window.handleInput(() => { window.applyAutoCaps(event.target); resumeData.experience[${idx}].company=event.target.value; renderPreview(); })"></div><div class="col-span-2 field-wrapper group"><label class="input-label">Role <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, '${activeSection}', ${idx}, 'title')"></i></label><input class="ios-input" value="${item.title||''}" oninput="window.handleInput(() => { window.applyAutoCaps(event.target); resumeData.experience[${idx}].title=event.target.value; renderPreview(); })"></div>`;
                    else h+=`<div class="col-span-2 field-wrapper group"><label class="input-label">School/University <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, '${activeSection}', ${idx}, 'school')"></i></label><input class="ios-input" value="${item.school||''}" oninput="window.handleInput(() => { window.applyAutoCaps(event.target); resumeData.education[${idx}].school=event.target.value; renderPreview(); })"></div><div class="col-span-2 field-wrapper group"><label class="input-label">Degree <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, '${activeSection}', ${idx}, 'degree')"></i></label><input class="ios-input" value="${item.degree||''}" oninput="window.handleInput(() => { window.applyAutoCaps(event.target); resumeData.education[${idx}].degree=event.target.value; renderPreview(); })"></div>`;
                    h+=`<div class="field-wrapper group"><label class="input-label">Start Date <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, '${activeSection}', ${idx}, 'start')"></i></label><input type="date" class="ios-input" value="${item.start||''}" oninput="window.handleInput(() => { resumeData.${activeSection}[${idx}].start=event.target.value; renderPreview(); })"></div><div class="field-wrapper group"><label class="input-label">End Date <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, '${activeSection}', ${idx}, 'end')"></i></label><input type="date" class="ios-input" value="${item.end||''}" oninput="window.handleInput(() => { resumeData.${activeSection}[${idx}].end=event.target.value; renderPreview(); })"></div><div class="col-span-2 field-wrapper group"><label class="input-label">Details <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, '${activeSection}', ${idx}, 'description')"></i></label><textarea class="ios-input h-24" oninput="window.handleInput(() => { resumeData.${activeSection}[${idx}].description=event.target.value; renderPreview(); })">${item.description||''}</textarea><p class="text-[9px] text-slate-500 font-medium mt-2"><i class="fa-solid fa-circle-info mr-1"></i> Tip: Surround text with **asterisks** to make it **bold**.</p></div></div></div>`;
                });
                h += `<button onclick="addItem('${activeSection}')" class="w-full py-5 bg-white border border-white text-slate-600 rounded-[20px] font-bold uppercase text-[10px] mt-6 hover:border-blue-400 hover:text-blue-600 shadow-sm transition-all">+ Add Entry</button>`;
            } else if (activeSection === 'certifications') {
                h += `<button onclick="window.removeSection('${activeSection}')" class="w-full py-3 mb-6 bg-white/40 text-red-500 rounded-xl font-bold uppercase text-[10px] tracking-widest hover:bg-white transition-all border border-white shadow-sm">Remove Entire Section</button>`;
                d.forEach((item, idx) => {
                    h += `<div class="bg-white/60 backdrop-blur-md p-8 rounded-[32px] relative mt-8 border border-white shadow-sm"><button onclick="delItem('${activeSection}',${idx})" class="absolute top-6 right-6 w-10 h-10 rounded-full bg-white text-slate-400 hover:text-red-500 shadow-sm border-none active:scale-90 transition-colors"><i class="fa-solid fa-trash"></i></button><div class="grid grid-cols-2 gap-5">`;
                    h+=`<div class="col-span-2 field-wrapper group"><label class="input-label">Credential Name <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, '${activeSection}', ${idx}, 'name')"></i></label><input class="ios-input" value="${item.name||''}" oninput="window.handleInput(() => { window.applyAutoCaps(event.target); resumeData.certifications[${idx}].name=event.target.value; renderPreview(); })"></div>`;
                    h+=`<div class="col-span-2 field-wrapper group"><label class="input-label">Date / Year <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, '${activeSection}', ${idx}, 'date')"></i></label><input type="text" class="ios-input" placeholder="e.g. 2023" value="${item.date||''}" oninput="window.handleInput(() => { resumeData.certifications[${idx}].date=event.target.value; renderPreview(); })"></div><div class="col-span-2 field-wrapper group"><label class="input-label">Details <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, '${activeSection}', ${idx}, 'description')"></i></label><textarea class="ios-input h-24" oninput="window.handleInput(() => { resumeData.certifications[${idx}].description=event.target.value; renderPreview(); })">${item.description||''}</textarea><p class="text-[9px] text-slate-500 font-medium mt-2"><i class="fa-solid fa-circle-info mr-1"></i> Tip: Surround text with **asterisks** to make it **bold**.</p></div></div></div>`;
                });
                h += `<button onclick="addItem('${activeSection}')" class="w-full py-5 bg-white border border-white text-slate-600 rounded-[20px] font-bold uppercase text-[10px] mt-6 hover:border-blue-400 hover:text-blue-600 shadow-sm transition-all">+ Add Entry</button>`;
            } else if (activeSection === 'languages') {
                d.items.forEach((item, idx) => { h += `<div class="flex gap-4 items-end mt-4 text-slate-800"><div class="flex-1 field-wrapper group"><label class="input-label">Language</label><input class="ios-input" value="${item.name||''}" oninput="window.handleInput(() => { window.applyAutoCaps(event.target); resumeData.languages.items[${idx}].name=event.target.value; renderPreview(); })"></div><div class="w-48 field-wrapper"><label class="input-label">Level</label><select class="ios-input bg-white" onchange="window.handleInput(() => { resumeData.languages.items[${idx}].level=event.target.value; renderPreview(); saveState(); })">${LANG_LEVELS.map(l => `<option value="${l}" ${item.level===l?'selected':''}>${l}</option>`).join('')}</select></div><button onclick="delItem('languages',${idx})" class="w-12 h-12 rounded-xl bg-white shadow-sm hover:bg-red-50 text-slate-400 hover:text-red-500 transition-colors border border-slate-100"><i class="fa-solid fa-trash"></i></button></div>`; });
                h += `<button onclick="addItem('languages')" class="w-full py-5 bg-white border border-white text-slate-600 rounded-[20px] font-bold uppercase text-[10px] mt-6 shadow-sm hover:border-blue-400 hover:text-blue-600 transition-all">+ Add Language</button>`;
                h += `<div class="mt-5"><p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-3">Quick Add Languages:</p><div class="flex flex-wrap gap-2">${QUICK_LANGUAGES.map(l => `<button onclick="window.addQuickItem('languages', '${l}', 'Fluent')" class="px-3 py-1.5 bg-white border border-slate-200 rounded-lg text-[10px] font-bold text-slate-500 hover:text-blue-600 hover:border-blue-200 transition-colors shadow-sm">+ ${l}</button>`).join('')}</div></div>`;
            } else if (activeSection === 'passport') {
                h += `<div class="grid grid-cols-2 gap-6 mt-6 text-slate-800 p-8 bg-white/60 backdrop-blur-md rounded-[32px] border border-white shadow-sm"><div class="field-wrapper group"><label class="input-label">Passport Number <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, 'passport', null, 'number')"></i></label><input class="ios-input uppercase" value="${d.number||''}" oninput="window.handleInput(() => { resumeData.passport.number=event.target.value; renderPreview(); })"></div><div class="field-wrapper group"><label class="input-label">Expiry Date <i class="fa-solid fa-xmark cursor-pointer opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity" onclick="hideField(this, 'passport', null, 'expiry')"></i></label><input type="date" class="ios-input" value="${d.expiry||''}" oninput="window.handleInput(() => { resumeData.passport.expiry=event.target.value; renderPreview(); })"></div></div>`;
            } else {
                d.items.forEach((item, idx) => { h += `<div class="flex gap-4 items-end mt-4 text-slate-800"><div class="flex-1 field-wrapper group"><label class="input-label">Competency</label><input class="ios-input" value="${item.name||''}" oninput="window.handleInput(() => { window.applyAutoCaps(event.target); resumeData['${activeSection}'].items[${idx}].name=event.target.value; renderPreview(); })"></div><button onclick="delItem('${activeSection}',${idx})" class="w-12 h-12 rounded-xl bg-white shadow-sm hover:bg-red-50 text-slate-400 hover:text-red-500 border border-slate-100 transition-colors"><i class="fa-solid fa-trash"></i></button></div>`; });
                h += `<button onclick="addItem('${activeSection}')" class="w-full py-5 bg-white border border-white text-slate-600 shadow-sm rounded-[20px] font-bold uppercase text-[10px] mt-6 hover:border-blue-400 hover:text-blue-600 transition-all">+ Add Entry</button>`;
                h += `<div class="mt-5"><p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-3">Quick Add Skills:</p><div class="flex flex-wrap gap-2">${QUICK_SKILLS.map(s => `<button onclick="window.addQuickItem('${activeSection}', '${s}')" class="px-3 py-1.5 bg-white border border-slate-200 rounded-lg text-[10px] font-bold text-slate-500 hover:text-blue-600 hover:border-blue-200 transition-colors shadow-sm">+ ${s}</button>`).join('')}</div></div>`;
            }
            c.innerHTML = h;
        }

        function renderTypographySettings() {
            const container = document.getElementById('typography-container');
            if(!container) return;
            const d = resumeData.settings;
            container.innerHTML = `
                <h4 class="input-label font-black text-slate-900">Typography</h4>
                <div class="space-y-4 mb-8">
                    <div>
                        <p class="text-[9px] text-slate-500 mb-1.5 tracking-widest uppercase">Font Family</p>
                        <select class="ios-input py-2.5 text-xs bg-white/60" onchange="window.updateSetting('fontFamily', this.value)">
                            <option value="'Inter', sans-serif" ${d.fontFamily === "'Inter', sans-serif" ? 'selected' : ''}>Inter (Clean)</option>
                            <option value="'Merriweather', serif" ${d.fontFamily === "'Merriweather', serif" ? 'selected' : ''}>Merriweather (Serif)</option>
                            <option value="'Poppins', sans-serif" ${d.fontFamily === "'Poppins', sans-serif" ? 'selected' : ''}>Poppins (Modern)</option>
                            <option value="'Roboto Mono', monospace" ${d.fontFamily === "'Roboto Mono', monospace" ? 'selected' : ''}>Roboto Mono (Tech)</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <p class="text-[9px] text-slate-500 mb-1.5 tracking-widest uppercase">Name Size</p>
                            <div class="flex bg-white/60 rounded-xl border border-white shadow-sm overflow-hidden">
                                <button class="flex-1 py-1.5 text-slate-600 hover:bg-white font-bold" onclick="window.adjustFontSize('titleSize', -2)">-</button>
                                <button class="flex-1 py-1.5 text-slate-600 hover:bg-white border-l border-white font-bold" onclick="window.adjustFontSize('titleSize', 2)">+</button>
                            </div>
                        </div>
                        <div>
                            <p class="text-[9px] text-slate-500 mb-1.5 tracking-widest uppercase">Body Size</p>
                            <div class="flex bg-white/60 rounded-xl border border-white shadow-sm overflow-hidden">
                                <button class="flex-1 py-1.5 text-slate-600 hover:bg-white font-bold" onclick="window.adjustFontSize('bodySize', -0.5)">-</button>
                                <button class="flex-1 py-1.5 text-slate-600 hover:bg-white border-l border-white font-bold" onclick="window.adjustFontSize('bodySize', 0.5)">+</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <p class="text-[9px] text-slate-500 mb-1.5 tracking-widest uppercase">Heading Weight</p>
                        <div class="flex gap-2">
                            <button class="flex-1 py-2 text-[10px] uppercase font-bold rounded-xl border border-white shadow-sm ${d.headingWeight==='500'?'bg-blue-50 text-blue-600 border-blue-200':'bg-white/60 text-slate-600 hover:bg-white'} transition-colors" onclick="window.updateSetting('headingWeight', '500')">Norm</button>
                            <button class="flex-1 py-2 text-[10px] uppercase font-bold rounded-xl border border-white shadow-sm ${d.headingWeight==='700'?'bg-blue-50 text-blue-600 border-blue-200':'bg-white/60 text-slate-600 hover:bg-white'} transition-colors" onclick="window.updateSetting('headingWeight', '700')">Bold</button>
                            <button class="flex-1 py-2 text-[10px] uppercase font-bold rounded-xl border border-white shadow-sm ${d.headingWeight==='900'?'bg-blue-50 text-blue-600 border-blue-200':'bg-white/60 text-slate-600 hover:bg-white'} transition-colors" onclick="window.updateSetting('headingWeight', '900')">Heavy</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTemplateList() {
            const list = document.getElementById('template-grid'); if(!list) return;
            list.innerHTML = TEMPLATES.map(t => `<div onclick="window.updateSetting('template','${t.id}')" class="design-card ${resumeData.settings.template===t.id?'design-card-active':''}"><div class="font-black text-[10px] uppercase text-slate-800">${t.name}</div><div class="text-[8px] text-slate-500 mt-1 uppercase tracking-widest">${t.desc}</div></div>`).join('');
        }
        function renderBrandList() {
            const list = document.getElementById('brand-grid'); if(!list) return;
            list.innerHTML = SECTORS.map(s => `<div onclick="window.handleInput(()=>{resumeData.personal.sector='${s.id}'; renderPreview(); renderBrandList();})" class="design-card flex items-center gap-2 ${resumeData.personal.sector===s.id?'design-card-active':''}"><i class="fa-solid ${s.icon||'fa-ban'} text-sm" style="color:${resumeData.personal.sector===s.id?resumeData.settings.color:'rgba(0,0,0,0.2)'}"></i><span class="text-[9px] font-bold uppercase text-slate-700">${s.name}</span></div>`).join('');
        }

        function renderOrderList() {
            const list = document.getElementById('order-list'); if(!list) return; list.innerHTML = '';
            resumeData.order.forEach(k => {
                if(k === 'personal') return; const label = resumeData[k]?.type === 'custom' ? resumeData[k].title : k; const isHidden = !resumeData.visibility[k];
                list.innerHTML += `<div data-id="${k}" class="bg-white/70 p-3 rounded-xl flex items-center justify-between shadow-sm cursor-move border border-white text-slate-700 hover:bg-white transition-colors"><div class="flex items-center gap-3"><i class="fa-solid fa-grip-vertical text-slate-300"></i><span class="text-[10px] font-bold uppercase tracking-widest ${isHidden?'opacity-30 line-through':''}">${label}</span></div><button onclick="toggleVisibility('${k}')" class="w-7 h-7 rounded-full bg-white flex items-center justify-center text-slate-500 border border-slate-100 shadow-sm focus:outline-none transition-colors"><i class="fa-solid ${isHidden?'fa-eye-slash text-slate-300':'fa-eye text-teal-600'} text-xs"></i></button></div>`;
            });
            
            if (sortableInstance) { sortableInstance.destroy(); }
            sortableInstance = new Sortable(list, { animation: 150, onEnd: () => { saveState(); resumeData.order = ['personal', ...Array.from(list.children).map(el => el.getAttribute('data-id'))]; renderPreview(); renderSidebar(); }});
        }
        window.toggleVisibility = (k) => { saveState(); resumeData.visibility[k] = !resumeData.visibility[k]; renderOrderList(); renderPreview(); }

        function renderPreview() {
            const p = document.getElementById('resume-preview'); if(!p) return;
            const d = resumeData; const t = d.settings.template;
            p.className = `page-container resume-content tpl-${t}`;
            
            p.style.setProperty('--font-family', d.settings.fontFamily || "'Inter', sans-serif");
            p.style.setProperty('--accent-color', d.settings.color);
            p.style.setProperty('--accent-gradient', d.settings.gradient || `linear-gradient(135deg, ${d.settings.color} 0%, #1E293B 100%)`);
            p.style.setProperty('--title-size', (d.settings.titleSize || 24) + 'pt');
            p.style.setProperty('--body-size', (d.settings.bodySize || 9.5) + 'pt');
            p.style.setProperty('--heading-weight', d.settings.headingWeight || '900');
            
            const fD = (s) => { if(!s) return ''; const dt = new Date(s); return dt.toLocaleDateString('en-US', {month:'short', year:'numeric'}); };

            const renderSec = (k) => {
                if(!d.visibility[k] || k==='personal') return ''; const sec = d[k]; let iH = '';
                if(t==='audit' && k==='summary') return ''; 
                if(k==='summary' && sec.content) iH = `<p class="font-medium leading-relaxed whitespace-pre-wrap text-slate-800" style="font-size: var(--body-size);">${parseMD(sec.content)}</p>`;
                else if(Array.isArray(sec)) {
                    iH = sec.map(i => {
                        let dateStr = '';
                        if(k === 'certifications') { dateStr = i.date || ''; }
                        else {
                            if(i.start) dateStr += fD(i.start);
                            if(i.end) dateStr += '  ' + fD(i.end);
                            else if(i.start) dateStr += '  Present';
                        }
                        if(!i.title && !i.degree && !i.name && !i.school && !i.company && !dateStr && !i.description) return '';
                        
                        return `<div class="${t==='clinical' || t==='case'?'entry-box':''} mb-4 text-slate-800"><div class="flex justify-between font-bold" style="font-size: calc(var(--body-size) + 0.5pt);"><span>${i.title || i.degree || i.name || i.school || ''}</span><span class="date-badge">${dateStr}</span></div><p class="font-bold opacity-70 text-slate-700" style="font-size: var(--body-size);">${i.company || i.school || ''}</p><p class="leading-snug whitespace-pre-wrap mt-2 text-slate-600 opacity-90" style="font-size: var(--body-size);">${parseMD(i.description)}</p></div>`;
                    }).join('');
                }
                else if(k==='languages') iH = `<div class="grid grid-cols-1 gap-y-2 text-slate-800">${sec.items.map(i => `<div class="font-medium text-slate-800" style="font-size: var(--body-size);"> ${i.name} <span class="opacity-40 italic">(${i.level})</span></div>`).join('')}</div>`;
                else if(k==='passport') { if(sec.number || sec.expiry) iH = `<p class="text-slate-800" style="font-size: var(--body-size);">Passport: <strong>${sec.number}</strong>  Expiry: <strong>${fD(sec.expiry)}</strong></p>`; }
                else if(sec.items) {
                    iH = `<div class="${t==='matrix' && k==='skills' ? 'skills-grid' : 'flex flex-wrap gap-2'} text-slate-800">${sec.items.map(i => `<span class="${t==='clinical'?'skill-tag':'skill-pill'}" style="font-size: calc(var(--body-size) - 1pt);">${i.name}</span>`).join('')}</div>`;
                }
                if(!iH || iH.trim() === '') return ''; return `<div class="resume-section"><h2 style="background:var(--accent-gradient); color:#fff; padding:6px 14px; border-radius:6px; letter-spacing:0.1em; display:inline-block; font-size:calc(var(--body-size) + 1.5pt); font-weight:var(--heading-weight);">${SECTION_LABELS[k] || sec.title || k}</h2>${iH}</div>`;
            };

            let masterOrder = [...d.order];

            const sectorIcon = SECTORS.find(s=>s.id===d.personal.sector)?.icon;
            let logoHtml = '';
            
            if(sectorIcon && d.personal.sector !== 'none' && t !== 'modern') {
                logoHtml = `<div id="draggable-logo" class="brand-logo-fixed" style="color:var(--accent-color); left:${d.settings.logoLeft||'80%'}; top:${d.settings.logoTop||'5%'}; cursor:move;"><i class="fa-solid ${sectorIcon}"></i></div>`;
            }

            if(t==='clinical') {
                const sidebarKeys = masterOrder.filter(k => ['skills', 'languages', 'passport'].includes(k));
                const s = sidebarKeys.map(k => renderSec(k)).join('');
                const m = masterOrder.filter(k => !['personal', 'skills', 'languages', 'passport'].includes(k)).map(k => renderSec(k)).join('');
                p.innerHTML = logoHtml + `<div class="tpl-clinical" style="display: grid; grid-template-columns: 220px 1fr; min-height: 297mm; height: 100%;">
                    <div class="sidebar-col" style="background:var(--accent-gradient); color:#fff; padding: 35px 20px;">
                        <div class="flex flex-col items-center text-center mb-8 text-white">
                            <div style="width:90px; height:90px; border-radius:50%; overflow:hidden; border:4px solid rgba(255,255,255,0.2); margin-bottom:15px; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.1);">
                                ${d.personal.photo ? `<img src="${d.personal.photo}" style="width:100%; height:100%; object-fit:cover;">`: `<i class="fa-solid fa-user-tie text-3xl opacity-50 text-white"></i>`}
                            </div>
                            <h1 class="font-black mt-2 text-white leading-tight uppercase" style="font-size: calc(var(--title-size) * 0.7);">${d.personal.firstName} <br> ${d.personal.lastName}</h1>
                            <p class="font-bold opacity-80 uppercase tracking-widest text-white mt-2" style="font-size: calc(var(--body-size) - 1.5pt);">${d.personal.title}</p>
                            <p class="mt-4 opacity-80 text-center text-white" style="font-size: calc(var(--body-size) - 2pt);">${d.personal.email}<br>${d.personal.phone}</p>
                        </div>
                        ${s}
                    </div>
                    <div class="main-col" style="padding: 35px 25px; background:#fff;">
                        ${m}
                    </div>
                </div>`;
            } else if(t==='modern') {
                p.innerHTML = `<div class="tpl-modern text-slate-800" style="width: 100%;">
                    <div class="header-banner" style="background:var(--accent-gradient); color:#fff; padding: 40px; width: 100%; box-sizing: border-box;">
                        <div class="flex justify-between items-center w-full">
                            <div>
                                <h1 class="font-black uppercase" style="color:#fff; font-size: var(--title-size);">${d.personal.firstName} ${d.personal.lastName}</h1>
                                <p class="font-bold opacity-90 mt-1" style="color:#fff; font-size: calc(var(--body-size) + 2pt);">${d.personal.title}</p>
                                <p class="mt-3 opacity-80" style="color:#fff; font-weight: 500; font-size: var(--body-size);">${d.personal.email}  ${d.personal.countryCode} ${d.personal.phone}</p>
                            </div>
                            ${sectorIcon && d.personal.sector !== 'none' ? `<div class="brand-logo-container" style="background:rgba(255,255,255,0.1); padding: 15px; border-radius:12px; color:#fff; font-size:32pt;"><i class="fa-solid ${sectorIcon}"></i></div>` : ''}
                        </div>
                    </div>
                    <div style="padding: 0 40px 40px 40px;">
                        ${masterOrder.filter(k=>k!=='personal').map(k=>renderSec(k)).join('')}
                    </div>
                </div>`;
            } else if(t==='classic') {
                p.innerHTML = logoHtml + `<div class="p-14 text-slate-900" style="padding: 50px;">
                    <h1 class="font-serif font-black text-center mb-2" style="color:var(--accent-color); font-size: calc(var(--title-size) * 1.2);">${d.personal.firstName} ${d.personal.lastName}</h1>
                    <div class="font-medium text-center uppercase tracking-widest opacity-60 mb-10 border-b-2 border-slate-200 pb-8" style="font-size: var(--body-size);">${d.personal.title} <br> ${d.personal.email}  ${d.personal.countryCode} ${d.personal.phone}</div>
                    ${masterOrder.filter(k=>k!=='personal').map(k=>renderSec(k)).join('')}
                </div>`;
            } else {
                p.innerHTML = logoHtml + `<div class="p-14 text-slate-800" style="padding: 40px;">
                    <div class="flex gap-10 items-center mb-10 border-b-2 border-slate-200 pb-8">
                        <div class="flex-1">
                            <h1 class="font-black uppercase" style="color:var(--accent-color); font-size: var(--title-size);">${d.personal.firstName} ${d.personal.lastName}</h1>
                            <p class="font-bold opacity-70 mt-1" style="font-size: calc(var(--body-size) + 2pt);">${d.personal.title}</p>
                            <p class="mt-3 opacity-70" style="font-size: var(--body-size);">${d.personal.email}  ${d.personal.countryCode} ${d.personal.phone}</p>
                        </div>
                        ${d.personal.photo ? `<img src="${d.personal.photo}" style="width:60pt; height:60pt; border-radius:50%; object-fit:cover; border:3px solid #F1F5F9;">` : ''}
                    </div>
                    ${masterOrder.filter(k=>k!=='personal').map(k=>renderSec(k)).join('')}
                </div>`;
            }
            
            initLogoDrag();
        }
        
        function initLogoDrag() {
            setTimeout(() => {
                const logo = document.getElementById('draggable-logo');
                const container = document.querySelector('.page-container');
                if(!logo || !container) return;

                let isDragging = false;
                let startX, startY, initialLeft, initialTop;

                logo.onmousedown = function(e) {
                    isDragging = true;
                    startX = e.clientX; startY = e.clientY;
                    initialLeft = logo.offsetLeft; initialTop = logo.offsetTop;
                    document.onmousemove = dragLogo;
                    document.onmouseup = stopDragLogo;
                    e.preventDefault();
                };

                function dragLogo(e) {
                    if(!isemakersDragging) return;
                    const rect = container.getBoundingClientRect();
                    let dx = e.clientX - startX;
                    let dy = e.clientY - startY;
                    
                    let newLeft = initialLeft + dx;
                    let newTop = initialTop + dy;

                    newLeft = Math.max(0, Math.min(newLeft, rect.width - logo.offsetWidth));
                    newTop = Math.max(0, Math.min(newTop, rect.height - logo.offsetHeight));

                    logo.style.left = (newLeft / rect.width) * 100 + '%';
                    logo.style.top = (newTop / rect.height) * 100 + '%';
                }

                function stopDragLogo() {
                    isDragging = false;
                    resumeData.settings.logoLeft = logo.style.left;
                    resumeData.settings.logoTop = logo.style.top;
                    document.onmousemove = null; document.onmouseup = null;
                    saveState();
                }
            }, 50);
        }

        window.downloadPDF = function() {
            const el = document.getElementById('resume-preview'); 
            const clone = el.cloneNode(true);
            clone.style.transform = 'none'; 
            clone.style.backgroundImage = 'none'; 
            
            const wrap = document.createElement('div');
            wrap.style.position = 'fixed'; wrap.style.top = '-9999px'; wrap.appendChild(clone);
            document.body.appendChild(wrap);
            
            html2pdf().set({ 
                margin: 0, 
                filename: 'Artifact.pdf', 
                image: {type: 'jpeg', quality: 0.98}, 
                html2canvas: {scale: 3, useCORS: true}, 
                jsPDF: {unit: 'mm', format: 'a4', orientation: 'portrait'},
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            }).from(clone).save().then(() => document.body.removeChild(wrap));
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
            renderTemplateList();
            document.getElementById('color-picker').innerHTML = COLORS.map(c => `<div onclick="window.updateSetting('color','${c.hex}','${c.grad}')" class="w-8 h-8 rounded-full cursor-pointer border-2 border-white shadow-sm hover:scale-125 transition-transform" style="background:${c.grad}"></div>`).join('');
            renderSidebar(); renderForm(); renderPreview();
            document.querySelectorAll('.reveal-node').forEach(el => revealObserver.observe(el));
            window.addEventListener('resize', scalePreview); updateUndoRedoUI();
        });
    </script>
</body>
</html>
