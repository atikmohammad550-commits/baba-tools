<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Brain V5 - Sovereign Reality</title>
    <!-- Standalone Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.js"></script>
    <!-- HTML2PDF Engine for precise PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@300;400;500;600;700&display=swap');
        
        :root { --accent: #0f766e; --text-main: #1d1d1f; } /* Apple dark text */
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            overflow: hidden; 
            color: var(--text-main); 
            /* iOS Light Background */
            background-color: #F2F2F7;
            height: 100vh; 
            width: 100vw; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
        }
        
        .heading-font { font-family: 'Inter', sans-serif; letter-spacing: -0.02em; }
        
        /* iOS LIQUID GLASS FIX: Clean, bright frosted glass */
        .premium-card { 
            background: rgba(255, 255, 255, 0.6); 
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8); 
            box-shadow: 
                0 4px 24px -4px rgba(0, 0, 0, 0.04),
                inset 0 1px 1px rgba(255, 255, 255, 0.5); 
            border-radius: 24px; 
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
            position: relative;
        }
        .premium-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 
                0 10px 32px -8px rgba(0, 0, 0, 0.08),
                inset 0 1px 1px rgba(255, 255, 255, 0.6); 
            border-color: rgba(255, 255, 255, 1);
        }
        
        /* Hardware Accelerated Wrapper */
        .parallax-wrapper { position: fixed; top: -20%; left: -20%; width: 140%; height: 140%; z-index: -20; pointer-events: none; transition: filter 0.5s ease-in-out; will-change: transform; }
        
        /* Original Liquid Mesh - Increased opacity to pop through the frosted glass */
        .mesh-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -20; transition: opacity 0.5s ease; }
        .liquid-blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.75; animation: liquid-move 20s infinite alternate ease-in-out; mix-blend-mode: multiply; will-change: transform; }
        .blob-1 { background: #bae6fd; width: 700px; height: 700px; top: -10%; left: -10%; } 
        .blob-2 { background: #99f6e4; width: 600px; height: 600px; bottom: -10%; right: -10%; animation-delay: -5s; } 
        .blob-3 { background: #ddd6fe; width: 500px; height: 500px; top: 40%; left: 40%; animation-delay: -10s; } 
        @keyframes liquid-move { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(60px, 40px) scale(1.1); } }
        
        .blob-paused { animation-play-state: paused !important; }

        /* Floating Identity Matrix Elements */
        .pill-container { position: absolute; inset: 0; pointer-events: none; z-index: 0; }
        .floating-pill-element { 
            position: absolute; 
            background: rgba(255, 255, 255, 0.6); 
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.9); 
            border-radius: 999px; 
            box-shadow: 0 4px 16px -4px rgba(0, 0, 0, 0.05), inset 0 1px 2px rgba(255, 255, 255, 0.8); 
            user-select: none; 
            color: #1d1d1f;
            will-change: transform; 
        }

        /* Ultra-Premium Hero Card for Cover Page */
        .hero-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(50px) saturate(200%);
            -webkit-backdrop-filter: blur(50px) saturate(200%);
            border-radius: 40px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.1), inset 0 2px 4px rgba(255, 255, 255, 0.9);
            position: relative;
            z-index: 10;
        }

        .hero-glow-aura {
            position: absolute;
            top: 5%; left: 5%; width: 90%; height: 90%;
            background: radial-gradient(circle, rgba(15, 118, 110, 0.4) 0%, rgba(15, 118, 110, 0) 70%);
            border-radius: 50%; filter: blur(40px); z-index: 0;
            animation: aura-breathe 4s infinite alternate ease-in-out;
        }

        @keyframes aura-breathe {
            0% { transform: scale(0.9); opacity: 0.6; }
            100% { transform: scale(1.1); opacity: 1; }
        }

        /* High-End Dark Slate Button */
        .hero-btn {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            box-shadow: 0 10px 20px -5px rgba(15, 23, 42, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.15);
            color: #ffffff;
            border: 1px solid rgba(15, 23, 42, 1);
            transition: all 0.3s ease;
        }
        .hero-btn:hover { transform: translateY(-2px); box-shadow: 0 15px 30px -5px rgba(15, 23, 42, 0.6); }
        
        .cinematic-enter {
            animation: cinematic-strike 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            will-change: transform, opacity;
        }
        @keyframes cinematic-strike {
            0% { opacity: 0; transform: translateY(15px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        /* EYE-CARE FIX: Inputs are now soft frosted glass, not glaring white rectangles */
        .premium-input { 
            background: rgba(255, 255, 255, 0.6); 
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8); 
            font-weight: 600 !important; 
            font-size: 15px; 
            color: #1d1d1f; 
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); 
            border-radius: 14px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.02), inset 0 1px 2px rgba(255,255,255,0.7); 
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        .premium-input:hover {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(255, 255, 255, 1);
        }
        .premium-input:focus { 
            background: rgba(255, 255, 255, 0.9); 
            border-color: rgba(0, 122, 255, 0.5); 
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.15), inset 0 1px 2px rgba(255,255,255,0.9); 
            outline: none; 
            z-index: 10; 
        }
        .premium-input::placeholder { color: #86868b; font-weight: 500; font-size: 15px; }
        
        /* Custom Input Sliders */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #0d9488; cursor: pointer; margin-top: -7px; box-shadow: 0 2px 8px rgba(13, 148, 136, 0.5); border: 2px solid white; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 5px; cursor: pointer; background: rgba(15, 23, 42, 0.1); border-radius: 4px; }
        input[type=range]:focus { outline: none; }
        
        .page-transition-container { height: 100%; overflow-y: auto; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(15, 23, 42, 0.15); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        
        .brain-glow { animation: brain-glow-pulse 3s infinite ease-in-out; }
        @keyframes brain-glow-pulse { 0%, 100% { box-shadow: 0 0 15px rgba(13, 148, 136, 0.3); transform: scale(1); } 50% { box-shadow: 0 0 25px rgba(13, 148, 136, 0.5); transform: scale(1.05); } }

        /* Glowing Marker for Blueprint Phases */
        .blueprint-marker {
            position: absolute;
            left: -16px;
            top: 24px;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            box-shadow: 0 6px 12px rgba(15, 23, 42, 0.2), inset 0 1px 0 rgba(255,255,255,0.1);
            z-index: 10;
        }

        /* Dynamic Colorful Glow for Final CTA */
        .master-glow-btn {
            background: linear-gradient(45deg, #0f766e, #4f46e5, #9333ea, #0f766e);
            background-size: 300% 300%;
            animation: gradient-shift 4s ease infinite, master-glow-pulse 2s infinite alternate;
            border: 1px solid rgba(255,255,255,0.3);
            will-change: background-position, box-shadow;
        }
        @keyframes gradient-shift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes master-glow-pulse { 0% { box-shadow: 0 0 15px rgba(79, 70, 229, 0.3); transform: scale(1); } 100% { box-shadow: 0 0 25px rgba(147, 51, 234, 0.5); transform: scale(1.02); } }

        .active-ring { animation: subtle-glow-slate 2s infinite; }
        @keyframes subtle-glow-slate { 0%, 100% { box-shadow: 0 0 10px rgba(15, 23, 42, 0.1); } 50% { box-shadow: 0 0 20px rgba(15, 23, 42, 0.2); } }
        .attention-tab { background: #0f172a !important; color: #ffffff !important; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2) !important; border-color: #0f172a !important; }
        
        .mission-control-overlay { background: rgba(226, 232, 240, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
        .mission-card { background: rgba(255,255,255,0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.8); border-radius: 24px; box-shadow: 0 10px 30px -10px rgba(15,23,42,0.1); transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .mission-card:hover { transform: translateY(-8px) scale(1.02); border-color: rgba(255,255,255,1); box-shadow: 0 20px 40px -15px rgba(15,23,42,0.15); background: rgba(255,255,255,0.8); }
        .mission-icon-bg { background: rgba(255,255,255,0.5); border-radius: 16px; transition: all 0.3s ease; color: #64748b; border: 1px solid rgba(255,255,255,0.8); }
        .mission-card:hover .mission-icon-bg { background: #0f172a; color: #fff; box-shadow: 0 8px 16px rgba(15, 23, 42, 0.2); border-color: #0f172a; }
        .mission-active { background: #0f172a !important; color: #ffffff !important; border-color: #0f172a !important; box-shadow: 0 20px 40px rgba(15,23,42,0.2); transform: scale(1.02); }
        .mission-active .mission-icon-bg { background: rgba(255,255,255,0.1) !important; color: #ffffff !important; border-color: rgba(255,255,255,0.2); }
        .mission-active p { color: #ffffff !important; opacity: 1 !important; }
        .mission-active p.desc { color: #94a3b8 !important; }
        
        .print-only { display: none; }
        .pdf-export-mode .print-only { display: block !important; }
        .pdf-export-mode .blueprint-grid-item { break-inside: avoid; page-break-inside: avoid; margin-bottom: 32px; }
        .pdf-export-mode .premium-card { box-shadow: none !important; border: 1px solid #cbd5e1 !important; }
        .pdf-export-mode { background: white !important; padding: 24px; }
        
        @media print {
            .no-print, header button, header .flex.gap-3, .parallax-wrapper, .fixed, .mission-control-card, button, .toggle-container, .page-transition-container::-webkit-scrollbar, .cursor-pointer, input[type=range] { display: none !important; }
            body { background: white !important; color: black !important; overflow: visible !important; height: auto !important; width: 100% !important; margin: 0 !important; background-image: none !important; }
            #root { margin: 0 !important; padding: 0 !important; height: auto !important; overflow: visible !important; }
            .page-transition-container { height: auto !important; overflow: visible !important; padding: 0 !important; margin: 0 !important; display: block !important; }
            #blueprint-root { display: block !important; padding-top: 0 !important; }
            .blueprint-grid-container { display: grid !important; }
            .blueprint-grid-item { width: 100% !important; page-break-inside: avoid !important; margin-bottom: 40px !important; break-inside: avoid; border-left: none !important; padding-left: 0 !important; }
            .premium-card { box-shadow: none !important; border: 1px solid #e2e8f0 !important; background: white !important; backdrop-filter: none !important; margin-bottom: 24px !important; padding: 20px !important; border-radius: 12px !important; transform: none !important; break-inside: avoid; }
            .blueprint-marker { border: 1px solid black; color: black !important; background: white !important; position: static !important; display: inline-block !important; margin-bottom: 12px !important; box-shadow: none !important; animation: none !important; }
            .print-only { display: block !important; }
            .bg-slate-900 { background-color: #f8fafc !important; color: black !important; border: 1px solid #cbd5e1; }
            .text-white { color: black !important; }
            header { border-bottom: 2px solid #000 !important; padding-bottom: 24px !important; margin-bottom: 32px !important; display: flex !important; flex-direction: row !important; justify-content: space-between !important; align-items: flex-end !important; position: static !important; background: none !important; box-shadow: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Utilities ---
        const safeNumber = (val) => {
            if (val === undefined || val === null || val === '') return 0;
            const strVal = String(val).replace(/,/g, '');
            const parsed = parseFloat(strVal);
            return isNaN(parsed) ? 0 : parsed;
        };

        const formatCurrency = (val) => "₹" + Math.round(safeNumber(val)).toLocaleString('en-IN');
        
        const formatMask = (val, isCurrency = false) => {
            if (val === "" || val === undefined || val === null) return "";
            let x = val.toString().replace(/,/g, '');
            if (!isCurrency && !/^\d+$/.test(x)) return x; 
            let lastThree = x.substring(x.length - 3);
            let otherNumbers = x.substring(0, x.length - 3);
            if (otherNumbers !== '') lastThree = ',' + lastThree;
            return otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + lastThree;
        };

        const calculateStepUpSip = (targetValue, years, returns, stepUp, lumpsum = 0) => {
            if (years <= 0 || targetValue <= 0) return 0;
            const r = (returns / 100) / 12, g = (stepUp || 0) / 100, n = years * 12;
            const fvLumpsum = lumpsum * Math.pow(1 + r, n);
            const needed = Math.max(0, targetValue - fvLumpsum);
            if (needed <= 0) return 0;
            let low = 0, high = needed * 2;
            for (let i = 0; i < 40; i++) {
                let mid = (low + high) / 2;
                let total = 0, curSip = mid;
                for (let m = 1; m <= n; m++) {
                    total = (total + curSip) * (1 + r);
                    if (m % 12 === 0) curSip *= (1 + g);
                }
                if (total < needed) low = mid; else high = mid;
            }
            return high;
        };

        // --- Data Repositories ---
        const KEYWORDS = ["QUANTUM", "LEGACY", "COMPOUND", "HORIZON", "STRATEGY", "DESTINY", "EQUITY", "RESERVOIR", "CAPITAL", "NAVIGATOR", "BLUEPRINT", "FIDUCIARY", "LIQUID", "FISCAL", "ZENITH", "CORE", "MANIFEST", "MATRIX", "VITALITY", "INFLOW", "ASSET", "WEALTH", "SIP", "AUDIT", "GROWTH", "FUTURE", "VISION", "TRUST", "ALPHA", "BETA", "YIELD", "CORPUS", "LIQUIDITY", "INDEX", "BENCHMARK", "HEDGE", "INFLATION", "PORTFOLIO", "DIVERSIFY", "SECURE", "DIVIDEND", "VALUE", "PRINCIPAL", "RETURN", "BABA", "FINANCE", "LOGIC", "MATH", "FREEDOM", "TIME", "RISK", "REWARD", "ESTATE", "TAX", "PLAN", "GOAL", "RETIRE", "EARN", "SAVE", "INVEST", "LIFE", "DREAM", "BUILD", "SCALE"];

        const AGE_DATA = {
             range: (age) => {
                if (age <= 18) return { c: "You are in your foundation years. Learning, curiosity, and habits matter more than achievements right now.", f: "Most globally successful founders and leaders did not build anything major before adulthood." };
                return null;
            },
            19: { c: "This is the age to experiment without fear of failure.", f: "At age 19, Ritesh Agarwal founded OYO Rooms." },
            20: { c: "Skills and direction matter more than degrees here.", f: "At age 20, Bill Gates dropped out of Harvard to build Microsoft." },
            21: { c: "Responsibility starts replacing freedom.", f: "At age 21, Steve Jobs co-founded Apple." },
            22: { c: "Feeling confused at this age is completely normal.", f: "At age 22, Mark Zuckerberg was running Facebook with millions of users." },
            23: { c: "Consistency begins to separate people.", f: "At age 23, Evan Spiegel launched Snapchat." },
            24: { c: "Progress may feel slow — that doesn’t mean it is.", f: "At age 24, Jeff Bezos was still working a regular job." },
            25: { c: "This is where habits start compounding.", f: "At age 25, Elon Musk sold Zip2 and reinvested everything." },
            26: { c: "Self-doubt often peaks before clarity.", f: "At age 26, Sachin Tendulkar became the youngest to score 10,000 ODI runs." },
            27: { c: "Focus starts outperforming raw effort.", f: "At age 27, Larry Page was scaling Google globally." },
            28: { c: "Long-term thinking begins here.", f: "At age 28, Mukesh Ambani joined Reliance Industries." },
            29: { c: "Comparison becomes dangerous at this age.", f: "At age 29, Jack Ma was still facing repeated rejections." },
            30: { c: "Discipline matters more than motivation now.", f: "At age 30, Vera Wang entered the fashion industry." },
            31: { c: "Clarity starts replacing confusion.", f: "At age 31, Sundar Pichai joined Google as a product manager." },
            32: { c: "This is when patience starts paying off.", f: "At age 32, Chris Gardner was homeless before rebuilding his life." },
            33: { c: "Pressure increases — so does capability.", f: "At age 33, Alexander Fleming was still an unknown researcher." },
            34: { c: "Experience begins to turn into leverage.", f: "At age 34, Dhirubhai Ambani started Reliance Commercial Corporation." },
            35: { c: "Long-term thinking becomes natural.", f: "At age 35, Henry Ford founded Ford Motor Company." },
            36: { c: "Simplifying life improves results.", f: "At age 36, Oprah Winfrey launched Harpo Productions." },
            37: { c: "Energy must be managed, not wasted.", f: "At age 37, Vinod Khosla exited Sun Microsystems." },
            38: { c: "Consistency beats intensity now.", f: "At age 38, Reed Hastings founded Netflix." },
            39: { c: "Confidence becomes quiet.", f: "At age 39, Arianna Huffington was still recovering from failures." },
            40: { c: "Experience becomes your advantage.", f: "At age 40, Reid Hoffman co-founded LinkedIn." },
            41: { c: "Quality starts replacing quantity.", f: "At age 41, Howard Schultz was expanding Starbucks." },
            42: { c: "Reflection sharpens direction.", f: "At age 42, Sam Walton opened his first true Walmart store." },
            43: { c: "Stability enables creativity.", f: "At age 43, Jeff Bezos launched AWS." },
            44: { c: "Legacy thinking begins.", f: "At age 44, Indra Nooyi was leading strategy at PepsiCo." },
            45: { c: "Reinvention is still very real.", f: "At age 45, Colonel Sanders was still struggling." },
            46: { c: "Wisdom improves decision-making.", f: "At age 46, Narayan Murthy was scaling Infosys." },
            47: { c: "Health becomes an asset.", f: "At age 47, Satya Nadella led cloud initiatives." },
            48: { c: "Calm thinking wins more than speed.", f: "At age 48, Ray Dalio was building Bridgewater." },
            49: { c: "Preparation beats urgency.", f: "At age 49, Jeff Weiner led LinkedIn." },
            50: { c: "Patience compounds faster than effort.", f: "At age 50, Ray Kroc turned McDonald’s global." },
            51: { c: "Experience protects from bad decisions.", f: "At age 51, Satya Nadella became CEO of Microsoft." },
            52: { c: "Perspective is valuable.", f: "At age 52, Jeff Bezos expanded Amazon globally." },
            53: { c: "Less effort, better outcomes.", f: "At age 53, Narendra Modi became CM of Gujarat." },
            54: { c: "Clarity beats ambition.", f: "At age 54, Indra Nooyi became CEO of PepsiCo." },
            55: { c: "Consistency protects what you’ve built.", f: "At age 55, Jack Ma stepped back to focus on education." },
            60: { c: "Wisdom outweighs ambition.", f: "At age 60, Harland Sanders began franchising KFC." },
            65: { c: "Freedom increases with acceptance.", f: "At age 65, Vera Wang was still expanding globally." },
            70: { c: "Perspective becomes your greatest asset.", f: "At age 70, J.K. Rowling was still writing." },
            75: { c: "Legacy becomes intentional.", f: "At age 75, Nelson Mandela became President." },
            80: { c: "Time turns experience into wisdom.", f: "At age 80, Galileo continued writing." },
            90: { c: "Presence outweighs ambition.", f: "At age 90, Picasso was still painting." }
        };

        const getAgeInfo = (age) => {
            const numAge = parseInt(age);
            if (!numAge) return null;
            if (numAge <= 18) return AGE_DATA.range(numAge);
            return AGE_DATA[numAge] || { c: "A year of potential.", f: "History is full of late bloomers and early risers." };
        };

        const getIncomeComment = (type, val) => {
            const v = safeNumber(val);
            if (type === 'salary') {
                if (v === 0) return { c: "No salary currently.", f: "" };
                if (v < 65000) return { c: "Financial discipline starts here.", f: "" };
                if (v < 125000) return { c: "Growth zone. Smart investing now changes trajectories.", f: "" };
                return { c: "High leverage income. Focus on wealth preservation.", f: "" };
            }
            if (type === 'business') {
                 if (v === 0) return { c: "No business income yet. Focus on validation.", f: "" };
                 if (v < 150000) return { c: "Traction achieved. Systems define the next step.", f: "" };
                 return { c: "Scaling phase. Risk management is critical.", f: "" };
            }
        };

        const ASSET_CLASSES_LIST = [
            { id: "mfPool", label: "Mutual Funds", yield: 12, color: "#0f766e" },
            { id: "stockPool", label: "Equity Stocks", yield: 15, color: "#4338ca" },
            { id: "debtPool", label: "Debt Portfolio", yield: 8, color: "#be123c" },
            { id: "cashPool", label: "Cash/Bank", yield: 4, color: "#d97706" },
            { id: "fdPool", label: "Fixed Deposits", yield: 6, color: "#475569" },
            { id: "realAssets", label: "Real Estate", yield: 8, color: "#0369a1" }
        ];

        const SUGGESTED_GOALS = [
            { name: "Luxury Car", cost: 4000000, horizon: 5, icon: "car" },
            { name: "World Tour", cost: 1500000, horizon: 3, icon: "palmtree" },
            { name: "Home renovation", cost: 3000000, horizon: 4, icon: "home" },
            { name: "Business Fund", cost: 5000000, horizon: 7, icon: "briefcase" }
        ];

        const CHILD_MILESTONES = [
            { id: "m10", label: "10th Std", age: 15, defaultCost: 200000, defaultInflation: 10 },
            { id: "m12", label: "12th Std", age: 17, defaultCost: 300000, defaultInflation: 10 },
            { id: "mCol", label: "College", age: 18, defaultCost: 1500000, defaultInflation: 10 },
            { id: "mMar", label: "Marriage", age: 25, defaultCost: 2500000, defaultInflation: 8 }
        ];

        // --- Shared Components ---
        const FloatingPillCloud = ({ active }) => {
            const containerRef = useRef(null);
            const activeRef = useRef(active);
            
            useEffect(() => { activeRef.current = active; }, [active]);
            
            const pills = useMemo(() => {
                const hdWords = [...KEYWORDS].slice(0, 60); 
                return Array.from({ length: 60 }).map((_, i) => ({
                    id: i, 
                    word: hdWords[i % hdWords.length],
                    x: Math.random() * 100, y: Math.random() * 100,
                    vx: (Math.random() - 0.5) * 0.4, vy: (Math.random() - 0.5) * 0.4,
                    driftX: 0, driftY: 0, interactX: 0, interactY: 0,
                }));
            }, []);

            useEffect(() => {
                const container = containerRef.current;
                if (!container) return; 

                const domEls = pills.map(p => {
                    const el = document.createElement('div');
                    el.className = 'floating-pill-element px-4 py-2 text-[13px] font-black uppercase tracking-widest';
                    el.innerText = p.word;
                    el.style.left = `${p.x}%`;
                    el.style.top = `${p.y}%`;
                    container.appendChild(el);
                    return { el, ...p }; 
                });

                let animationFrameId;
                let mouseX = -1000;
                let mouseY = -1000;

                const update = () => {
                    if (activeRef.current) {
                        const rect = container.getBoundingClientRect();
                        
                        domEls.forEach(p => {
                            p.driftX += p.vx;
                            p.driftY += p.vy;
                            
                            if (p.driftX > 150 || p.driftX < -150) p.vx *= -1;
                            if (p.driftY > 150 || p.driftY < -150) p.vy *= -1;

                            const pillPxX = (p.x / 100) * rect.width + p.driftX;
                            const pillPxY = (p.y / 100) * rect.height + p.driftY;
                            const dx = mouseX - pillPxX;
                            const dy = mouseY - pillPxY;
                            const dist = Math.sqrt(dx*dx + dy*dy);
                            const maxDist = 200; 

                            let targetTx = 0, targetTy = 0;
                            if (dist < maxDist) {
                                const force = (maxDist - dist) / maxDist;
                                const angle = Math.atan2(dy, dx);
                                targetTx = Math.cos(angle) * force * -60;
                                targetTy = Math.sin(angle) * force * -60;
                            }

                            p.interactX += (targetTx - p.interactX) * 0.08; 
                            p.interactY += (targetTy - p.interactY) * 0.08;
                            p.el.style.transform = `translate3d(${p.driftX + p.interactX}px, ${p.driftY + p.interactY}px, 0)`;
                        });
                    }
                    animationFrameId = requestAnimationFrame(update);
                };

                const onMouseMove = (e) => {
                    if (!activeRef.current) return;
                    const rect = container.getBoundingClientRect();
                    mouseX = e.clientX - rect.left;
                    mouseY = e.clientY - rect.top;
                };

                window.addEventListener('mousemove', onMouseMove);
                update();

                return () => {
                    window.removeEventListener('mousemove', onMouseMove);
                    cancelAnimationFrame(animationFrameId);
                    if (container) container.innerHTML = '';
                };
            }, [pills]);

            return <div ref={containerRef} className={`absolute inset-0 overflow-hidden z-0 pill-container transition-opacity duration-500 ${active ? 'opacity-100' : 'opacity-0 hidden'}`}></div>;
        };
        
        const LiquidBackground = ({ view, isBlueprintMode }) => (
            <div className={`mesh-container transition-all duration-1000 ${view === 'flow' ? 'bg-[#F2F2F7]' : 'bg-[#E5E5EA]'} ${isBlueprintMode ? 'opacity-40 blur-[100px]' : 'opacity-100'}`}>
                <div className={`liquid-blob blob-1 ${isBlueprintMode ? 'blob-paused' : ''}`}></div>
                <div className={`liquid-blob blob-2 ${isBlueprintMode ? 'blob-paused' : ''}`}></div>
                <div className={`liquid-blob blob-3 ${isBlueprintMode ? 'blob-paused' : ''}`}></div>
            </div>
        );

        const Icon = ({ name, size = 18, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    containerRef.current.innerHTML = `<i data-lucide="${name}" width="${size}" height="${size}"></i>`;
                    window.lucide.createIcons({ root: containerRef.current });
                }
            }, [name, size, className]);
            return <span ref={containerRef} className={`inline-flex items-center justify-center ${className}`} style={{ width: size, height: size }} />;
        };

        const AnimatedCurrency = ({ value, prefix = "₹" }) => {
            const [display, setDisplay] = useState(0);
            useEffect(() => {
                let start = display;
                const end = safeNumber(value);
                const duration = 600;
                const startTime = performance.now();
                const animate = (now) => {
                    const progress = Math.min((now - startTime) / duration, 1);
                    setDisplay(start + (end - start) * (1 - Math.pow(1 - progress, 3)));
                    if (progress < 1) requestAnimationFrame(animate);
                };
                requestAnimationFrame(animate);
            }, [value]);
            return <span>{prefix}{Math.round(display).toLocaleString('en-IN')}</span>;
        };

        const Toggle = ({ label, value, onChange, fact }) => {
            return (
                <div className="space-y-2 text-left">
                    <div className="flex flex-col sm:flex-row sm:items-center justify-between p-4 bg-white/60 backdrop-blur-2xl border border-white/80 rounded-2xl shadow-[0_4px_16px_rgba(0,0,0,0.04)] no-print gap-3 transition-all hover:shadow-[0_6px_24px_rgba(0,0,0,0.06)]">
                        <span className="text-sm font-semibold text-slate-800 tracking-tight pl-1">{label}</span>
                        <div className="flex bg-slate-200/50 p-1 rounded-xl shrink-0 sm:ml-4 shadow-inner border border-white/40 w-full sm:w-auto">
                            <button onClick={() => onChange(true)} className={`flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold transition-all duration-300 ${value ? 'bg-white text-slate-900 shadow-[0_2px_8px_rgba(0,0,0,0.08)] scale-100' : 'text-slate-500 hover:text-slate-800 scale-95 hover:scale-100'}`}>YES</button>
                            <button onClick={() => onChange(false)} className={`flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold transition-all duration-300 ${!value ? 'bg-white text-slate-900 shadow-[0_2px_8px_rgba(0,0,0,0.08)] scale-100' : 'text-slate-500 hover:text-slate-800 scale-95 hover:scale-100'}`}>NO</button>
                        </div>
                    </div>
                    {fact && (
                         <div className="mt-2 p-4 bg-white/60 backdrop-blur-2xl border border-white/90 rounded-2xl shadow-[0_4px_20px_rgba(0,0,0,0.03)] animate-in zoom-in-95 duration-500">
                            <p className="text-sm font-medium text-slate-700 leading-relaxed italic flex gap-3 items-start"><Icon name="info" size={18} className="text-blue-500 mt-0.5 shrink-0"/> <span>"{fact.c}"</span></p>
                        </div>
                    )}
                </div>
            );
        };

        const InputField = ({ label, value, onChange, prefix, suffix, type="text", isError, maxLength, yieldBadge, fact, isAge, noNumbers }) => {
            const [localVal, setLocalVal] = useState(value ? formatMask(value, prefix === "₹") : "");
            
            useEffect(() => { setLocalVal(formatMask(value, prefix === "₹")); }, [value, prefix]);

            const handleText = (v) => {
                let raw = v.replace(/,/g, '');
                if (suffix === '%' || suffix === 'Yrs') {
                    raw = raw.replace(/[^0-9.]/g, ""); 
                    const parts = raw.split('.');
                    if(parts.length > 2) raw = parts[0] + '.' + parts.slice(1).join('');
                } else if (type === "number" || isAge) {
                    raw = raw.replace(/[^0-9]/g, ""); 
                }
                if (noNumbers) raw = raw.replace(/[0-9]/g, "");
                if (isAge && raw !== "") {
                    if (parseInt(raw) > 99) raw = "99";
                }
                if (maxLength) raw = raw.slice(0, maxLength);
                setLocalVal(formatMask(raw, prefix === "₹"));
                onChange(raw);
            };

            return (
                <div className="space-y-2 group relative text-left">
                    <div className="flex justify-between items-end px-1 mb-1.5 text-left">
                        <label className="text-[13px] font-semibold text-slate-600 tracking-tight block relative z-10">{label}</label>
                        {yieldBadge && <span className="text-xs font-bold text-emerald-700 bg-emerald-50/80 backdrop-blur-md px-2 py-0.5 rounded-md border border-emerald-200/50 relative z-10 shadow-sm">Yield: {yieldBadge}%</span>}
                    </div>
                    <div className="relative flex items-center text-left">
                        {prefix && <span className="absolute left-4 text-slate-400 font-semibold text-base z-20">{prefix}</span>}
                        <input 
                            type="text" value={localVal} onChange={(e) => handleText(e.target.value)}
                            className={`w-full premium-input px-4 relative z-10 ${prefix ? 'pl-9' : ''} ${suffix ? 'pr-12' : ''} ${isError ? 'border-red-400 bg-red-50 text-red-900 shadow-[0_0_0_2px_rgba(255,59,48,0.2)]' : ''}`}
                            placeholder={label.includes('Name') ? 'Enter text here...' : '0'}
                        />
                        {suffix && <span className="absolute right-4 text-slate-400 text-sm font-semibold tracking-wide z-20">{suffix}</span>}
                    </div>
                    {fact && (
                        <div className="mt-3 p-4 bg-white/60 backdrop-blur-2xl border border-white/90 rounded-2xl shadow-[0_4px_20px_rgba(0,0,0,0.03)] animate-in zoom-in-95 duration-500 text-left relative z-10">
                            <p className="text-sm font-medium text-slate-700 leading-relaxed italic flex gap-3 items-start"><Icon name="sparkles" size={18} className="text-amber-500 mt-0.5 shrink-0"/> <span>"{fact.c}"</span></p>
                            {fact.f && <p className="text-xs font-medium text-slate-500 pt-3 border-t border-slate-200/60 mt-3 flex items-start gap-2"><Icon name="book-open" size={14} className="mt-0.5 shrink-0"/> <span><strong>Fact:</strong> {fact.f}</span></p>}
                        </div>
                    )}
                </div>
            );
        };

        const TaskSwitcher = ({ isOpen, onToggle, currentStep, onJump }) => {
            const steps = [
                { n: 1, label: "Profile", icon: "user", desc: "Identity & Flow" }, 
                { n: 2, label: "Burn", icon: "flame", desc: "Cash Flow Audit" }, 
                { n: 3, label: "Assets", icon: "landmark", desc: "Wealth Reservoirs" }, 
                { n: 4, label: "Horizon", icon: "target", desc: "Strategy Horizon" }, 
                { n: 5, label: "Blueprint", icon: "brain", desc: "Master Projection" }
            ];
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[5000] flex flex-col items-center justify-center p-6 sm:p-12 no-print text-left mission-control-overlay animate-in fade-in duration-300">
                    <div className="absolute inset-0" onClick={onToggle} />
                    <h2 className="relative z-10 text-2xl font-extrabold text-slate-800 uppercase tracking-[0.4em] mb-12 animate-in slide-in-from-top-4 duration-500 delay-100">Mission Control</h2>
                    <div className="relative w-full max-w-5xl flex flex-wrap justify-center gap-6 sm:gap-8">
                        {steps.map((s, index) => (
                            <div 
                                key={s.n} 
                                onClick={() => { onJump(s.n); onToggle(); }} 
                                className={`mission-card group w-40 sm:w-48 p-6 text-center cursor-pointer animate-in zoom-in-75 slide-in-from-bottom-8 duration-500 ${currentStep === s.n ? 'mission-active' : ''}`}
                                style={{ animationDelay: `${index * 50}ms`, animationFillMode: 'both' }}
                            >
                                <div className={`mission-icon-bg w-14 h-14 mx-auto flex items-center justify-center mb-5`}>
                                    <Icon name={s.icon} size={28}/>
                                </div>
                                <p className="text-sm font-bold uppercase tracking-widest mb-1.5 text-slate-800 transition-colors">{s.label}</p>
                                <p className="text-xs font-semibold text-slate-500 desc transition-colors">{s.desc}</p>
                            </div>
                        ))}
                    </div>
                    <p className="relative z-10 text-xs font-bold text-slate-500 uppercase tracking-widest mt-12 cursor-pointer hover:text-slate-800 transition-colors bg-white/80 backdrop-blur-md px-5 py-2.5 rounded-full border border-white/60 shadow-sm" onClick={onToggle}>Click anywhere to dismiss</p>
                </div>
            );
        };

        // --- Internal SVG Charts ---
        const AssetAllocationPie = ({ profile }) => {
            const data = useMemo(() => {
                const d = ASSET_CLASSES_LIST.map(a => ({ 
                    label: a.label, 
                    value: safeNumber(profile[a.id]),
                    color: a.color 
                })).filter(d => d.value > 0);
                
                const customTotal = (profile.customReservoirs || []).reduce((a,c)=>a+safeNumber(c.value), 0);
                if(customTotal > 0) d.push({ label: "Custom Assets", value: customTotal, color: "#6366f1" });
                return d;
            }, [profile]);

            const total = data.reduce((a,b)=>a+b.value, 0);
            if (total === 0) {
                return (
                    <div className="flex flex-col items-center justify-center p-6 bg-white/30 backdrop-blur-md rounded-2xl border-2 border-white/50 border-dashed mt-5 text-center shadow-sm opacity-80 relative z-10">
                        <div className="relative w-20 h-20 mb-3 opacity-60">
                            <svg viewBox="0 0 32 32">
                                <circle r="15" cx="16" cy="16" fill="transparent" stroke="#cbd5e1" strokeWidth="2" strokeDasharray="4 4" />
                            </svg>
                            <div className="absolute inset-0 flex items-center justify-center">
                                <Icon name="inbox" size={28} className="text-slate-400" />
                            </div>
                        </div>
                        <span className="text-xs font-bold text-slate-500 uppercase tracking-widest">Awaiting Asset Data</span>
                        <p className="text-xs text-slate-400 mt-1.5 max-w-[220px] font-medium leading-relaxed">Inputs from Phase 3 are required to generate your matrix.</p>
                    </div>
                );
            }

            let currentAngle = 0;
            return (
                <div className="flex flex-col xl:flex-row items-center gap-6 p-5 bg-white/40 backdrop-blur-md rounded-2xl border border-white/50 mt-5 text-left shadow-[0_4px_16px_-4px_rgba(0,0,0,0.05)] h-full justify-center">
                    <div className="relative w-32 h-32 shrink-0">
                        <svg viewBox="0 0 32 32" className="rotate-[-90deg]">
                            {data.map((item, i) => {
                                const percentage = (item.value / total) * 100;
                                const segment = (
                                    <circle key={i} r="16" cx="16" cy="16" fill="transparent"
                                        stroke={item.color} strokeWidth="32"
                                        strokeDasharray={`${percentage} 100`}
                                        strokeDashoffset={-currentAngle} 
                                        className="transition-all duration-1000 ease-out hover:opacity-80"
                                    />
                                );
                                currentAngle += percentage;
                                return segment;
                            })}
                            <circle r="12" cx="16" cy="16" fill="rgba(255,255,255,0.7)" />
                        </svg>
                        <div className="absolute inset-0 flex items-center justify-center flex-col">
                            <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Total</span>
                            <span className="text-xs font-extrabold text-slate-900">{formatCurrency(total)}</span>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-x-4 gap-y-3 w-full text-left">
                        {data.map((item, i) => (
                            <div key={i} className="flex justify-between items-center text-xs">
                                <span className="flex items-center gap-2 font-medium text-slate-700 truncate max-w-[100px]" title={item.label}>
                                    <span className="w-2.5 h-2.5 rounded-full shrink-0" style={{backgroundColor: item.color}}></span> {item.label}
                                </span>
                                <span className="font-extrabold text-slate-900">{Math.round((item.value/total)*100)}%</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const InflationChart = ({ currentBurn, futureBurn, years }) => {
            const ratio = futureBurn / (currentBurn || 1);
            return (
                <div className="flex items-end justify-center gap-6 h-32 mt-4 p-4 bg-white/40 backdrop-blur-md rounded-2xl border border-white/60 shadow-[0_4px_16px_-4px_rgba(0,0,0,0.05)]">
                    <div className="flex flex-col items-center gap-2">
                        <div className="w-12 bg-teal-200/80 rounded-t-lg shadow-sm border border-white/50" style={{height: '30px'}}></div>
                        <span className="text-[10px] font-bold text-slate-500 tracking-widest uppercase">Today</span>
                        <span className="text-xs font-bold text-slate-800">{formatCurrency(currentBurn)}/mo</span>
                    </div>
                    <div className="flex-1 flex flex-col items-center justify-center pb-6 border-b-2 border-dashed border-rose-300 relative px-2">
                        <span className="text-[10px] font-bold text-rose-600 bg-rose-50/80 backdrop-blur-md border border-rose-200 px-2 py-0.5 rounded absolute top-0 shadow-sm whitespace-nowrap">+{ratio.toFixed(1)}x Inflation</span>
                        <div className="w-full h-0 relative"><div className="absolute right-0 top-[-6px] w-3 h-3 border-r-2 border-t-2 border-rose-400 transform rotate-45"></div></div>
                    </div>
                    <div className="flex flex-col items-center gap-2">
                        <div className="w-12 bg-rose-400 rounded-t-lg shadow-md relative border border-rose-300" style={{height: '80px'}}>
                            <div className="absolute inset-0 bg-gradient-to-t from-rose-500 to-transparent rounded-t-lg opacity-50"></div>
                        </div>
                        <span className="text-[10px] font-bold text-rose-600 tracking-widest uppercase">Year {years}</span>
                        <span className="text-sm font-bold text-slate-900">{formatCurrency(futureBurn)}/mo</span>
                    </div>
                </div>
            );
        };

        const AllocationDonut = ({ data, total }) => {
            if (total === 0) {
                return (
                    <div className="flex flex-col items-center justify-center p-4 bg-white/30 backdrop-blur-md rounded-2xl border-2 border-white/50 border-dashed text-center shadow-sm opacity-80 relative z-10 h-full min-h-[140px]">
                        <div className="relative w-12 h-12 mb-2 opacity-60">
                            <svg viewBox="0 0 40 40">
                                <circle r="18" cx="20" cy="20" fill="transparent" stroke="#cbd5e1" strokeWidth="2" strokeDasharray="4 4" />
                            </svg>
                            <div className="absolute inset-0 flex items-center justify-center">
                                <Icon name="pie-chart" size={16} className="text-slate-400" />
                            </div>
                        </div>
                        <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">No Existing Wealth</span>
                    </div>
                );
            }
            let currentAngle = 0;
            const radius = 16;
            const circumference = 2 * Math.PI * radius;

            return (
                <div className="flex items-center gap-4 p-4 bg-white/40 backdrop-blur-md rounded-2xl border border-white/50 text-left shadow-[0_4px_16px_-4px_rgba(0,0,0,0.05)] h-full min-h-[140px] justify-center">
                    <div className="relative w-20 h-20 shrink-0">
                        <svg viewBox="0 0 40 40" className="rotate-[-90deg]">
                            {data.map((item, i) => {
                                const percentage = item.value / total;
                                const strokeDasharray = `${percentage * circumference} ${circumference}`;
                                const strokeDashoffset = -currentAngle;
                                currentAngle += percentage * circumference;
                                const colors = ["#0f766e", "#4338ca", "#be123c", "#d97706", "#475569"];
                                return (
                                    <circle key={i} cx="20" cy="20" r={radius} fill="transparent" stroke={colors[i % colors.length]} strokeWidth="4" strokeDasharray={strokeDasharray} strokeDashoffset={strokeDashoffset} />
                                );
                            })}
                        </svg>
                        <div className="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-slate-500">ALLOC</div>
                    </div>
                    <div className="space-y-2 w-full text-left">
                        {data.map((item, i) => {
                             const colors = ["bg-teal-600", "bg-indigo-600", "bg-rose-600", "bg-amber-600", "bg-slate-600"];
                             return (
                                 <div key={i} className="flex justify-between text-[11px]">
                                    <span className="flex items-center gap-2 font-medium text-slate-700 truncate max-w-[100px]"><span className={`w-2 h-2 rounded-full ${colors[i % colors.length]}`}></span> {item.label}</span>
                                    <span className="font-extrabold text-slate-900">{Math.round((item.value/total)*100)}%</span>
                                 </div>
                             );
                        })}
                    </div>
                </div>
            );
        };

        // --- PHASE WRAPPER COMPONENT ---
        const PhaseWrapper = ({ num, title, layout, children, gridClasses }) => {
            const isList = layout === 'list';
            return (
                <div className={`relative ${isList ? 'pl-12 md:pl-16 w-full' : gridClasses} transition-all duration-300`}>
                    {isList && (
                        <div className="absolute left-0 top-6 w-10 h-10 bg-slate-900 text-white rounded-xl flex items-center justify-center font-black text-sm shadow-lg z-10">
                            {num}
                        </div>
                    )}
                    
                    <div className={`premium-card ${isList ? 'p-8 md:p-10' : 'p-6 flex flex-col h-full'} text-left`}>
                        {!isList && title && (
                            <div className="flex items-center gap-3 border-b border-white/60 pb-4 mb-4 text-left relative z-10">
                                <div className="w-8 h-8 bg-slate-900 text-white rounded-lg flex items-center justify-center font-bold text-sm shadow-md shrink-0">{num}</div>
                                <h3 className="text-sm font-black uppercase tracking-widest text-slate-900">{title}</h3>
                            </div>
                        )}
                        {isList && title && (
                            <div className="flex items-center gap-4 border-b border-white/60 pb-5 mb-6 text-left relative z-10">
                                <h3 className="text-xl font-black heading-font uppercase tracking-widest text-slate-900">{title}</h3>
                            </div>
                        )}
                        
                        <div className="relative z-10 flex-1 flex flex-col">
                            {children}
                        </div>
                    </div>
                </div>
            )
        };

        // --- FLOW COMPONENTS ---
        const CalibrationFlow = ({ profile, setProfile, step }) => {
            const ageFact = useMemo(() => getAgeInfo(profile.age), [profile.age]);
            
            const incomeComment = useMemo(() => {
                 return profile.businessIncome ? getIncomeComment('business', profile.businessIncome) : getIncomeComment('salary', profile.salary);
            }, [profile.salary, profile.businessIncome]);
            
            const marriedComment = useMemo(() => {
                if(!profile.married) return {c: "Being single gives you maximum flexibility — time, risk-taking, and self-focus."};
                return {c: "Marriage shifts life from individual decisions to shared responsibility and planning."};
            }, [profile.married]);
            
            const childComment = useMemo(() => {
                if(!profile.hasChildren) return {c: "This phase allows financial consolidation and relationship strengthening."};
                const cnt = safeNumber(profile.childCount);
                if(cnt === 1) return {c: "Raising one child allows focused attention, but long-term planning is still crucial."};
                if(cnt === 2) return {c: "Balancing resources, time, and education planning becomes more important now."};
                if(cnt >= 3) return {c: "Financial discipline and structured planning are no longer optional."};
            }, [profile.hasChildren, profile.childCount]);

            const totals = useMemo(() => {
                const income = safeNumber(profile.salary) + safeNumber(profile.businessIncome);
                const monthlyBurn = safeNumber(profile.rent) + safeNumber(profile.household) + safeNumber(profile.lifestyle) + safeNumber(profile.emi);
                const assets = ASSET_CLASSES_LIST.reduce((a, c) => a + safeNumber(profile[c.id]), 0) + (profile.customReservoirs || []).reduce((a, c) => a + safeNumber(c.value), 0);
                const insurance = safeNumber(profile.healthPremium) + safeNumber(profile.lifePremium);
                const annualBurn = (monthlyBurn * 12) + safeNumber(profile.vacation) + insurance;
                const monthlyTotalBurn = monthlyBurn + (insurance/12) + (safeNumber(profile.vacation)/12);
                return { income, burn: monthlyTotalBurn, assets };
            }, [profile]);

            return (
                <div key={step} className="max-w-[1600px] w-full mx-auto px-6 lg:px-10 grid grid-cols-1 lg:grid-cols-12 gap-8 pb-20 cinematic-enter text-left">
                    <div className="lg:col-span-8 xl:col-span-9">
                        <div className="premium-card p-6 md:p-8 text-left">
                            <h2 className="text-xl font-bold heading-font text-slate-900 uppercase tracking-widest border-b border-white/60 pb-3 mb-6">
                                {step === 1 ? 'Personal Profile' : step === 2 ? 'Burn Rate Audit' : step === 3 ? 'Asset Reservoirs' : 'Strategy Definition'}
                            </h2>

                            {step === 1 && (
                                <div className="space-y-6 text-left animate-in fade-in">
                                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                                        <InputField label="Name" value={profile.name} noNumbers onChange={v => setProfile({...profile, name: v})} placeholder="Enter Full Name" />
                                        <div className="hidden xl:flex items-center px-4">
                                             {profile.name && <p className="text-sm font-bold text-teal-700 tracking-tight animate-in fade-in">Hello {profile.name}, preparing strategy parameters...</p>}
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                                        <InputField label="Current Age" value={profile.age} isAge suffix="Yrs" onChange={v => setProfile({...profile, age: v})} fact={ageFact} />
                                        <InputField label="Retirement Age" value={profile.retireAge} isAge suffix="Yrs" onChange={v => setProfile({...profile, retireAge: v})} isError={profile.retireAge && Number(profile.retireAge) <= Number(profile.age)} />
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6 text-left">
                                        <InputField label="Monthly Net Salary" prefix="₹" value={profile.salary} type="number" onChange={v => setProfile({...profile, salary: v})} fact={getIncomeComment('salary', profile.salary)} />
                                        <InputField label="Monthly Business Income" prefix="₹" value={profile.businessIncome} type="number" onChange={v => setProfile({...profile, businessIncome: v})} fact={getIncomeComment('business', profile.businessIncome)} />
                                    </div>
                                    <div className="pt-6 border-t border-white/60 space-y-6 text-left max-w-3xl">
                                        <Toggle label="Are you married?" value={profile.married} onChange={v => setProfile({...profile, married: v, hasChildren: v ? profile.hasChildren : false})} fact={marriedComment} />
                                        {profile.married && (
                                            <div className="space-y-5 animate-in slide-in-from-top-2 text-left bg-white/30 backdrop-blur-md p-5 rounded-2xl border border-white/60 shadow-[0_4px_12px_-4px_rgba(0,0,0,0.05)]">
                                                <Toggle label="Do you have children?" value={profile.hasChildren} onChange={v => setProfile({...profile, hasChildren: v})} fact={childComment} />
                                                {profile.hasChildren && (
                                                    <div className="grid grid-cols-1 sm:grid-cols-2">
                                                        <InputField 
                                                            label="Number of children" 
                                                            value={profile.childCount} 
                                                            onChange={v => {
                                                                let num = parseInt(v) || 0;
                                                                if(num > 10) num = 10;
                                                                setProfile({...profile, childCount: num});
                                                            }} 
                                                            type="number"
                                                            maxLength={2} 
                                                        />
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {step === 2 && (
                                <div className="space-y-6 text-left animate-in fade-in">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6 text-left">
                                        <InputField label="Monthly Rent" prefix="₹" value={profile.rent} type="number" onChange={v => setProfile({...profile, rent: v})} />
                                        <InputField label="Monthly EMI" prefix="₹" value={profile.emi} type="number" onChange={v => setProfile({...profile, emi: v})} />
                                    </div>
                                    {safeNumber(profile.emi) > 0 && (
                                        <div className="animate-in slide-in-from-top-2 bg-white/30 backdrop-blur-md p-5 rounded-2xl border border-white/60 text-left shadow-[0_4px_12px_-4px_rgba(0,0,0,0.05)] space-y-5 max-w-3xl">
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                                <div>
                                                    <label className="text-xs font-bold text-slate-800 uppercase tracking-wider block mb-2 text-left">EMI End Year</label>
                                                    <select className="w-full premium-input outline-none py-2 px-3" value={profile.emiEndYear} onChange={e => setProfile({...profile, emiEndYear: e.target.value})}>
                                                        <option value="">Select Target Year</option>
                                                        {Array.from({length: 30}, (_, i) => new Date().getFullYear() + i).map(y => <option key={y} value={y}>{y}</option>)}
                                                    </select>
                                                </div>
                                                <InputField label="Total Loan Outstanding (Optional)" prefix="₹" value={profile.loanOutstanding} type="number" onChange={v => setProfile({...profile, loanOutstanding: v})} fact={{c: "Required for Debt Snowball optimization in the Blueprint."}} />
                                            </div>
                                        </div>
                                    )}
                                    <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                                        <InputField label="Monthly Household" prefix="₹" value={profile.household} type="number" onChange={v => setProfile({...profile, household: v})} />
                                        <InputField label="Monthly Lifestyle" prefix="₹" value={profile.lifestyle} type="number" onChange={v => setProfile({...profile, lifestyle: v})} />
                                        <InputField label="Annual Vacation" prefix="₹" value={profile.vacation} type="number" onChange={v => setProfile({...profile, vacation: v})} />
                                    </div>
                                    <div className="pt-6 border-t border-white/60 space-y-6 max-w-3xl">
                                        <Toggle label="Do you have an active health insurance policy?" value={profile.insuranceActive} onChange={v => setProfile({...profile, insuranceActive: v})} />
                                        {profile.insuranceActive && (
                                            <div className="space-y-6 animate-in zoom-in-95 text-left bg-white/30 backdrop-blur-md p-6 rounded-2xl border border-white/60 shadow-[0_4px_12px_-4px_rgba(0,0,0,0.05)]">
                                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                                    <InputField label="Existing Cover (Sum Assured)" prefix="₹" value={profile.existingHealthCover} type="number" onChange={v => setProfile({...profile, existingHealthCover: v})} />
                                                    <InputField label="Annual Premium Paid" prefix="₹" value={profile.healthPremium} type="number" onChange={v => setProfile({...profile, healthPremium: v})} />
                                                </div>
                                                <div className="grid grid-cols-1 sm:grid-cols-2">
                                                    <InputField label="Annual Life Premium (if any)" prefix="₹" value={profile.lifePremium} type="number" onChange={v => setProfile({...profile, lifePremium: v})} />
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {step === 3 && (
                                <div className="space-y-6 text-left animate-in fade-in">
                                    <div className="p-4 bg-white/40 backdrop-blur-md border border-white/60 rounded-xl mb-3 flex justify-between items-center shadow-[0_4px_12px_-4px_rgba(0,0,0,0.05)] max-w-3xl">
                                        <span className="text-xs font-bold uppercase text-slate-700 tracking-wider">Asset Return Framework</span>
                                        <span className="text-sm font-bold text-teal-700 tracking-wide">Strategic Mapping</span>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6 text-left">
                                        {ASSET_CLASSES_LIST.map(a => (
                                            <InputField key={a.id} label={a.label} prefix="₹" value={profile[a.id]} type="number" onChange={v => setProfile({...profile, [a.id]: v})} yieldBadge={a.yield} />
                                        ))}
                                    </div>
                                    <div className="space-y-4 pt-6 border-t border-white/60 text-left max-w-3xl">
                                        <h4 className="text-xs font-bold text-slate-800 uppercase tracking-widest mb-2">Custom Asset Reservoirs</h4>
                                        {(profile.customReservoirs || []).map((res, i) => (
                                            <div key={res.id} className="relative group text-left bg-white/40 backdrop-blur-md p-4 rounded-xl border border-white/60 shadow-[0_4px_16px_-4px_rgba(0,0,0,0.05)] grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4">
                                                <button onClick={() => { let r = [...(profile.customReservoirs||[])]; r.splice(i, 1); setProfile({...profile, customReservoirs: r}); }} className="absolute -top-2.5 -right-2.5 w-7 h-7 bg-rose-100/90 backdrop-blur-sm text-rose-600 hover:bg-rose-600 hover:text-white rounded-full text-xs font-black z-20 shadow-md transition-all flex items-center justify-center">✕</button>
                                                <InputField label="Asset Name" value={res.name} type="text" onChange={v => { let r = [...(profile.customReservoirs||[])]; r[i].name = v; setProfile({...profile, customReservoirs: r}); }} />
                                                <InputField label="Current Value" prefix="₹" value={res.value} type="text" onChange={v => { let r = [...(profile.customReservoirs||[])]; r[i].value = v; setProfile({...profile, customReservoirs: r}); }} />
                                            </div>
                                        ))}
                                        <button onClick={() => setProfile({...profile, customReservoirs: [...(profile.customReservoirs||[]), {id: Date.now(), name: "Custom Reservoir", value: ""}]})} className="w-full py-4 border-2 border-dashed border-white/60 rounded-xl text-xs font-bold uppercase text-slate-600 tracking-widest hover:border-teal-500 hover:text-teal-700 hover:bg-white/40 backdrop-blur-md transition-all shadow-[0_4px_16px_-4px_rgba(0,0,0,0.05)]">+ Add custom reservoir</button>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6 pt-6 border-t border-white/60 text-left">
                                        <InputField label="Current Monthly SIP" prefix="₹" value={profile.currentSip} type="number" onChange={v => setProfile({...profile, currentSip: v})} />
                                        <InputField label="SIP Step-up %" suffix="%" value={profile.sipStepUp} type="number" onChange={v => setProfile({...profile, sipStepUp: v})} />
                                    </div>
                                </div>
                            )}

                            {step === 4 && (
                                <div className="space-y-6 text-left animate-in fade-in">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6 text-left">
                                        <InputField label="Till what age you want to plan (Life Expectancy)" value={profile.horizonAge} isAge suffix="Yrs" onChange={v => setProfile({...profile, horizonAge: v})} isError={profile.horizonAge && Number(profile.horizonAge) <= Number(profile.retireAge)} />
                                    </div>
                                    
                                    {profile.hasChildren && (
                                        <div className="p-6 bg-white/30 backdrop-blur-md rounded-2xl border border-white/60 space-y-5 shadow-[0_4px_16px_-4px_rgba(0,0,0,0.05)] text-left max-w-4xl">
                                            <Toggle label="Do you want to add your child in this planning?" value={profile.childNodeActive} onChange={v => setProfile({...profile, childNodeActive: v})} />
                                            {profile.childNodeActive && (
                                                <div className="mt-5">
                                                    <p className="text-xs font-bold text-teal-700 uppercase tracking-widest mb-4">SELECT SPECIFIC MILESTONES TO ACTIVATE:</p>
                                                    {Array.from({length: Math.min(10, Math.max(1, Number(profile.childCount)||1))}).map((_, ci) => (
                                                    <div key={ci} className="space-y-4 pt-4 border-t border-white/60 text-left">
                                                        <div className="flex justify-between items-center text-left">
                                                            <span className="text-xs font-bold uppercase text-slate-800 tracking-wider">Child {ci+1} Age</span>
                                                            <input type="text" maxLength="2" className="w-14 premium-input py-2 text-center text-sm" value={profile.childAges[ci]||""} onChange={e => setProfile({...profile, childAges: {...profile.childAges, [ci]: e.target.value.replace(/[^0-9]/g, "")}})} />
                                                        </div>
                                                        {profile.childAges[ci] && (
                                                            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 text-left mt-3">
                                                                {CHILD_MILESTONES.map(m => {
                                                                    const yrsLeft = m.age - Number(profile.childAges[ci]);
                                                                    if(yrsLeft <= 0) return null;
                                                                    const mId = `c${ci}-${m.id}`;
                                                                    const active = profile.activeChildMilestones[mId];
                                                                    const mData = profile.childMilestoneData[mId] || { cost: m.defaultCost, inflation: m.defaultInflation || 10 };
                                                                    const fCost = mData.cost * Math.pow(1 + (mData.inflation / 100), yrsLeft);
                                                                    return (
                                                                        <div key={mId} className={`p-4 rounded-xl border transition-all ${active ? 'border-teal-600 bg-white/80 shadow-md scale-[1.02] ring-4 ring-teal-500/20' : 'border-white/60 bg-white/40 backdrop-blur-md hover:bg-white/60 cursor-pointer shadow-sm'} text-left relative overflow-hidden`} onClick={() => !active && setProfile({...profile, activeChildMilestones: {...profile.activeChildMilestones, [mId]: true}})}>
                                                                            {!active && <div className="absolute top-3 right-3 w-5 h-5 rounded-full bg-white/60 text-slate-600 flex items-center justify-center text-xs font-bold transition-colors group-hover:bg-slate-200 group-hover:text-slate-800">+</div>}
                                                                            
                                                                            <div className="flex justify-between items-start mb-3 text-left">
                                                                                <div className="space-y-1 text-left">
                                                                                    <p className="text-sm font-bold uppercase tracking-wider text-slate-900">{m.label}</p>
                                                                                    <p className="text-[10px] font-bold text-teal-800 bg-teal-50/80 backdrop-blur-sm px-2 py-0.5 rounded border border-teal-200 uppercase tracking-widest inline-block">{yrsLeft} Yrs Left</p>
                                                                                </div>
                                                                                {active && <div className="w-6 h-6 rounded-full flex items-center justify-center bg-teal-600 text-white cursor-pointer" onClick={(e) => { e.stopPropagation(); setProfile({...profile, activeChildMilestones: {...profile.activeChildMilestones, [mId]: false}}); }}><Icon name="x" size={14}/></div>}
                                                                            </div>
                                                                            {active && (
                                                                                <div className="space-y-4 pt-3 border-t border-white/50 animate-in fade-in text-left">
                                                                                    <InputField label="Cost Today" prefix="₹" value={mData.cost} type="number" onChange={v => setProfile({...profile, childMilestoneData: {...profile.childMilestoneData, [mId]: {...mData, cost: v}}})} />
                                                                                    <InputField label="Inflation" suffix="%" value={mData.inflation} type="number" onChange={v => setProfile({...profile, childMilestoneData: {...profile.childMilestoneData, [mId]: {...mData, inflation: v}}})} fact={{c: `Segmented Intelligence: Education inflates closer to ${m.defaultInflation || 10}%.`}} />
                                                                                    <div className="text-right pt-1 text-left">
                                                                                        <span className="text-[9px] font-bold uppercase text-slate-500 block mb-0.5 tracking-widest">Target Corpus</span>
                                                                                        <span className="text-base font-black text-teal-700">{formatCurrency(fCost)}</span>
                                                                                    </div>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    <div className="pt-6 border-t border-white/60 space-y-5 text-left">
                                        <p className="text-xs font-bold text-slate-800 uppercase tracking-widest mb-2">Target Strategy Suggestions</p>
                                        <div className="flex flex-wrap gap-2.5 mb-4 text-left">
                                            {SUGGESTED_GOALS.map(g => {
                                                const isSelected = profile.customGoals.some(cg => cg.name === g.name);
                                                return (
                                                    <button key={g.name} 
                                                        onClick={() => {
                                                            if (!isSelected) {
                                                                setProfile({...profile, customGoals: [...profile.customGoals, {id: Date.now()+Math.random(), ...g, inflation: 6}]});
                                                            }
                                                        }} 
                                                        disabled={isSelected}
                                                        className={`px-4 py-2 bg-white/40 backdrop-blur-md border border-white/60 rounded-lg text-[11px] font-bold shadow-sm hover:bg-white/80 transition-all flex items-center gap-2 ${isSelected ? 'ring-2 ring-teal-600 bg-teal-50/80 text-teal-900 border-transparent' : 'text-slate-700'}`}
                                                    >
                                                        {isSelected && <Icon name="check" size={14} className="text-teal-700"/>}
                                                        {!isSelected && "+"} {g.name}
                                                    </button>
                                                )
                                            })}
                                        </div>
                                        <button onClick={() => setProfile({...profile, customGoals: [...profile.customGoals, {id: Date.now(), name: "Custom Goal Asset", cost: "1000000", horizon: "10", inflation: 6}]})} className="w-full max-w-md py-4 border-2 border-dashed border-white/60 rounded-xl text-xs font-bold uppercase text-slate-600 hover:border-teal-500 hover:text-teal-700 transition-all shadow-sm bg-white/30 backdrop-blur-md">+ Create custom target reservoir</button>
                                        
                                        <div className="grid grid-cols-1 xl:grid-cols-2 gap-4 mt-4">
                                            {profile.customGoals.map((g, i) => (
                                                <div key={g.id} className="p-6 bg-white/60 backdrop-blur-2xl border border-white/80 rounded-[24px] relative shadow-[0_8px_30px_rgba(0,0,0,0.04)] text-left hover:shadow-[0_12px_40px_rgba(0,0,0,0.06)] transition-all duration-300">
                                                    <button onClick={() => { let gc = [...profile.customGoals]; gc.splice(i, 1); setProfile({...profile, customGoals: gc}); }} className="absolute top-5 right-5 text-rose-600 bg-rose-50/50 hover:bg-rose-600 hover:text-white p-2.5 rounded-full transition-all text-left shadow-sm border border-rose-100/50"><Icon name="trash-2" size={16}/></button>
                                                    <InputField label="Goal Designation" value={g.name} onChange={v => { let gc = [...profile.customGoals]; gc[i].name = v; setProfile({...profile, customGoals: gc}); }} />
                                                    <div className="mt-5 space-y-5 text-left pt-5 border-t border-slate-200/50">
                                                        <InputField label="Target Cost Today" prefix="₹" value={g.cost} type="number" onChange={v => { let gc = [...profile.customGoals]; gc[i].cost = v; setProfile({...profile, customGoals: gc}); }} />
                                                        <div className="grid grid-cols-2 gap-5">
                                                            <InputField label="Horizon" value={g.horizon} type="number" onChange={v => { let gc = [...profile.customGoals]; gc[i].horizon = v; setProfile({...profile, customGoals: gc}); }} suffix="Yrs" />
                                                            <InputField label="Inflation" value={g.inflation} type="number" onChange={v => { let gc = [...profile.customGoals]; gc[i].inflation = v; setProfile({...profile, customGoals: gc}); }} suffix="%" />
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Intelligence FinBar */}
                    {step < 5 && (
                        <div className="lg:col-span-4 xl:col-span-3 h-fit sticky top-6 no-print text-left">
                            <div className="premium-card p-5 space-y-5 text-left">
                                <div className="flex items-center gap-3 border-b border-white/60 pb-3">
                                    <div className="p-2 bg-slate-900 text-white rounded-lg shadow-md flex items-center justify-center"><Icon name="brain" size={16} /></div>
                                    <h3 className="text-[11px] font-bold uppercase tracking-[0.2em] text-slate-900">Intelligence FinBar</h3>
                                </div>
                                <div className="space-y-5">
                                    <div className="space-y-2">
                                        <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest px-1">Income</p>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="p-3 bg-white/40 backdrop-blur-md rounded-xl border border-white/60 shadow-sm"><p className="text-[9px] font-bold text-slate-500 uppercase mb-1">Monthly</p><p className="text-sm font-bold text-slate-900 leading-none"><AnimatedCurrency value={totals.income}/></p></div>
                                            <div className="p-3 bg-white/40 backdrop-blur-md rounded-xl border border-white/60 shadow-sm"><p className="text-[9px] font-bold text-slate-500 uppercase mb-1">Yearly</p><p className="text-sm font-bold text-slate-900 leading-none"><AnimatedCurrency value={totals.income * 12}/></p></div>
                                        </div>
                                    </div>
                                    <div className="space-y-2">
                                        <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest px-1">Expenses</p>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="p-3 bg-rose-50/60 backdrop-blur-md rounded-xl border border-rose-200/60 shadow-sm"><p className="text-[9px] font-bold text-rose-600 uppercase mb-1">Monthly</p><p className="text-sm font-bold text-rose-900 leading-none"><AnimatedCurrency value={totals.burn}/></p></div>
                                            <div className="p-3 bg-rose-50/60 backdrop-blur-md rounded-xl border border-rose-200/60 shadow-sm"><p className="text-[9px] font-bold text-rose-600 uppercase mb-1">Yearly</p><p className="text-sm font-bold text-rose-900 leading-none"><AnimatedCurrency value={totals.burn * 12}/></p></div>
                                        </div>
                                    </div>
                                    <div className="p-4 bg-slate-900 rounded-[20px] border border-slate-800 shadow-xl relative overflow-hidden">
                                        <div className="absolute top-0 right-0 w-24 h-24 bg-teal-500/20 blur-3xl rounded-full"></div>
                                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5 relative z-10">Net Worth</p>
                                        <p className="text-2xl font-black text-white tracking-tight relative z-10"><AnimatedCurrency value={totals.assets}/></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const SynthesisView = ({ profile, setProfile }) => {
            const [isWealthAllocated, setIsWealthAllocated] = useState(false);
            const [allocMap, setAllocMap] = useState({});
            const [localParams, setLocalParams] = useState({});
            const [expandedGoal, setExpandedGoal] = useState(null);
            const [expandedGoalYear, setExpandedGoalYear] = useState({ id: null, idx: null });
            const [expandedSimYear, setExpandedSimYear] = useState(null);
            const [showFullPreview, setShowFullPreview] = useState(false);
            const [isPresenting, setIsPresenting] = useState(false);
            const [currentSlide, setCurrentSlide] = useState(0);
            const [projectionTab, setProjectionTab] = useState('strategy'); 
            const [globalSimParams, setGlobalSimParams] = useState({ returns: 12, stepUp: 0, lumpsum: 0 });
            const [blueprintLayout, setBlueprintLayout] = useState('list'); // Default list 
            const [isAllocExpanded, setIsAllocExpanded] = useState(false);
            const [scenario, setScenario] = useState('base');
            const [showRealValue, setShowRealValue] = useState(false);
            const [showPostTax, setShowPostTax] = useState(false);
            const [isGeneratingPDF, setIsGeneratingPDF] = useState(false);
            const [inlineEdit, setInlineEdit] = useState({ id: null, cost: '' });
            
            const [isConsoleOpen, setIsConsoleOpen] = useState(false);
            const [burnTrim, setBurnTrim] = useState(0); 

            const totalAssets = useMemo(() => {
                const base = ASSET_CLASSES_LIST.reduce((a,c)=>a+safeNumber(profile[c.id]), 0);
                const custom = (profile.customReservoirs || []).reduce((a,c)=>a+safeNumber(c.value), 0);
                return base + custom;
            }, [profile]);

            const monthlyBurn = useMemo(() => {
                const trimFactor = 1 - (burnTrim / 100);
                const fix = safeNumber(profile.rent) + (safeNumber(profile.household) + safeNumber(profile.lifestyle)) * trimFactor + safeNumber(profile.emi);
                const ins = (safeNumber(profile.healthPremium) + safeNumber(profile.lifePremium)) / 12;
                return fix + ins + (safeNumber(profile.vacation)/12 * trimFactor);
            }, [profile, burnTrim]);

            const totals = useMemo(() => {
                const income = safeNumber(profile.salary) + safeNumber(profile.businessIncome);
                return { income, burn: monthlyBurn, assets: totalAssets };
            }, [profile.salary, profile.businessIncome, monthlyBurn, totalAssets]);
            
            const debtInsight = useMemo(() => {
                const out = safeNumber(profile.loanOutstanding);
                const emi = safeNumber(profile.emi);
                if(out <= 0 || emi <= 0) return null;
                
                const r = 0.09 / 12; // Assuming standard 9% home loan interest
                if(out * r >= emi) return null; 
                
                const monthsBase = -Math.log(1 - out*r/emi) / Math.log(1+r);
                const emiBump = emi * 1.2; // 20% bump
                const monthsBump = -Math.log(1 - out*r/emiBump) / Math.log(1+r);
                
                const totalPaidBase = monthsBase * emi;
                const totalPaidBump = monthsBump * emiBump;
                
                const interestSaved = totalPaidBase - totalPaidBump;
                const yearsSaved = (monthsBase - monthsBump) / 12;
                
                if(yearsSaved <= 0 || interestSaved <= 0) return null;
                
                return {
                    bumpAmount: emi * 0.2,
                    yearsSaved: yearsSaved.toFixed(1),
                    interestSaved: interestSaved
                };
            }, [profile.loanOutstanding, profile.emi]);

            const currentYear = new Date().getFullYear();
            const emiYearsLeft = Math.max(0, safeNumber(profile.emiEndYear) - currentYear);
            const retireYrs = Math.max(1, Math.min(100, safeNumber(profile.retireAge) - safeNumber(profile.age)));
            const planningHorizon = Math.max(1, Math.min(120, safeNumber(profile.horizonAge) - safeNumber(profile.age)));
            const retirementDuration = Math.max(1, Math.min(100, safeNumber(profile.horizonAge) - safeNumber(profile.retireAge)));
            
            const trimFactor = 1 - (burnTrim / 100);
            const monthlyBurnBase = safeNumber(profile.rent) + (safeNumber(profile.household) + safeNumber(profile.lifestyle)) * trimFactor;
            const monthlyInsVac = (safeNumber(profile.healthPremium) + safeNumber(profile.lifePremium)) / 12 + (safeNumber(profile.vacation)/12 * trimFactor);
            
            const inflatedBaseBurn = (monthlyBurnBase + monthlyInsVac) * Math.pow(1.06, retireYrs);
            const activeEmiAtRetirement = retireYrs < emiYearsLeft ? safeNumber(profile.emi) : 0;
            
            const futureLife = inflatedBaseBurn + activeEmiAtRetirement; 
            const retireCorpus = futureLife * 12 * retirementDuration; 
            
            const retirementSIP = useMemo(() => calculateStepUpSip(retireCorpus, retireYrs, 12, 0, 0), [retireCorpus, retireYrs]);

            const getScenarioReturn = (baseYield, yearIdx) => {
                const val = safeNumber(baseYield);
                if(scenario === 'bull') return val + 3;
                if(scenario === 'bear') {
                    if (yearIdx === 3) return Math.min(-15, val - 20); // Sequence of Returns Risk simulation
                    if (yearIdx === 4) return Math.min(-5, val - 15);
                    return Math.max(0, val - 3); // Bear market sluggish long-term drag
                }
                return val;
            };

            const plan = useMemo(() => {
                const goals = [{ id: "retire", name: "Retirement Strategy", target: retireCorpus, horizon: retireYrs, icon: "umbrella", inflation: 6, baseCost: (futureLife * 12 * retirementDuration) / Math.pow(1.06, retireYrs) }];
                if (profile.childNodeActive && profile.hasChildren) {
                    Object.keys(profile.activeChildMilestones).forEach(k => {
                        if(profile.activeChildMilestones[k]) {
                            const [cIdx, mId] = k.split("-");
                            const mData = profile.childMilestoneData[k] || { cost: CHILD_MILESTONES.find(x=>x.id===mId).defaultCost, inflation: CHILD_MILESTONES.find(x=>x.id===mId).defaultInflation || 10 };
                            const yrs = CHILD_MILESTONES.find(x=>x.id===mId).age - Number(profile.childAges[cIdx.replace('c','')]);
                            if (yrs > 0) goals.push({ id: k, name: `Child ${Number(cIdx.replace('c',''))+1} - ${CHILD_MILESTONES.find(x=>x.id===mId).label}`, target: mData.cost * Math.pow(1 + mData.inflation/100, yrs), horizon: Math.min(100, Math.max(1, yrs)), icon: "graduation-cap", inflation: mData.inflation, baseCost: mData.cost });
                        }
                    });
                }
                profile.customGoals.forEach(g => {
                    const hrz = Math.min(100, Math.max(1, safeNumber(g.horizon)));
                    goals.push({ id: g.id, name: g.name, target: safeNumber(g.cost) * Math.pow(1 + (safeNumber(g.inflation)||6)/100, hrz), horizon: hrz, icon: "target", inflation: g.inflation, baseCost: safeNumber(g.cost) });
                });
                
                return goals.map(g => {
                    const p = localParams[g.id] || { returns: globalSimParams.returns, stepUp: globalSimParams.stepUp, lumpsum: 0 };
                    let effectiveReturn = getScenarioReturn(p.returns, 1); // Baseline mapping
                    const allocPct = isWealthAllocated ? (safeNumber(allocMap[g.id])/100) : 0;
                    const allocAmt = totalAssets * allocPct;
                    const sip = calculateStepUpSip(g.target, g.horizon, effectiveReturn, p.stepUp, safeNumber(p.lumpsum) + allocAmt); 
                    return { ...g, ...p, returns: p.returns, sip, allocAmt, isEdited: !!localParams[g.id] };
                });
            }, [profile, retireCorpus, retireYrs, isWealthAllocated, allocMap, localParams, globalSimParams, totalAssets, scenario]);

            const totalSIPRequired = plan.reduce((sum, g) => sum + g.sip, 0);

            const portfolioWeightedReturn = useMemo(() => {
                let weightedSum = 0;
                let totalVal = 0;
                ASSET_CLASSES_LIST.forEach(a => {
                    const val = safeNumber(profile[a.id]);
                    if (val > 0) {
                        weightedSum += val * a.yield;
                        totalVal += val;
                    }
                });
                (profile.customReservoirs || []).forEach(res => {
                    const val = safeNumber(res.value);
                    if (val > 0) { weightedSum += val * 8; totalVal += val; }
                });
                return totalVal > 0 ? (weightedSum / totalVal) : 8;
            }, [profile]);

            const unallocatedData = useMemo(() => {
                if(!isWealthAllocated) return { type: 'unallocated', isFull: true, remaining: totalAssets };
                const totalAllocatedPct = Object.values(allocMap).reduce((a,b)=>a+safeNumber(b),0);
                return { remaining: totalAssets * ((100 - Math.min(100, totalAllocatedPct))/100), type: 'partial' };
            }, [totalAssets, allocMap, isWealthAllocated]);

            const legacyProjection = (years) => {
                if (unallocatedData.type === 'partial') return unallocatedData.remaining * Math.pow(1 + (getScenarioReturn(portfolioWeightedReturn, 1)/100), years);
                let totalProjected = 0;
                ASSET_CLASSES_LIST.forEach(asset => {
                    const p = safeNumber(profile[asset.id]);
                    if (p > 0) totalProjected += p * Math.pow(1 + (getScenarioReturn(asset.yield, 1) / 100), years);
                });
                (profile.customReservoirs || []).forEach(res => totalProjected += safeNumber(res.value) * Math.pow(1 + (getScenarioReturn(8, 1) / 100), years));
                return totalProjected === 0 && totalAssets === 0 ? 0 : totalProjected;
            };

            const masterSimulationData = useMemo(() => {
                let legacyBal = unallocatedData.type === 'partial' ? unallocatedData.remaining : totalAssets;
                
                let buckets = plan.map(g => ({
                    id: g.id, name: g.name, horizon: g.horizon,
                    bal: safeNumber(g.lumpsum) + safeNumber(g.allocAmt),
                    sip: g.sip, returnRateBase: g.returns,
                    stepUp: (g.stepUp || 0) / 100, target: g.target
                }));

                let yearlyData = [];
                let totalPrincipal = legacyBal + buckets.reduce((acc, b) => acc + b.bal, 0);

                for (let yr = 1; yr <= planningHorizon; yr++) {
                    const age = safeNumber(profile.age) + yr;
                    let yearSip = 0, yearGrowth = 0, yearRedemptions = 0;
                    let redemptionNames = [];
                    let monthlyFlows = Array.from({length: 12}).map((_, i) => ({ m: i+1, opening: 0, sip: 0, growth: 0, withdrawal: 0, closing: 0 }));

                    let legacyReturn = getScenarioReturn(portfolioWeightedReturn, yr) / 100;
                    buckets.forEach(b => {
                        b.currentReturnRate = getScenarioReturn(b.returnRateBase, yr) / 100;
                    });

                    const isRetirementPhase = age > safeNumber(profile.retireAge);
                    const currentRetirementYear = yr - retireYrs; 
                    
                    let yearlyFreedomPaycheck = 0;
                    if (isRetirementPhase && currentRetirementYear > 0) {
                        yearlyFreedomPaycheck = (futureLife * 12) * Math.pow(1.06, currentRetirementYear - 1); 
                        // Mark as a Paycheck outflow for redemptions display
                        redemptionNames.push("Freedom Paycheck");
                    }
                    const monthlyFreedomPaycheck = yearlyFreedomPaycheck / 12;

                    for (let m = 0; m < 12; m++) {
                        let monthOpening = legacyBal + buckets.reduce((acc, b) => acc + b.bal, 0);
                        let monthSip = 0, monthGrowth = 0, monthWithdrawal = 0;

                        // 1. Growth
                        if (legacyBal > 0) {
                            let legGrowth = legacyBal * (Math.pow(1 + legacyReturn, 1/12) - 1);
                            legacyBal += legGrowth; monthGrowth += legGrowth;
                        }

                        buckets.forEach(b => {
                            if (b.bal > 0) {
                                let bGrowth = b.bal * (Math.pow(1 + b.currentReturnRate, 1/12) - 1);
                                b.bal += bGrowth; monthGrowth += bGrowth;
                            }
                            if (yr <= b.horizon) { b.bal += b.sip; monthSip += b.sip; }
                        });

                        // 2. Withdrawals at End of specific goals
                        if (m === 11) {
                            buckets.forEach(b => {
                                if (yr === b.horizon && b.id !== 'retire') {
                                    let wAmt = b.bal; 
                                    b.bal = 0;
                                    yearRedemptions += wAmt;
                                    monthWithdrawal += wAmt;
                                    redemptionNames.push(b.name);
                                }
                            });
                        }

                        // 3. Retirement Paycheck Outflows (Show monthly and add to annual)
                        if (isRetirementPhase && currentRetirementYear > 0) {
                            let remainingToWithdraw = monthlyFreedomPaycheck;
                            let actualWithdrawnThisMonth = 0;
                            
                            let rB = buckets.find(x => x.id === 'retire');
                            if (rB && rB.bal > 0) {
                                if (rB.bal >= remainingToWithdraw) { 
                                    rB.bal -= remainingToWithdraw; 
                                    actualWithdrawnThisMonth += remainingToWithdraw;
                                    remainingToWithdraw = 0; 
                                } else { 
                                    actualWithdrawnThisMonth += rB.bal;
                                    remainingToWithdraw -= rB.bal; 
                                    rB.bal = 0; 
                                }
                            }
                            
                            if (remainingToWithdraw > 0 && legacyBal > 0) {
                                if (legacyBal >= remainingToWithdraw) {
                                    legacyBal -= remainingToWithdraw;
                                    actualWithdrawnThisMonth += remainingToWithdraw;
                                } else {
                                    actualWithdrawnThisMonth += legacyBal;
                                    legacyBal = 0;
                                }
                            }
                            
                            monthWithdrawal += actualWithdrawnThisMonth;
                            yearRedemptions += actualWithdrawnThisMonth;
                        }

                        let monthClosing = legacyBal + buckets.reduce((acc, b) => acc + b.bal, 0);
                        monthlyFlows[m] = { m: m + 1, opening: monthOpening, sip: monthSip, growth: monthGrowth, withdrawal: monthWithdrawal, closing: Math.max(0, monthClosing) };
                        yearSip += monthSip; yearGrowth += monthGrowth;
                    }

                    buckets.forEach(b => { if (yr < b.horizon) b.sip *= (1 + b.stepUp); });
                    
                    totalPrincipal += yearSip;
                    totalPrincipal -= yearRedemptions;
                    if (totalPrincipal < 0) totalPrincipal = 0;

                    yearlyData.push({
                        yr, age, sip: yearSip, growth: yearGrowth, withdrawals: yearRedemptions,
                        withdrawalNames: [...new Set(redemptionNames)], 
                        closing: Math.max(0, legacyBal + buckets.reduce((acc, b) => acc + b.bal, 0)),
                        totalPrincipal,
                        monthlyFlows,
                        monthlyFreedomPaycheck: monthlyFreedomPaycheck // Stored for display in redemption detail
                    });
                }
                return yearlyData;
            }, [plan, planningHorizon, profile, unallocatedData, totalAssets, portfolioWeightedReturn, scenario, futureLife, retireYrs]);

            // PM World Class Features Calculations
            const freeCashflow = totals.income - monthlyBurn - totalSIPRequired;
            const freeCashflowPct = totals.income > 0 ? (freeCashflow / totals.income) * 100 : 0;
            
            // --- INJECTED PM FEATURE: STRATEGY HEALTH SCORE ---
            const strategyHealthScore = useMemo(() => {
                let score = 0;
                const sipGapPct = totalSIPRequired > 0 ? (safeNumber(profile.currentSip) / totalSIPRequired) : 1;
                score += Math.min(40, sipGapPct * 40); // Max 40 for execution

                const insuranceScore = profile.insuranceActive ? (safeNumber(profile.existingHealthCover) >= 1500000 ? 15 : 7) : 0;
                const emgFundScore = totalAssets >= (monthlyBurn * 6) ? 15 : (totalAssets >= monthlyBurn * 3 ? 7 : 0);
                score += (insuranceScore + emgFundScore); // Max 30 for protection

                const allocationScore = isWealthAllocated ? 30 : 15; // Max 30 for efficiency
                score += allocationScore;

                return Math.round(score);
            }, [totalSIPRequired, profile, totalAssets, monthlyBurn, isWealthAllocated]);
            // --------------------------------------------------

            const rCoast = portfolioWeightedReturn / 100;
            let coastYears = 0;
            if (totalAssets > 0 && rCoast > 0 && retireCorpus > totalAssets) {
                coastYears = Math.log(retireCorpus / totalAssets) / Math.log(1 + rCoast);
            }
            const coastAge = coastYears > 0 ? Math.round(safeNumber(profile.age) + coastYears) : null;
            const projectedIncome = totals.income * Math.pow(1.08, retireYrs); // Assuming 8% career growth
            
            const crossoverData = useMemo(() => {
                if(safeNumber(profile.loanOutstanding) <= 0 || safeNumber(profile.emi) <= 0) return null;
                let bal = safeNumber(profile.loanOutstanding);
                let emi = safeNumber(profile.emi);
                let r = 0.09/12; // 9% assumed home loan
                
                for(let i=0; i<masterSimulationData.length; i++) {
                    let row = masterSimulationData[i];
                    for(let m=0; m<12; m++) {
                        bal = bal + (bal*r) - emi;
                        if(bal < 0) bal = 0;
                    }
                    if(row.closing > bal) {
                        return { age: row.age, year: row.yr };
                    }
                }
                return null;
            }, [profile.loanOutstanding, profile.emi, masterSimulationData]);

            const getGoalFlow = (g) => {
                const flow = [];
                let curVal = safeNumber(g.lumpsum) + safeNumber(g.allocAmt);
                let curSip = g.sip;
                const monthlyRate = (g.returns / 100) / 12;
                const stepUpRate = (g.stepUp || 0) / 100;
                for (let y = 1; y <= Math.max(g.horizon, planningHorizon); y++) { 
                    const months = []; let opening = curVal; let yearSip = 0;
                    for (let m = 1; m <= 12; m++) {
                        let investAmount = (((y-1)*12) + m <= g.horizon * 12) ? curSip : 0;
                        const interest = (opening + investAmount) * monthlyRate;
                        const closing = opening + investAmount + interest;
                        months.push({ m, opening, sip: investAmount, interest, closing });
                        opening = closing; yearSip += investAmount;
                    }
                    if (y < g.horizon) curSip *= (1 + stepUpRate);
                    flow.push({ y, age: safeNumber(profile.age) + y, sip: yearSip, balance: opening, months });
                    curVal = opening;
                }
                return flow;
            };

            const downloadCSV = () => {
                let csv = `Client Name,${profile.name || "Valued Client"}\nAdvisor Name,${profile.advisorName || "BABA Advisor"}\nDate,${new Date().toLocaleDateString()}\n\n`;
                csv += "Master Strategy Projection (Annual Summary)\n";
                csv += "Year,Age,Annual SIP Flow,Market Growth,Redemptions/Outflows,Closing Corpus\n";
                masterSimulationData.forEach(row => {
                    csv += `${row.yr},${row.age},${row.sip.toFixed(0)},${row.growth.toFixed(0)},${row.withdrawals.toFixed(0)},${row.closing.toFixed(0)}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Blueprint_Master_${profile.name || "Client"}.csv`; link.click();
            };

            const healthAnalysis = useMemo(() => {
                const existingCover = safeNumber(profile.existingHealthCover);
                const recommendedCover = 1500000;
                return { existing: existingCover, recommended: recommendedCover, isAdequate: existingCover >= recommendedCover, shortfall: Math.max(0, recommendedCover - existingCover) };
            }, [profile.existingHealthCover]);
            
            const verdict = useMemo(() => {
                const sipGap = totalSIPRequired - safeNumber(profile.currentSip);
                if (sipGap <= 0) return { title: "Thriving", color: "text-emerald-700", desc: "You are on a golden path. Your current pace exceeds your future needs." };
                if (sipGap < 10000) return { title: "Stable", color: "text-indigo-700", desc: "You are close. A small optimization in spending can bridge this gap." };
                return { title: "Action Required", color: "text-rose-700", desc: "Significant gap detected. Immediate strategy recalibration is needed." };
            }, [totalSIPRequired, profile.currentSip]);

            const scrollRef = useRef(null);
            useEffect(() => { if (showFullPreview && scrollRef.current) scrollRef.current.scrollTo(0,0); }, [showFullPreview]);

            const handleQuickDelete = (e, gId) => {
                e.stopPropagation();
                if (gId === 'retire') return;
                if (String(gId).startsWith('c')) {
                    setProfile(p => ({ ...p, activeChildMilestones: { ...p.activeChildMilestones, [gId]: false } }));
                } else {
                    setProfile(p => ({ ...p, customGoals: p.customGoals.filter(cg => cg.id !== gId) }));
                }
            };

            const handleStartEdit = (e, g) => {
                e.stopPropagation();
                if (g.id === 'retire') return;
                setInlineEdit({ id: g.id, cost: g.baseCost });
            };

            const handleSaveEdit = (e) => {
                e.stopPropagation();
                if (!inlineEdit.id) return;
                const newCost = safeNumber(inlineEdit.cost);
                if (String(inlineEdit.id).startsWith('c')) {
                    const mId = inlineEdit.id.split('-')[1];
                    const existingData = profile.childMilestoneData[inlineEdit.id] || { 
                        cost: CHILD_MILESTONES.find(x=>x.id===mId)?.defaultCost || 0, 
                        inflation: CHILD_MILESTONES.find(x=>x.id===mId)?.defaultInflation || 10 
                    };
                    setProfile(p => ({
                        ...p,
                        childMilestoneData: {
                            ...p.childMilestoneData,
                            [inlineEdit.id]: { ...existingData, cost: newCost }
                        }
                    }));
                } else {
                    setProfile(p => ({
                        ...p,
                        customGoals: p.customGoals.map(cg => cg.id === inlineEdit.id ? { ...cg, cost: newCost } : cg)
                    }));
                }
                setInlineEdit({ id: null, cost: '' });
            };

            const updateGoalParams = (id, field, val) => {
                setLocalParams(prev => ({
                    ...prev,
                    [id]: { ...(prev[id] || { returns: globalSimParams.returns, stepUp: globalSimParams.stepUp, lumpsum: 0 }), [field]: safeNumber(val) }
                }));
            };

            const handleAllocChange = (gId, val) => {
                let currentTotal = 0;
                Object.keys(allocMap).forEach(k => { if(k !== gId) currentTotal += safeNumber(allocMap[k]); });
                let newVal = safeNumber(val);
                if (currentTotal + newVal > 100) newVal = 100 - currentTotal;
                setAllocMap(prev => ({ ...prev, [gId]: newVal }));
            };

            const handlePrint = () => {
                setIsGeneratingPDF(true);
                // Pause background GPU thrashing immediately so html2canvas doesn't glitch out
                const parallax = document.querySelector('.parallax-wrapper');
                if(parallax) parallax.style.display = 'none';

                setTimeout(() => {
                    const element = document.getElementById('blueprint-root');
                    
                    const noPrintElements = document.querySelectorAll('.no-print');
                    noPrintElements.forEach(el => {
                        el.setAttribute('data-original-display', el.style.display || '');
                        el.style.display = 'none';
                    });

                    element.classList.add('pdf-export-mode');

                    if (window.html2pdf) {
                        const opt = {
                            margin:       10,
                            filename:     `Financial_Blueprint_${profile.name || 'Client'}.pdf`,
                            image:        { type: 'jpeg', quality: 0.98 },
                            html2canvas:  { scale: 2, useCORS: true, logging: false },
                            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
                        };
                        
                        html2pdf().set(opt).from(element).save().then(() => {
                            noPrintElements.forEach(el => el.style.display = el.getAttribute('data-original-display'));
                            element.classList.remove('pdf-export-mode');
                            setIsGeneratingPDF(false);
                            if(parallax) parallax.style.display = '';
                        }).catch(err => {
                            console.error("PDF Generation failed", err);
                            noPrintElements.forEach(el => el.style.display = el.getAttribute('data-original-display'));
                            element.classList.remove('pdf-export-mode');
                            setIsGeneratingPDF(false);
                            if(parallax) parallax.style.display = '';
                            window.print();
                        });
                    } else {
                        window.print();
                        setTimeout(() => {
                            noPrintElements.forEach(el => el.style.display = el.getAttribute('data-original-display'));
                            element.classList.remove('pdf-export-mode');
                            setIsGeneratingPDF(false);
                            if(parallax) parallax.style.display = '';
                        }, 1000);
                    }
                }, 300);
            };
            
            const handleShare = (method) => {
                const advisor = profile.advisorName || 'your Advisor';
                const client = profile.name || 'Valued Client';
                
                let msg = `Hello ${client},\n\nI am ${advisor}. It was a pleasure discussing your financial roadmap today. As promised, here is the executive summary of your Strategic Wealth Blueprint:\n\n`;
                
                msg += `📊 CURRENT FINANCIAL BASELINE\n`;
                msg += `• Current Age: ${profile.age} Years\n`;
                msg += `• Target Retirement Age: ${profile.retireAge} Years\n`;
                msg += `• Monthly Income: ${formatCurrency(totals.income)}\n`;
                msg += `• Monthly Lifestyle Burn: ${formatCurrency(monthlyBurn)}\n`;
                msg += `• Current Liquid Assets: ${formatCurrency(totalAssets)}\n`;
                if (safeNumber(profile.emi) > 0) msg += `• Monthly EMI: ${formatCurrency(profile.emi)} (Ends ${profile.emiEndYear})\n`;
                
                msg += `\n🎯 STRATEGIC GOALS & EXECUTION LEDGER\n`;
                msg += `1. Retirement Freedom Corpus\n   - Target: ${formatCurrency(retireCorpus)}\n   - Required SIP: ${formatCurrency(retirementSIP)}/mo\n`;
                
                let counter = 2;
                plan.forEach(g => {
                    if (g.id !== 'retire') {
                        msg += `${counter}. ${g.name}\n   - Target: ${formatCurrency(g.target)} (in ${g.horizon} Years)\n   - Required SIP: ${formatCurrency(g.sip)}/mo\n`;
                        counter++;
                    }
                });
                
                msg += `\n💡 STRATEGY SYNTHESIS\n`;
                msg += `• Total Monthly Investment (SIP) Needed: ${formatCurrency(totalSIPRequired)}\n`;
                msg += `• Current Monthly SIP: ${formatCurrency(profile.currentSip)}\n`;
                const gap = totalSIPRequired - safeNumber(profile.currentSip);
                if (gap > 0) {
                    msg += `• Action Required: We need to bridge an investment gap of ${formatCurrency(gap)}/mo to secure these goals.\n`;
                } else {
                    msg += `• Status: Thriving. Your current investments meet your future requirements!\n`;
                }
                
                msg += `\n🛡️ RISK & PROTECTION SHIELD\n`;
                msg += `• Recommended Health Cover: ${formatCurrency(healthAnalysis.recommended)}\n`;
                msg += `• Recommended Term Life Cover: ${formatCurrency(totals.income * 12 * 20)}\n`;
                
                msg += `\nLet's connect soon to put this blueprint into action and start your compounding engine.\n\nBest Regards,\n${advisor}`;
                
                if (method === 'whatsapp') {
                    const encodedText = encodeURIComponent(msg);
                    window.open(`https://wa.me/?text=${encodedText}`, '_blank');
                } else if (method === 'mail') {
                    const subject = encodeURIComponent(`Your Financial Strategy Blueprint - ${client}`);
                    const body = encodeURIComponent(msg);
                    window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
                }
            };

            const renderPresentationSlide = () => {
                if (currentSlide === 0) {
                    return (
                        <div className="flex flex-col items-center justify-center h-full space-y-12 animate-in slide-in-from-right fade-in duration-500 w-full max-w-7xl mx-auto px-8">
                            <div className="text-center">
                                <h2 className="text-5xl font-black heading-font text-white uppercase tracking-widest mb-4">Financial Baseline</h2>
                                <p className="text-teal-400 font-bold text-xl">The starting coordinates for {profile.name || 'your'} master plan.</p>
                                <div className={`mt-8 inline-block px-8 py-3 rounded-full border ${verdict.title === 'Action Required' ? 'bg-rose-500/20 border-rose-500/50 text-rose-300' : 'bg-emerald-500/20 border-emerald-500/50 text-emerald-300'} font-bold uppercase tracking-widest text-sm shadow-xl`}>
                                    Status: {verdict.title}
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-8 w-full">
                                <div className="p-10 premium-card bg-white/10 border-white/20 text-center rounded-[40px] backdrop-blur-md">
                                    <Icon name="trending-up" size={48} className="mx-auto text-emerald-400 mb-6"/>
                                    <p className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-2">Monthly Income</p>
                                    <p className="text-5xl font-black text-white"><AnimatedCurrency value={totals.income} /></p>
                                </div>
                                <div className="p-10 premium-card bg-white/10 border-white/20 text-center rounded-[40px] backdrop-blur-md">
                                    <Icon name="flame" size={48} className="mx-auto text-rose-400 mb-6"/>
                                    <p className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-2">Monthly Burn</p>
                                    <p className="text-5xl font-black text-white"><AnimatedCurrency value={monthlyBurn} /></p>
                                </div>
                                <div className="p-10 premium-card bg-white/10 border-white/20 text-center rounded-[40px] backdrop-blur-md">
                                    <Icon name="landmark" size={48} className="mx-auto text-indigo-400 mb-6"/>
                                    <p className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-2">Existing Assets</p>
                                    <p className="text-5xl font-black text-white"><AnimatedCurrency value={totalAssets} /></p>
                                </div>
                            </div>
                        </div>
                    );
                } else if (currentSlide === 1) {
                    return (
                        <div className="flex flex-col items-center justify-center h-full space-y-12 animate-in slide-in-from-right fade-in duration-500 w-full max-w-7xl mx-auto px-8">
                            <div className="text-center">
                                <h2 className="text-5xl font-black heading-font text-white uppercase tracking-widest mb-4">The Retirement Reality</h2>
                                <p className="text-rose-400 font-bold text-xl">Combating the silent thief of inflation.</p>
                            </div>
                            <div className="flex flex-col md:flex-row items-center gap-12 w-full bg-white/5 p-12 rounded-[48px] border border-white/10 backdrop-blur-md">
                                <div className="flex-1 space-y-8 pl-8">
                                    <div>
                                        <p className="text-sm font-bold text-slate-400 uppercase tracking-widest">Current Lifestyle Cost</p>
                                        <p className="text-4xl font-bold text-white mt-2"><AnimatedCurrency value={monthlyBurnBase + monthlyInsVac} /> <span className="text-xl text-slate-500">/ mo</span></p>
                                    </div>
                                    <div className="border-l-4 border-rose-500 pl-6 py-2">
                                        <p className="text-sm font-bold text-rose-400 uppercase tracking-widest">Cost in {retireYrs} Years (@ 6% Inflation)</p>
                                        <p className="text-5xl font-black text-rose-100 mt-2"><AnimatedCurrency value={futureLife} /> <span className="text-xl text-rose-900/50">/ mo</span></p>
                                    </div>
                                </div>
                                <div className="flex-1 bg-slate-900/80 p-12 rounded-[40px] border border-teal-500/30 text-center shadow-[0_0_50px_rgba(20,184,166,0.15)] relative overflow-hidden">
                                    <div className="absolute top-0 right-0 bg-teal-500 text-white text-xs font-bold px-4 py-1 rounded-bl-xl uppercase tracking-widest">Target Corpus</div>
                                    <Icon name="database" size={48} className="mx-auto text-teal-400 mb-6"/>
                                    <p className="text-sm font-bold text-teal-100 uppercase tracking-widest mb-4">Freedom Number</p>
                                    <p className="text-6xl font-black text-teal-400"><AnimatedCurrency value={retireCorpus} /></p>
                                    <p className="text-sm text-slate-400 mt-6 font-bold">Funds {retirementDuration} years of post-retirement life.</p>
                                </div>
                            </div>
                        </div>
                    );
                } else if (currentSlide === 2) {
                    return (
                        <div className="flex flex-col items-center justify-center h-full space-y-12 animate-in slide-in-from-right fade-in duration-500 w-full px-8 max-w-7xl mx-auto">
                            <div className="text-center">
                                <h2 className="text-5xl font-black heading-font text-white uppercase tracking-widest mb-4">Risk & Shield</h2>
                                <p className="text-indigo-400 font-bold text-xl">The floor that prevents financial ruin.</p>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-8 w-full">
                                <div className="p-10 premium-card bg-white/5 border-white/10 rounded-[40px] text-center backdrop-blur-md">
                                    <Icon name="briefcase" size={32} className="mx-auto text-amber-400 mb-6"/>
                                    <p className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-2">Emergency Reserve</p>
                                    <p className="text-4xl font-black text-white mt-4"><AnimatedCurrency value={monthlyBurn * 6} /></p>
                                    <p className="text-xs text-slate-400 mt-4 leading-relaxed font-bold bg-white/5 p-3 rounded-xl border border-white/10">6x Monthly Burn. Keep strictly in liquid Cash or FDs.</p>
                                </div>
                                <div className="p-10 premium-card bg-white/5 border-white/10 rounded-[40px] relative text-center backdrop-blur-md">
                                    <Icon name="activity" size={32} className="mx-auto text-rose-400 mb-6"/>
                                    <p className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-2">Health Shield Status</p>
                                    <div className="mt-4 mb-6 text-sm">
                                        <p className="text-slate-300 mb-1">Existing: <span className="text-white font-bold"><AnimatedCurrency value={healthAnalysis.existing} /></span></p>
                                        <p className="text-slate-300">Required: <span className="text-white font-bold"><AnimatedCurrency value={healthAnalysis.recommended} /></span></p>
                                    </div>
                                    {healthAnalysis.isAdequate ? 
                                        <p className="text-emerald-400 font-bold bg-emerald-500/10 p-3 rounded-xl border border-emerald-500/20 text-sm">✅ Adequate Coverage</p> : 
                                        <p className="text-rose-400 font-bold bg-rose-500/10 p-3 rounded-xl border border-rose-500/20 text-sm">⚠️ Shortfall: {formatCurrency(healthAnalysis.shortfall)}</p>
                                    }
                                </div>
                                <div className="p-10 premium-card bg-white/5 border-white/10 rounded-[40px] text-center backdrop-blur-md">
                                    <Icon name="shield" size={32} className="mx-auto text-emerald-400 mb-6"/>
                                    <p className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-2">Income Replacement</p>
                                    <p className="text-4xl font-black text-white mt-4"><AnimatedCurrency value={totals.income * 12 * 20} /></p>
                                    <p className="text-xs text-slate-400 mt-4 leading-relaxed font-bold bg-white/5 p-3 rounded-xl border border-white/10">Term Life cover = 20x annual income. Secures family instantly.</p>
                                </div>
                            </div>
                        </div>
                    );
                } else if (currentSlide === 3) {
                    return (
                        <div className="flex flex-col items-center justify-center h-full space-y-12 animate-in slide-in-from-right fade-in duration-500 w-full max-w-6xl mx-auto px-8">
                            <div className="text-center w-full">
                                <h2 className="text-5xl font-black heading-font text-white uppercase tracking-widest mb-4">Wealth Allocation</h2>
                                <p className="text-amber-400 font-bold text-xl">Putting your {formatCurrency(totalAssets)} to work.</p>
                            </div>
                            <div className="flex flex-col md:flex-row gap-8 w-full">
                                <div className="flex-1 p-10 premium-card bg-white/10 border-white/20 rounded-[40px] text-center backdrop-blur-md">
                                    <Icon name="layers" size={48} className="mx-auto text-amber-400 mb-6"/>
                                    <p className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-2">Goal Linked Assets</p>
                                    <p className="text-5xl font-black text-white"><AnimatedCurrency value={totalAssets - unallocatedData.remaining} /></p>
                                    <p className="text-sm text-slate-400 mt-4 font-bold">Assigned to accelerate {Object.keys(allocMap).filter(k => safeNumber(allocMap[k]) > 0).length} specific goals.</p>
                                </div>
                                <div className="flex-1 p-10 bg-slate-900/80 border border-amber-500/30 rounded-[40px] text-center shadow-[0_0_50px_rgba(245,158,11,0.15)] relative overflow-hidden backdrop-blur-md">
                                    <div className="absolute top-0 right-0 bg-amber-500 text-white text-xs font-bold px-4 py-1 rounded-bl-xl uppercase tracking-widest">Compounding</div>
                                    <Icon name="rocket" size={48} className="mx-auto text-amber-400 mb-6"/>
                                    <p className="text-sm font-bold text-amber-100 uppercase tracking-widest mb-2">Legacy Pot (Unallocated)</p>
                                    <p className="text-5xl font-black text-amber-400"><AnimatedCurrency value={unallocatedData.remaining} /></p>
                                    <p className="text-sm text-slate-400 mt-4 font-bold">Growing autonomously at {portfolioWeightedReturn.toFixed(1)}%</p>
                                </div>
                            </div>
                        </div>
                    );
                } else if (currentSlide === 4) {
                    return (
                        <div className="flex flex-col items-center justify-center h-full space-y-12 animate-in slide-in-from-right fade-in duration-500 w-full max-w-7xl mx-auto px-8">
                            <div className="text-center w-full">
                                <h2 className="text-5xl font-black heading-font text-white uppercase tracking-widest mb-4">Execution Strategy</h2>
                                <p className="text-teal-400 font-bold text-xl">The exact math to manifest your goals.</p>
                            </div>
                            <div className="flex w-full gap-8">
                                <div className="w-1/3 flex flex-col gap-6">
                                    <div className="p-8 bg-white/10 border border-white/20 rounded-[32px] backdrop-blur-md">
                                        <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Total Monthly SIP Needed</p>
                                        <p className="text-4xl font-black text-teal-400"><AnimatedCurrency value={totalSIPRequired} /></p>
                                    </div>
                                    <div className="p-8 bg-white/5 border border-white/10 rounded-[32px] backdrop-blur-md">
                                        <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Current Investments</p>
                                        <p className="text-3xl font-black text-white"><AnimatedCurrency value={profile.currentSip} /></p>
                                    </div>
                                    <div className={`p-8 rounded-[32px] border backdrop-blur-md ${totalSIPRequired > safeNumber(profile.currentSip) ? 'bg-rose-500/10 border-rose-500/30' : 'bg-emerald-500/10 border-emerald-500/30'}`}>
                                        <p className="text-xs font-bold text-white/50 uppercase tracking-widest mb-2">Execution Gap</p>
                                        <p className={`text-3xl font-black flex items-center gap-2 ${totalSIPRequired > safeNumber(profile.currentSip) ? 'text-rose-400' : 'text-emerald-400'}`}>
                                            {totalSIPRequired > safeNumber(profile.currentSip) ? <React.Fragment><AnimatedCurrency value={totalSIPRequired - safeNumber(profile.currentSip)} /> <span className="text-lg">Short</span></React.Fragment> : 'Fully Funded!'}
                                        </p>
                                    </div>
                                </div>
                                <div className="w-2/3 max-h-[500px] overflow-y-auto pr-4 custom-scrollbar">
                                    <div className="space-y-4">
                                        {plan.map(g => (
                                            <div key={g.id} className="flex justify-between items-center p-6 bg-white/5 border border-white/10 rounded-[24px] hover:bg-white/10 transition-colors backdrop-blur-md">
                                                <div>
                                                    <p className="text-lg font-bold text-white">{g.name}</p>
                                                    <p className="text-sm text-slate-400 mt-1">Target: {formatCurrency(g.target)} in {g.horizon} Yrs</p>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-xs font-bold uppercase text-teal-400 tracking-widest">SIP</p>
                                                    <p className="text-2xl font-black text-white"><AnimatedCurrency value={g.sip} /></p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                } else if (currentSlide === 5) {
                    const finalSim = masterSimulationData[masterSimulationData.length - 1];
                    const totalSipInvested = masterSimulationData.reduce((acc, row) => acc + row.sip, 0);
                    const totalCapitalDeployed = totalAssets + totalSipInvested;
                    
                    return (
                        <div className="flex flex-col items-center justify-center h-full space-y-12 animate-in slide-in-from-right fade-in duration-500 w-full max-w-7xl mx-auto px-8">
                            <div className="text-center w-full">
                                <h2 className="text-5xl font-black heading-font text-white uppercase tracking-widest mb-4">The Quantum Trajectory</h2>
                                <p className="text-purple-400 font-bold text-xl">Your financial destiny at Age {profile.horizonAge}.</p>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-5xl">
                                <div className="p-10 premium-card bg-white/5 border-white/10 rounded-[40px] relative text-center backdrop-blur-md">
                                    <Icon name="piggy-bank" size={48} className="mx-auto text-purple-400 mb-6"/>
                                    <p className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-2">Lifetime Capital Deployed</p>
                                    <p className="text-5xl font-black text-white"><AnimatedCurrency value={totalCapitalDeployed} /></p>
                                    <p className="text-xs text-slate-400 mt-4 leading-relaxed font-bold bg-white/5 p-3 rounded-xl border border-white/10">Existing Assets + Lifetime SIP Flow.</p>
                                </div>
                                <div className="p-10 premium-card bg-purple-900/20 border-purple-500/30 rounded-[40px] text-center shadow-[0_0_50px_rgba(168,85,247,0.15)] relative backdrop-blur-md">
                                    <Icon name="globe" size={48} className="mx-auto text-purple-400 mb-6"/>
                                    <p className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-2">Terminal Wealth (Closing Corpus)</p>
                                    <p className="text-6xl font-black text-purple-400"><AnimatedCurrency value={finalSim?.closing || 0} /></p>
                                    {finalSim?.closing === 0 ? 
                                        <p className="text-rose-400 mt-4 font-bold animate-pulse text-base">Corpus depleted before horizon. Adjust strategy.</p> :
                                        <p className="text-sm text-purple-300/50 mt-4 leading-relaxed font-bold bg-purple-500/10 p-3 rounded-xl border border-purple-500/20">Legacy to pass onto the next generation.</p>
                                    }
                                </div>
                            </div>
                        </div>
                    );
                }
            };

            return (
                <div id="blueprint-root" className={`w-full mx-auto transition-all duration-500 ${blueprintLayout === 'list' ? 'max-w-[1600px] flex flex-col gap-8' : 'max-w-[1600px] grid grid-cols-12 gap-8'} text-left blueprint-container relative z-10 px-6 lg:px-12 pb-32`}>
                    
                    {/* Presentation Mode Portal Overlay */}
                    {isPresenting && ReactDOM.createPortal(
                        <div className="fixed inset-0 z-[10000] bg-slate-950 flex flex-col no-print">
                            {/* STEALTH ADVISOR CONSOLE */}
                            <div className="absolute top-8 left-8 z-[10001] group no-print">
                                <button 
                                    onClick={() => setIsConsoleOpen(!isConsoleOpen)} 
                                    className={`w-12 h-12 rounded-full flex items-center justify-center transition-all duration-500 backdrop-blur-md ${isConsoleOpen ? 'bg-white/20 text-white rotate-90' : 'bg-transparent text-transparent group-hover:bg-white/10 group-hover:text-white'}`}
                                >
                                    <Icon name="settings" size={24} />
                                </button>
                                
                                <div className={`absolute top-16 left-0 w-80 bg-slate-900/90 backdrop-blur-xl border border-white/10 rounded-3xl p-6 shadow-2xl transition-all duration-500 origin-top-left ${isConsoleOpen ? 'scale-100 opacity-100 visible' : 'scale-95 opacity-0 invisible'}`}>
                                    <h4 className="text-white text-sm font-bold uppercase tracking-widest border-b border-white/10 pb-4 mb-6 flex items-center gap-2">
                                        <Icon name="sliders" size={16} className="text-teal-400" /> Stealth Console
                                    </h4>
                                    <div className="space-y-6">
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 uppercase tracking-widest block mb-3">Market Condition</label>
                                            <div className="flex gap-2 bg-white/5 p-1 rounded-xl">
                                                <button onClick={() => setScenario('bear')} className={`flex-1 py-2 rounded-lg text-[10px] font-bold uppercase transition-all shadow-sm ${scenario==='bear' ? 'bg-rose-500 text-white' : 'text-slate-500 hover:text-white'}`}>Bear</button>
                                                <button onClick={() => setScenario('base')} className={`flex-1 py-2 rounded-lg text-[10px] font-bold uppercase transition-all shadow-sm ${scenario==='base' ? 'bg-slate-700 text-white' : 'text-slate-500 hover:text-white'}`}>Base</button>
                                                <button onClick={() => setScenario('bull')} className={`flex-1 py-2 rounded-lg text-[10px] font-bold uppercase transition-all shadow-sm ${scenario==='bull' ? 'bg-emerald-500 text-white' : 'text-slate-500 hover:text-white'}`}>Bull</button>
                                            </div>
                                        </div>
                                        <div>
                                            <div className="flex justify-between items-end mb-3">
                                                <label className="text-xs font-bold text-slate-400 uppercase tracking-widest block">Retirement Age</label>
                                                <span className="text-base font-bold text-white">{profile.retireAge} Yrs</span>
                                            </div>
                                            <input type="range" min={safeNumber(profile.age) + 1} max={safeNumber(profile.horizonAge) - 1} value={profile.retireAge} onChange={(e) => setProfile({...profile, retireAge: e.target.value})} className="w-full accent-teal-500" />
                                        </div>
                                        <div>
                                            <div className="flex justify-between items-end mb-3">
                                                <label className="text-xs font-bold text-slate-400 uppercase tracking-widest block">Burn Trim (Optimize)</label>
                                                <span className="text-base font-bold text-white">-{burnTrim}%</span>
                                            </div>
                                            <input type="range" min="0" max="30" step="5" value={burnTrim} onChange={(e) => setBurnTrim(Number(e.target.value))} className="w-full accent-amber-500" />
                                            <p className="text-[10px] text-slate-500 mt-3 leading-relaxed">Reduces non-fixed expenses (lifestyle, household, vacation) to instantly show the impact of saving more.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="absolute top-8 right-8 flex gap-4 z-50">
                                <button onClick={() => { setIsPresenting(false); setBurnTrim(0); setScenario('base'); }} className="px-6 py-3.5 bg-white/10 hover:bg-white/20 text-white rounded-full font-bold text-sm uppercase tracking-widest transition-all backdrop-blur-md flex items-center gap-2">
                                    <Icon name="x" size={18}/> Exit Presentation
                                </button>
                            </div>
                            <div className="flex-1 relative overflow-hidden">
                                {renderPresentationSlide()}
                            </div>
                            <div className="absolute bottom-12 left-0 right-0 flex justify-center items-center gap-8 z-50">
                                <button disabled={currentSlide === 0} onClick={() => setCurrentSlide(c => c - 1)} className="w-16 h-16 rounded-full bg-white/10 flex items-center justify-center text-white disabled:opacity-30 hover:bg-white/20 transition-colors backdrop-blur-md">
                                    <Icon name="chevron-left" size={28}/>
                                </button>
                                <div className="flex gap-4">
                                    {[0,1,2,3,4,5].map(i => (
                                        <div key={i} className={`w-3.5 h-3.5 rounded-full transition-all ${currentSlide === i ? 'bg-teal-400 scale-125' : 'bg-white/20'}`} />
                                    ))}
                                </div>
                                <button disabled={currentSlide === 5} onClick={() => setCurrentSlide(c => c + 1)} className="w-16 h-16 rounded-full bg-white/10 flex items-center justify-center text-white disabled:opacity-30 hover:bg-white/20 transition-colors backdrop-blur-md">
                                    <Icon name="chevron-right" size={28}/>
                                </button>
                            </div>
                        </div>,
                        document.body
                    )}

                    {/* PHASE WRAPPER RESTORED: Layout Filter Logic */}
                    <div className={blueprintLayout === 'list' ? 'col-span-full' : 'col-span-12'}>
                        <div className="no-print pt-6 pb-2 cinematic-enter">
                            <header className="premium-card p-6 md:p-8 flex flex-col lg:flex-row gap-6 items-center justify-between w-full">
                                <div className="text-left w-full lg:w-auto relative z-10">
                                    <h2 className="text-3xl md:text-4xl font-black heading-font text-slate-900 uppercase tracking-tighter">Baba Blueprint</h2>
                                    <p className="text-teal-700 font-bold uppercase tracking-[0.3em] text-xs mt-1">Platinum Strategy Synthesis</p>
                                </div>
                                <div className="flex flex-wrap gap-4 items-center justify-start lg:justify-end w-full lg:w-auto relative z-10">
                                    <div className="flex bg-white/40 backdrop-blur-md border border-white/60 p-1.5 rounded-lg shadow-sm">
                                        <button onClick={() => setBlueprintLayout('list')} title="List View" className={`px-4 py-2 rounded-md text-xs font-bold uppercase tracking-widest transition-all ${blueprintLayout === 'list' ? 'bg-slate-900 text-white shadow-md attention-tab' : 'text-slate-600 hover:text-slate-900 hover:bg-white/50'}`}><Icon name="list" size={14}/></button>
                                        <button onClick={() => setBlueprintLayout('bento')} title="Bento Grid View" className={`px-4 py-2 rounded-md text-xs font-bold uppercase tracking-widest transition-all ${blueprintLayout === 'bento' ? 'bg-slate-900 text-white shadow-md attention-tab' : 'text-slate-600 hover:text-slate-900 hover:bg-white/50'}`}><Icon name="layout-grid" size={14}/></button>
                                        <button onClick={() => setBlueprintLayout('compact')} title="Compact View" className={`px-4 py-2 rounded-md text-xs font-bold uppercase tracking-widest transition-all ${blueprintLayout === 'compact' ? 'bg-slate-900 text-white shadow-md attention-tab' : 'text-slate-600 hover:text-slate-900 hover:bg-white/50'}`}><Icon name="columns" size={14}/></button>
                                    </div>
                                    <div className="flex flex-col gap-1 relative z-50">
                                        <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest px-1">Advisor Name</label>
                                        <input 
                                            type="text" 
                                            placeholder="Enter Advisor Name" 
                                            className="border border-white/60 focus:border-teal-600 outline-none text-sm font-bold text-slate-800 bg-white/60 backdrop-blur-md px-3 py-2 rounded-lg shadow-sm w-40 placeholder:font-medium transition-all"
                                            value={profile.advisorName || ''}
                                            onChange={(e) => setProfile({...profile, advisorName: e.target.value})}
                                        />
                                    </div>
                                    {profile.advisorName && (
                                        <React.Fragment>
                                            <button onClick={handlePrint} disabled={isGeneratingPDF} className={`px-5 py-3 bg-slate-900 text-white rounded-xl font-bold text-[10px] uppercase tracking-widest shadow-md active:scale-95 transition-all flex items-center gap-2 hover:bg-slate-800 animate-in fade-in zoom-in ${isGeneratingPDF ? 'opacity-70 cursor-not-allowed' : ''}`}>
                                                <Icon name={isGeneratingPDF ? "loader" : "printer"} size={14} className={isGeneratingPDF ? "animate-spin" : ""}/> 
                                                {isGeneratingPDF ? 'Generating...' : 'Save PDF'}
                                            </button>
                                            <button onClick={() => handleShare('whatsapp')} className="p-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition-all shadow-md active:scale-95" title="Share via WhatsApp"><Icon name="message-circle" size={16}/></button>
                                            <button onClick={() => handleShare('mail')} className="p-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-all shadow-md active:scale-95" title="Share via Email"><Icon name="mail" size={16}/></button>
                                        </React.Fragment>
                                    )}
                                    <button onClick={() => { setCurrentSlide(0); setIsPresenting(true); }} className="px-5 py-3 bg-indigo-600 text-white rounded-xl font-bold text-[10px] uppercase tracking-widest shadow-md active:scale-95 transition-all flex items-center gap-2 hover:bg-indigo-700 animate-pulse-slow"><Icon name="monitor-play" size={14}/> Present</button>
                                    <button onClick={downloadCSV} className="px-5 py-3 bg-white/40 backdrop-blur-md border border-white/60 text-slate-700 rounded-xl font-bold text-[10px] uppercase tracking-widest shadow-sm active:scale-95 transition-all flex items-center gap-2 hover:bg-white/60 active-ring"><Icon name="download" size={14}/> CSV</button>
                                </div>
                            </header>
                            
                            {/* PM INJECTED: Health Score Banner */}
                            <div className="w-full p-4 premium-card flex flex-col xl:flex-row items-center justify-between text-left mt-6 gap-6">
                                <div className="flex gap-4 items-center text-left relative z-10 w-full xl:w-auto px-2">
                                    <div className={`p-4 rounded-full border-4 flex items-center justify-center font-black text-xl shadow-lg shrink-0 ${strategyHealthScore > 75 ? 'border-emerald-500 text-emerald-700 bg-emerald-50' : strategyHealthScore > 50 ? 'border-amber-500 text-amber-700 bg-amber-50' : 'border-rose-500 text-rose-700 bg-rose-50'}`}>
                                        {strategyHealthScore}
                                    </div>
                                    <div className="text-left flex-1">
                                        <p className="text-xs font-bold uppercase tracking-widest text-slate-500">Strategy Health</p>
                                        <p className="text-base font-black text-slate-900 leading-tight">
                                            {strategyHealthScore > 75 ? 'Wealth Master' : strategyHealthScore > 50 ? 'Secure Baseline' : 'High Vulnerability'}
                                        </p>
                                        <p className={`text-[10px] font-bold uppercase tracking-widest mt-1 ${verdict.color}`}>System Verdict: {verdict.title}</p>
                                    </div>
                                </div>
                                
                                <div className="flex flex-wrap gap-3 w-full xl:w-auto flex-1 xl:justify-end">
                                    <div className="bg-white/40 backdrop-blur-md border border-white/80 rounded-xl px-4 py-3 flex-1 min-w-[250px] max-w-sm shadow-sm flex items-start gap-3">
                                        <Icon name="zap" size={18} className="text-amber-500 shrink-0 mt-0.5" />
                                        <div>
                                            <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Tactical Nudge</p>
                                            <p className="text-[11px] font-semibold text-slate-800 italic mt-0.5">
                                                {freeCashflow > 0 
                                                    ? `Invest your ₹${Math.round(freeCashflow).toLocaleString()}/mo surplus to accelerate your freedom date.`
                                                    : `A ₹${Math.round(Math.abs(freeCashflow)).toLocaleString()}/mo execution gap exists. Optimize lifestyle burn.`}
                                            </p>
                                        </div>
                                    </div>
                                    <div className="bg-white/40 backdrop-blur-md border border-white/80 rounded-xl px-4 py-3 flex-1 min-w-[250px] max-w-sm shadow-sm flex items-start gap-3 relative z-50">
                                        <Icon name="activity" size={18} className="text-rose-500 shrink-0 mt-0.5" />
                                        <div className="w-full">
                                            <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Market Scenario</p>
                                            <div className="flex bg-slate-200/50 p-1 rounded-lg mt-1.5 w-full shadow-inner">
                                                <button onClick={() => setScenario('bear')} className={`flex-1 px-2 py-1 rounded text-[9px] font-black uppercase transition-all ${scenario==='bear' ? 'bg-rose-500 text-white shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Bear</button>
                                                <button onClick={() => setScenario('base')} className={`flex-1 px-2 py-1 rounded text-[9px] font-black uppercase transition-all ${scenario==='base' ? 'bg-slate-800 text-white shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Base</button>
                                                <button onClick={() => setScenario('bull')} className={`flex-1 px-2 py-1 rounded text-[9px] font-black uppercase transition-all ${scenario==='bull' ? 'bg-emerald-500 text-white shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Bull</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {/* PM INJECTED BANNER END */}
                        </div>
                    </div>

                    <div className="hidden print-only mb-10 pb-6 border-b-2 border-slate-200 text-left">
                        <h1 className="text-3xl font-extrabold heading-font text-slate-900 uppercase">Strategic Wealth Blueprint</h1>
                        <p className="text-sm font-bold text-slate-500 mt-3">Prepared exclusively for: <span className="text-slate-900">{profile.name || 'Valued Client'}</span></p>
                        <p className="text-sm font-bold text-slate-500 mt-1">Prepared by: <span className="text-slate-900">{profile.advisorName || 'BABA Advisor'}</span></p>
                        <p className="text-xs text-slate-400 mt-2">Generated on: {new Date().toLocaleDateString()}</p>
                    </div>
                    
                    {/* Phase 1: Summary */}
                    <PhaseWrapper num={1} title="Executive Summary" layout={blueprintLayout} gridClasses={blueprintLayout === 'compact' ? 'col-span-12' : 'col-span-12 lg:col-span-8'}>
                        <div className="space-y-3 text-slate-700 text-left">
                            <p className="text-base font-bold">Hi {profile.name || "Strategist"} 👋,</p>
                            <p className="font-medium text-sm">We have baselined your financial coordinates for a long-term strategic horizon. Here is where you stand today:</p>
                            <ul className="list-disc pl-5 space-y-1.5 text-sm font-medium text-slate-600 text-left">
                                <li>Income: <span className="text-teal-700 font-bold">{formatCurrency(totals.income)}</span> /mo</li>
                                <li>Burn: <span className="text-rose-600 font-bold">{formatCurrency(monthlyBurn)}</span> /mo
                                    <div className="flex flex-wrap gap-2 mt-2 ml-[-20px] mb-2">
                                        {safeNumber(profile.rent) > 0 && <span className="text-[11px] font-bold bg-white/50 backdrop-blur-sm px-2.5 py-1 rounded text-slate-700 border border-white/60">Rent: {formatCurrency(profile.rent)}</span>}
                                        {safeNumber(profile.emi) > 0 && <span className="text-[11px] font-bold bg-white/50 backdrop-blur-sm px-2.5 py-1 rounded text-slate-700 border border-white/60">EMI: {formatCurrency(profile.emi)} (Ends {profile.emiEndYear || 'N/A'})</span>}
                                        {safeNumber(profile.household) > 0 && <span className="text-[11px] font-bold bg-white/50 backdrop-blur-sm px-2.5 py-1 rounded text-slate-700 border border-white/60">Household: {formatCurrency(profile.household)}</span>}
                                        {safeNumber(profile.lifestyle) > 0 && <span className="text-[11px] font-bold bg-white/50 backdrop-blur-sm px-2.5 py-1 rounded text-slate-700 border border-white/60">Lifestyle: {formatCurrency(profile.lifestyle)}</span>}
                                        {safeNumber(profile.vacation) > 0 && <span className="text-[11px] font-bold bg-white/50 backdrop-blur-sm px-2.5 py-1 rounded text-slate-700 border border-white/60">Vacation: {formatCurrency(safeNumber(profile.vacation)/12)}/mo</span>}
                                    </div>
                                </li>
                                <li>Assets: <span className="text-indigo-700 font-bold">{formatCurrency(totalAssets)}</span> today</li>
                            </ul>
                        </div>

                        {/* List view density fix: Put these side-by-side even in list view so it's not toweringly tall */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-5 mt-4 flex-1">
                            <div className="bg-white/30 backdrop-blur-md rounded-xl border border-white/50 p-5 shadow-sm flex flex-col justify-between">
                                <div>
                                    <div className="flex justify-between items-end mb-4">
                                        <div>
                                            <h4 className="text-[10px] font-bold text-slate-600 uppercase tracking-[0.2em]">💧 Liquidity Reality Check</h4>
                                            <p className="text-[11px] text-slate-500 font-medium mt-1">The "oxygen" of your plan.</p>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        <div className="space-y-2.5">
                                            <div className="flex justify-between text-xs font-bold">
                                                <span className="text-slate-600">Monthly Income</span>
                                                <span className="text-slate-900">{formatCurrency(totals.income)}</span>
                                            </div>
                                            <div className="flex justify-between text-xs font-bold">
                                                <span className="text-slate-600">Invest + Burn</span>
                                                <span className="text-slate-600">{formatCurrency(totalSIPRequired + monthlyBurn)}</span>
                                            </div>
                                            <div className="flex justify-between text-xs font-bold pt-3 border-t border-white/50">
                                                <span className="text-slate-700">Leftover Cashflow</span>
                                                <span className={`${freeCashflow >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                                                    {formatCurrency(freeCashflow)}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <div className="h-4 bg-white/50 backdrop-blur-sm rounded-full overflow-hidden flex relative border border-white/60 shadow-inner">
                                            <div className="h-full bg-slate-400" style={{width: `${Math.min(100, (monthlyBurn/totals.income)*100)}%`}} title="Lifestyle Burn"></div>
                                            <div className="h-full bg-teal-500" style={{width: `${Math.min(100, (totalSIPRequired/totals.income)*100)}%`}} title="Goal Investment"></div>
                                        </div>
                                        <div className="flex justify-between text-[10px] font-bold uppercase tracking-widest">
                                            <span className="text-slate-500">Burn: {Math.round((monthlyBurn/totals.income)*100)}%</span>
                                            <span className="text-teal-700">SIP: {Math.round((totalSIPRequired/totals.income)*100)}%</span>
                                            <span className={`${freeCashflowPct < 10 ? 'text-rose-600' : 'text-emerald-600'}`}>
                                                Free: {Math.round(freeCashflowPct)}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                {freeCashflowPct < 10 && (
                                    <div className="mt-3 p-3 bg-rose-100/50 border border-rose-200/50 rounded-lg text-rose-700 text-[11px] font-bold shadow-[inset_0_2px_4px_rgba(255,255,255,0.5)] flex items-start gap-2">
                                        <Icon name="alert-triangle" size={14} className="shrink-0 mt-0.5" />
                                        <span>🚨 High Risk of SIP Default: Your remaining liquidity is dangerously tight.</span>
                                    </div>
                                )}
                            </div>
                            
                            <div className="flex flex-col justify-center">
                                <AssetAllocationPie profile={profile} />
                            </div>
                        </div>

                        <div className="bg-white/30 backdrop-blur-md rounded-xl border border-white/50 p-5 mt-5 shadow-sm">
                            <h4 className="text-[10px] font-bold text-slate-600 uppercase tracking-[0.2em] mb-4">Financial Ledger</h4>
                            <div className="grid grid-cols-2 gap-y-4 gap-x-8 text-xs">
                                <div><span className="text-slate-500 font-bold block mb-1">Current Age</span><span className="font-extrabold text-slate-900 text-sm">{profile.age} Years</span></div>
                                <div><span className="text-slate-500 font-bold block mb-1">Retirement</span><span className="font-extrabold text-slate-900 text-sm">{profile.retireAge} Years</span></div>
                                <div><span className="text-slate-500 font-bold block mb-1">Monthly Income</span><span className="font-extrabold text-teal-700 text-sm">{formatCurrency(safeNumber(profile.salary) + safeNumber(profile.businessIncome))}</span></div>
                                <div><span className="text-slate-500 font-bold block mb-1">Family Status</span><span className="font-extrabold text-slate-900 text-sm">{profile.married ? (profile.hasChildren ? `Married + ${profile.childCount} Kids` : "Married") : "Single"}</span></div>
                                
                                {safeNumber(profile.emi) > 0 && (
                                    <React.Fragment>
                                        <div><span className="text-slate-500 font-bold block mb-1">Monthly EMI</span><span className="font-extrabold text-rose-600 text-sm">{formatCurrency(profile.emi)}</span></div>
                                        <div><span className="text-slate-500 font-bold block mb-1">EMI Free Year</span><span className="font-extrabold text-slate-900 text-sm">{profile.emiEndYear}</span></div>
                                    </React.Fragment>
                                )}
                                <div><span className="text-slate-500 font-bold block mb-1">Existing SIP</span><span className="font-extrabold text-indigo-700 text-sm">{formatCurrency(profile.currentSip)}</span></div>
                            </div>
                        </div>

                        {debtInsight && (
                            <div className="bg-white/40 backdrop-blur-md rounded-xl border border-indigo-200 p-5 mt-5 shadow-sm flex flex-col md:flex-row items-start md:items-center gap-4">
                                <div className="p-3 bg-indigo-600 text-white rounded-xl shadow-md shrink-0"><Icon name="trending-down" size={24}/></div>
                                <div className="flex-1">
                                    <h4 className="text-[10px] font-bold text-indigo-900 uppercase tracking-widest mb-1.5 flex items-center gap-2">❄️ Debt Snowball Intelligence <span className="bg-rose-500 text-white text-[8px] px-2 py-0.5 rounded-full animate-pulse">ACTIONABLE</span></h4>
                                    <p className="text-xs font-medium text-slate-700 leading-relaxed mb-3">
                                        By increasing your EMI by 20% (<strong className="font-extrabold text-slate-900">+{formatCurrency(debtInsight.bumpAmount)}/mo</strong>), you will close your loan <strong className="font-extrabold text-indigo-700">{debtInsight.yearsSaved} years early</strong> and save <strong className="font-extrabold text-emerald-600">{formatCurrency(debtInsight.interestSaved)}</strong> in interest. 
                                    </p>
                                    {crossoverData && (
                                         <div className="pt-3 border-t border-indigo-200/50">
                                              <h4 className="text-[9px] font-bold text-indigo-800 uppercase tracking-widest mb-1">🦅 True Freedom Crossover</h4>
                                              <p className="text-[11px] font-medium text-slate-600">By Age <strong className="font-extrabold text-indigo-900">{crossoverData.age}</strong> (in {crossoverData.year} years), your liquid wealth will officially eclipse your total outstanding debt.</p>
                                         </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </PhaseWrapper>

                    {/* Phase 2: Retirement Reality */}
                    <PhaseWrapper num={2} title="Retirement Reality" layout={blueprintLayout} gridClasses={blueprintLayout === 'compact' ? 'col-span-12 md:col-span-6' : 'col-span-12 lg:col-span-4'}>
                        <div className="mb-4 text-left border-b border-white/50 pb-4">
                            <p className="text-xs font-medium text-slate-700 leading-relaxed">Let's decode the exact mathematical cost of your future freedom. We project your current lifestyle into the future to find your ultimate target.</p>
                        </div>
                        <div className="space-y-6 text-left relative z-10 flex-1 flex flex-col">
                            
                            <div className={`grid grid-cols-1 ${blueprintLayout === 'list' ? 'md:grid-cols-2 xl:grid-cols-4' : 'grid-cols-1'} gap-4`}>
                                <div className="flex flex-col justify-center bg-white/40 backdrop-blur-sm p-4 rounded-xl border border-white/60 shadow-sm">
                                    <p className="text-[10px] font-bold uppercase text-slate-600 tracking-widest mb-1">🛒 1. Price of Today</p>
                                    <p className="text-base font-bold text-slate-800">{formatCurrency(monthlyBurnBase + monthlyInsVac)}/mo</p>
                                    <span className="text-[10px] font-medium text-slate-500 mt-1">(ex-EMI)</span>
                                    <p className="text-[10px] text-slate-600 mt-2 leading-snug">This is your lifestyle baseline. To truly retire, we must replicate this exact standard of living.</p>
                                </div>
                                
                                <div className="flex flex-col justify-center bg-rose-50/60 backdrop-blur-sm p-4 rounded-xl border border-rose-200/60 shadow-sm relative overflow-hidden">
                                    <div className="absolute top-0 right-0 bg-rose-500 text-white text-[8px] font-bold uppercase px-2 py-0.5 rounded-bl-lg shadow-sm">Inflation 6%</div>
                                    <p className="text-[10px] font-bold text-rose-700 uppercase tracking-widest mb-1 relative z-10">🦹‍♂️ 2. The Inflation Thief</p>
                                    <p className="text-base font-bold text-rose-900 relative z-10">In {retireYrs} yrs: {formatCurrency(futureLife)}/mo</p>
                                    {retireYrs < emiYearsLeft && <p className="text-[9px] text-rose-600 font-bold mt-1 relative z-10">(Includes {formatCurrency(profile.emi)} EMI)</p>}
                                    <p className="text-[10px] text-rose-800 mt-2 leading-snug relative z-10">The silent tax. At 6% inflation, the exact same life will cost exponentially more when you stop working.</p>
                                </div>

                                <div className="flex flex-col justify-center bg-white/40 backdrop-blur-sm border border-white/60 p-4 rounded-xl shadow-sm">
                                    <p className="text-[10px] font-bold uppercase text-slate-600 tracking-widest mb-1">💰 3. Freedom Corpus Needed</p>
                                    <p className="text-xl font-extrabold text-slate-900">{formatCurrency(retireCorpus)}</p>
                                    <p className="text-[9px] font-bold text-teal-800 mt-1.5 bg-teal-100/50 backdrop-blur-sm shadow-sm inline-block px-2 py-0.5 rounded border border-teal-200 w-fit">Funds {retirementDuration} Years</p>
                                    <p className="text-[10px] text-slate-600 mt-2 leading-snug">Your ultimate mountain. This corpus safely sustains your inflated lifestyle for the rest of your life.</p>
                                </div>

                                <div className="flex flex-col justify-center bg-white/40 backdrop-blur-sm border border-white/60 p-4 rounded-xl shadow-sm">
                                    <p className="text-[10px] font-bold uppercase text-teal-700 tracking-widest mb-1">⚙️ 4. Required Monthly SIP</p>
                                    <p className="text-xl font-black text-teal-800">{formatCurrency(retirementSIP)}</p>
                                    <p className="text-[10px] text-slate-600 mt-2 leading-snug">The execution engine. This is the non-negotiable monthly capital you must deploy starting today.</p>
                                </div>
                            </div>

                            <div className={blueprintLayout === 'list' ? 'max-w-4xl' : ''}>
                                <InflationChart currentBurn={monthlyBurnBase + monthlyInsVac} futureBurn={futureLife} years={retireYrs} />
                            </div>

                            {/* PM FEATURE 3 & 4: COAST FIRE & HUMAN CAPITAL */}
                            <div className={`grid grid-cols-1 ${blueprintLayout === 'list' ? 'xl:grid-cols-2' : ''} gap-4 mt-auto pt-4 border-t border-white/50`}>
                                <div className="bg-indigo-50/60 backdrop-blur-sm border border-indigo-200/60 p-4 rounded-xl shadow-sm">
                                    <h4 className="text-[10px] font-bold text-indigo-900 uppercase tracking-widest mb-1">⛵ Coast FIRE Milestone</h4>
                                    <p className="text-[11px] text-indigo-800 mb-2 leading-relaxed">Age where current assets compound to target without more SIPs.</p>
                                    <span className="text-xl font-black text-indigo-900">{coastAge ? coastAge + " Yrs" : "Not on trajectory"}</span>
                                </div>
                                <div className="bg-emerald-50/60 backdrop-blur-sm border border-emerald-200/60 p-4 rounded-xl shadow-sm">
                                    <h4 className="text-[10px] font-bold text-emerald-900 uppercase tracking-widest mb-1">📈 Human Capital Growth</h4>
                                    <p className="text-[11px] text-emerald-800 mb-2 leading-relaxed">Assuming an 8% career growth rate vs 6% inflation, projected earning power at retirement.</p>
                                    <span className="text-xl font-black text-emerald-900">{formatCurrency(projectedIncome)}<span className="text-[10px] uppercase font-bold text-emerald-800 ml-1">/mo</span></span>
                                </div>
                            </div>
                        </div>
                    </PhaseWrapper>

                    {/* Phase 3: Risk & Protection */}
                    <PhaseWrapper num={3} title="Risk & Protection" layout={blueprintLayout} gridClasses={blueprintLayout === 'compact' ? 'col-span-12 md:col-span-6' : 'col-span-12 lg:col-span-4'}>
                        <div className="flex flex-col gap-4 h-full">
                            {profile.insuranceActive && profile.existingHealthCover ? (
                                healthAnalysis.isAdequate ? (
                                    <div className="flex items-start gap-2.5 text-emerald-800 font-bold bg-emerald-50/80 backdrop-blur-md p-3 rounded-lg border border-emerald-200 shadow-sm text-[11px]">
                                        <Icon name="check-circle" size={14} className="mt-0.5 text-emerald-600 shrink-0" />
                                        <span>Health Cover: Adequate ({formatCurrency(healthAnalysis.existing)}).</span>
                                    </div>
                                ) : (
                                    <div className="flex flex-col gap-2 bg-rose-50/80 backdrop-blur-md p-3 rounded-lg border border-rose-200 shadow-sm">
                                        <div className="flex items-start gap-2.5 text-rose-800 font-bold text-[11px]">
                                            <Icon name="alert-triangle" size={14} className="mt-0.5 text-rose-600 shrink-0"/>
                                            <span>Health Shortfall: Need {formatCurrency(healthAnalysis.shortfall)} more.</span>
                                        </div>
                                        <div className="p-2 bg-white/80 backdrop-blur-md border border-white rounded text-indigo-900 text-[10px] font-medium shadow-sm">
                                            <strong>💡 Pro Tip:</strong> Buy a <strong>Super Top-up Plan</strong> of {formatCurrency(healthAnalysis.shortfall)} with a deductible of {formatCurrency(healthAnalysis.existing)}. It costs 80% less than a base plan.
                                        </div>
                                    </div>
                                )
                            ) : (
                                <div className="text-rose-800 flex items-start gap-2 font-bold bg-rose-50/80 backdrop-blur-md p-3 rounded-lg border border-rose-200 shadow-sm text-[11px]">
                                    <Icon name="alert-octagon" size={14} className="shrink-0 text-rose-600" />
                                    <span>Critical Alert: You haven't listed any active insurance. This puts your entire financial plan at massive risk in case of a medical emergency.</span>
                                </div>
                            )}

                            <div className={`grid grid-cols-1 ${blueprintLayout === 'list' ? 'lg:grid-cols-3' : ''} gap-4 relative z-10 flex-1`}>
                                <div className="p-4 bg-white/40 backdrop-blur-md rounded-xl border border-white/60 shadow-[0_4px_12px_-4px_rgba(0,0,0,0.05)] relative overflow-hidden flex flex-col justify-center">
                                    <div className="absolute top-0 right-0 p-1 px-2 bg-amber-100/50 rounded-bl-lg text-[8px] font-bold text-amber-800 uppercase tracking-widest border-l border-b border-amber-200/50">💵 Cash</div>
                                    <p className="text-[10px] font-bold text-slate-600 uppercase mb-1 tracking-widest">Emergency Reserve</p>
                                    <p className="text-lg font-extrabold text-amber-600 drop-shadow-sm">{formatCurrency(monthlyBurn * 6)}</p>
                                    <p className="text-[10px] text-slate-700 mt-1.5 font-medium leading-relaxed">Why? 6 months of absolute lifestyle burn to handle job loss or sudden cash flow shocks without breaking SIPs.</p>
                                </div>
                                <div className="p-4 bg-white/40 backdrop-blur-md rounded-xl border border-white/60 shadow-[0_4px_12px_-4px_rgba(0,0,0,0.05)] relative overflow-hidden flex flex-col justify-center">
                                    <div className="absolute top-0 right-0 p-1 px-2 bg-rose-100/50 rounded-bl-lg text-[8px] font-bold text-rose-800 uppercase tracking-widest border-l border-b border-rose-200/50">🏥 Medical</div>
                                    <p className="text-[10px] font-bold text-slate-600 uppercase mb-1 tracking-widest">Recommended Health Shield</p>
                                    <p className="text-lg font-extrabold text-rose-600 drop-shadow-sm">{formatCurrency(healthAnalysis.recommended)}</p>
                                    <p className="text-[10px] text-slate-700 mt-1.5 font-medium leading-relaxed">Why? One major hospitalization today costs ~5-7L. With medical inflation at 14%, a 15L buffer is the minimum safety net.</p>
                                </div>
                                <div className="p-4 bg-white/40 backdrop-blur-md rounded-xl border border-white/60 shadow-[0_4px_12px_-4px_rgba(0,0,0,0.05)] relative overflow-hidden flex flex-col justify-center">
                                    <div className="absolute top-0 right-0 p-1 px-2 bg-emerald-100/50 rounded-bl-lg text-[8px] font-bold text-emerald-800 uppercase tracking-widest border-l border-b border-emerald-200/50">🛡️ Life</div>
                                    <p className="text-[10px] font-bold text-slate-600 uppercase mb-1 tracking-widest">Term Cover Goal</p>
                                    <p className="text-lg font-extrabold text-emerald-600 drop-shadow-sm">{formatCurrency(totals.income * 12 * 20)}</p>
                                    <p className="text-[10px] text-slate-700 mt-1.5 font-medium leading-relaxed">Why? This corpus (20x Income), if invested at 6% FD, replaces your current annual income for your family instantly if you are not around.</p>
                                </div>
                            </div>
                        </div>
                    </PhaseWrapper>

                    {/* Phase 4: Asset Allocation */}
                    <PhaseWrapper num={4} title="Asset Allocation" layout={blueprintLayout} gridClasses={blueprintLayout === 'compact' ? 'col-span-12' : 'col-span-12 lg:col-span-8'}>
                        <div className="flex justify-between items-center border-b border-white/60 pb-3 mb-3">
                            <p className="text-slate-700 font-semibold text-[10px] italic">"Wake up your idle money." 💸</p>
                            <p className="text-[10px] font-bold text-slate-600 tracking-[0.2em] uppercase">Total Assets: <span className="text-sm font-extrabold text-teal-800 tracking-tighter">{formatCurrency(totalAssets)}</span></p>
                        </div>

                        <p className="text-xs font-semibold text-slate-800 mb-4 leading-relaxed">Do you want to use your existing assets ({formatCurrency(totalAssets)}) to fund some of your goals? This reduces the new SIP required.</p>
                        
                        <Toggle label="Deploy existing wealth towards goals?" value={isWealthAllocated} onChange={v => { setIsWealthAllocated(v); setIsAllocExpanded(v); }} />

                        {isWealthAllocated ? (
                            <div className="mt-4 flex flex-col xl:flex-row gap-5">
                                <div className="bg-white/40 backdrop-blur-md rounded-xl border border-white/60 p-2 shadow-sm shrink-0 flex items-center justify-center"><AllocationDonut data={plan.filter(g => safeNumber(allocMap[g.id]) > 0).map(g => ({ label: g.name, value: safeNumber(g.allocAmt) })).concat([{ label: "Unallocated", value: unallocatedData.remaining }])} total={totalAssets} /></div>
                                
                                <div className="flex-1 bg-white/30 backdrop-blur-md rounded-xl border border-white/50 p-4 shadow-inner overflow-y-auto max-h-[250px] custom-scrollbar">
                                    <div className="flex justify-between items-center mb-2">
                                        <p className="text-[10px] font-bold uppercase text-slate-700 tracking-widest">Matrix Mapping</p>
                                        <button onClick={() => setIsAllocExpanded(!isAllocExpanded)} className="text-[10px] font-bold text-teal-800 bg-white/60 px-2.5 py-1 rounded border border-white/80 shadow-[0_2px_4px_rgba(0,0,0,0.02)] hover:bg-white transition-colors">{isAllocExpanded ? 'Minimize' : 'Expand'}</button>
                                    </div>
                                    <div className={`transition-all duration-500 overflow-hidden ${isAllocExpanded ? 'max-h-[1000px] opacity-100' : 'max-h-0 opacity-0'}`}>
                                        <div className="grid grid-cols-1 gap-2 text-left pt-1">
                                            {plan.map(g => {
                                                const returnRate = (getScenarioReturn(g.returns) || 12) / 100;
                                                const requiredPv = g.target / Math.pow(1 + returnRate, g.horizon);
                                                const maxReqPct = totalAssets > 0 ? (requiredPv / totalAssets) * 100 : 0;
                                                const currentAlloc = Number(allocMap[g.id]) || 0;
                                                const isOverAllocated = currentAlloc > maxReqPct;

                                                return ( 
                                                <div key={g.id} className="p-3 bg-white/50 backdrop-blur-sm border border-white/60 rounded-lg flex flex-col gap-2 shadow-[0_2px_8px_rgba(0,0,0,0.03)]">
                                                    <div className="flex flex-col md:flex-row justify-between items-center gap-2 w-full">
                                                        <div className="w-full text-left">
                                                            <label className="text-[11px] font-bold uppercase text-teal-900 tracking-widest truncate block">{g.name}</label>
                                                            <span className="block text-[10px] font-bold text-slate-600 mt-0.5">Need Today: {formatCurrency(requiredPv)} (Max: {Math.min(100, maxReqPct).toFixed(1)}%)</span>
                                                        </div>
                                                        <div className="flex items-center gap-2 shrink-0">
                                                            <input type="number" placeholder="0%" value={allocMap[g.id] || ""} onChange={e => handleAllocChange(g.id, e.target.value)} className="w-14 premium-input p-1.5 text-xs font-bold text-center outline-none text-teal-900" />
                                                            <div className="text-center p-2 bg-white/40 border border-white/50 rounded-lg min-w-[70px] shadow-inner"><p className="text-xs font-extrabold text-teal-900">{formatCurrency((totalAssets * (Number(allocMap[g.id])||0)) / 100)}</p></div>
                                                        </div>
                                                    </div>
                                                    {isOverAllocated && (
                                                        <div className="text-[9px] font-bold text-rose-800 bg-rose-100/60 p-1.5 rounded-lg border border-rose-200 mt-1 flex items-start gap-1.5 shadow-inner">
                                                            <Icon name="info" size={12} className="shrink-0 text-rose-700"/> 
                                                            <span><strong>FYI:</strong> You only need {maxReqPct.toFixed(1)}% to fully fund this goal today.</span>
                                                        </div>
                                                    )}
                                                </div>
                                            )})}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="p-6 bg-white/30 backdrop-blur-md rounded-xl text-center border-dashed border-2 border-white/60 mt-4 shadow-[0_4px_12px_-4px_rgba(0,0,0,0.05)] relative z-10 flex-1 flex flex-col justify-center">
                                <p className="text-sm font-extrabold uppercase tracking-tighter text-slate-900 mt-1">🏺 Scenario: Legacy Pot</p>
                                <p className="text-xs font-medium text-slate-700 max-w-xl mx-auto leading-relaxed mt-1.5 mb-4">
                                    If you don't use this wealth for goals, here is how it grows <strong className="text-teal-800">(at {portfolioWeightedReturn.toFixed(1)}% weighted yield)</strong>:
                                </p>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="p-4 bg-white/60 backdrop-blur-md border border-white/80 rounded-xl shadow-sm">
                                        <p className="text-[10px] font-bold text-indigo-800 uppercase tracking-widest mb-1">By Retirement ({profile.retireAge}y)</p>
                                        <p className="text-xl font-black text-indigo-950">{formatCurrency(legacyProjection(retireYrs))}</p>
                                    </div>
                                    <div className="p-4 bg-white/60 backdrop-blur-md border border-white/80 rounded-xl shadow-sm">
                                        <p className="text-[10px] font-bold text-indigo-800 uppercase tracking-widest mb-1">By Horizon ({profile.horizonAge}y)</p>
                                        <p className="text-xl font-black text-indigo-950">{formatCurrency(legacyProjection(safeNumber(profile.horizonAge) - safeNumber(profile.age)))}</p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </PhaseWrapper>

                    {/* Phase 5: Execution Ledger */}
                    <PhaseWrapper num={5} title="Execution Ledger" layout={blueprintLayout} gridClasses="col-span-12">
                        <div className="mb-4 text-left">
                             <p className="text-xs font-semibold text-slate-800 leading-relaxed max-w-4xl">This is your tactical action plan. <strong>Click any goal card</strong> to run cashflow projections, adjust assumed returns, step-up SIPs, or inject lumpsum capital. Use the quick actions to edit targets on the fly.</p>
                        </div>
                        
                        <div className="bg-white/40 backdrop-blur-md border border-white/60 rounded-xl p-4 md:p-5 shadow-inner flex flex-wrap gap-6 items-center mb-5">
                            <div>
                                <p className="text-[10px] font-bold text-slate-600 uppercase tracking-widest mb-1">🎯 Total Goals</p>
                                <p className="text-xl font-black text-slate-900 leading-none">{plan.length}</p>
                            </div>
                            <div className="w-px h-6 bg-white/50"></div>
                            <div>
                                <p className="text-[10px] font-bold text-slate-600 uppercase tracking-widest mb-1">💸 Total SIP Required</p>
                                <p className="text-xl font-black text-teal-800 leading-none">{formatCurrency(totalSIPRequired)}<span className="text-[10px] text-slate-600 font-bold ml-1">/mo</span></p>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5 relative z-10">
                            {plan.map(g => (
                                <div key={g.id} className={`group relative border border-white/60 rounded-xl overflow-hidden transition-all duration-300 ${expandedGoal === g.id ? 'bg-white/90 backdrop-blur-xl shadow-lg ring-2 ring-teal-500/30 col-span-1 md:col-span-2 xl:col-span-3' : 'bg-white/50 backdrop-blur-md hover:bg-white/70 hover:shadow-md'}`}>
                                    
                                    {/* QUICK ACTIONS FIX: Hidden by default, shown on hover via opacity-0 group-hover:opacity-100 */}
                                    {g.id !== 'retire' && (
                                        <div className="absolute top-2 right-12 md:right-14 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1 z-20 no-print bg-white/80 backdrop-blur-md rounded-md border border-white/50 p-0.5 shadow-sm">
                                            <button onClick={(e) => handleStartEdit(e, g)} className="p-1.5 text-slate-500 hover:text-teal-700 hover:bg-white rounded transition-colors" title="Quick Edit Target Amount"><Icon name="edit-2" size={12}/></button>
                                            <button onClick={(e) => handleQuickDelete(e, g.id)} className="p-1.5 text-slate-500 hover:text-rose-700 hover:bg-white rounded transition-colors" title="Remove Goal entirely"><Icon name="trash-2" size={12}/></button>
                                        </div>
                                    )}

                                    <div 
                                        onClick={() => setExpandedGoal(expandedGoal === g.id ? null : g.id)}
                                        className="p-4 cursor-pointer flex justify-between items-center gap-4 transition-colors relative z-10"
                                    >
                                        <div className="flex items-center gap-3 w-full">
                                            <div className={`p-2.5 rounded-lg shrink-0 border border-white/50 ${expandedGoal === g.id ? 'bg-teal-600 text-white shadow-sm' : 'bg-white/60 text-slate-600 shadow-sm'}`}><Icon name={g.icon || "target"} size={18}/></div>
                                            <div>
                                                <h4 className="text-xs font-bold uppercase tracking-widest text-slate-900 truncate max-w-[160px]" title={g.name}>{g.name}</h4>
                                                
                                                {inlineEdit.id === g.id ? (
                                                    <div className="flex items-center gap-2 mt-2 bg-white/60 p-1.5 rounded-lg border border-teal-300 shadow-inner" onClick={e => e.stopPropagation()}>
                                                        <span className="text-[10px] font-bold text-slate-700 uppercase ml-1">Cost Today:</span>
                                                        <input type="number" value={inlineEdit.cost} onChange={e => setInlineEdit({...inlineEdit, cost: e.target.value})} className="w-20 bg-white border border-white/80 rounded px-2 py-1 text-xs font-bold outline-none focus:border-teal-500 shadow-sm" autoFocus onKeyDown={(e) => { if(e.key === 'Enter') handleSaveEdit(e); }} />
                                                        <button onClick={handleSaveEdit} className="p-1.5 bg-teal-600 text-white rounded hover:bg-teal-700 transition-colors shadow-sm"><Icon name="check" size={12}/></button>
                                                        <button onClick={() => setInlineEdit({id:null, cost:''})} className="p-1.5 bg-slate-300 text-slate-800 rounded hover:bg-slate-400 transition-colors shadow-sm"><Icon name="x" size={12}/></button>
                                                    </div>
                                                ) : (
                                                    <p className="text-[11px] font-semibold text-slate-600 mt-1">
                                                        {g.horizon} Yrs • <span className="text-slate-900 font-bold">{formatCurrency(g.target)}</span>
                                                        {/* PM FEATURE 5: PV GROUNDING RESTORED */}
                                                        <span className="block text-[9px] text-slate-500 mt-0.5">⏳ Equivalent to <strong className="text-slate-700">{formatCurrency(g.baseCost)}</strong> today.</span>
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                        <div className="text-right flex items-center gap-3 shrink-0">
                                            <div className="text-right">
                                                <p className="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-0.5">Req. SIP</p>
                                                <p className="text-base font-black text-teal-800">{formatCurrency(g.sip)}</p>
                                            </div>
                                            <div className={`p-1.5 rounded-md transition-colors ${expandedGoal === g.id ? 'bg-slate-100 text-slate-800' : 'text-slate-400'}`}>
                                                <Icon name={expandedGoal === g.id ? "chevron-up" : "chevron-down"} size={16} />
                                            </div>
                                        </div>
                                    </div>

                                    {expandedGoal === g.id && (
                                        <div className="p-4 pt-0 border-t border-white/50 animate-in fade-in slide-in-from-top-2 no-print">
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 my-4 p-4 bg-white/40 rounded-lg border border-white/60 shadow-[inset_0_2px_4px_rgba(0,0,0,0.02)]">
                                                <InputField label="Assumed Return" suffix="%" value={g.returns} type="text" onChange={v => updateGoalParams(g.id, 'returns', v)} />
                                                <InputField label="SIP Step-Up" suffix="%" value={g.stepUp} type="text" onChange={v => updateGoalParams(g.id, 'stepUp', v)} />
                                                <InputField label="Lumpsum Injection" prefix="₹" value={g.lumpsum} type="number" onChange={v => updateGoalParams(g.id, 'lumpsum', v)} />
                                            </div>

                                            <div className="overflow-x-auto bg-white/60 backdrop-blur-md p-3 rounded-lg border border-white/80 shadow-sm">
                                                <h5 className="text-[10px] font-bold text-slate-600 uppercase tracking-widest mb-3 pl-1">Cashflow Projection</h5>
                                                <table className="w-full text-xs text-left border-collapse">
                                                    <thead className="text-[10px] font-bold text-slate-500 uppercase tracking-widest border-b-2 border-white/80">
                                                        <tr><th className="py-2 px-2">Year</th><th className="py-2 px-2 text-right">Age</th><th className="py-2 px-2 text-right">Annual SIP</th><th className="py-2 px-2 text-right">Closing Bal</th></tr>
                                                    </thead>
                                                    <tbody className="font-semibold text-slate-800">
                                                        {getGoalFlow(g).map((row, idx) => (
                                                            <React.Fragment key={idx}>
                                                                <tr onClick={() => setExpandedGoalYear(expandedGoalYear.id === g.id && expandedGoalYear.idx === idx ? {id:null, idx:null} : {id: g.id, idx: idx})} className="border-b border-white/40 last:border-0 hover:bg-white/50 cursor-pointer transition-colors">
                                                                    <td className="py-2 px-2 font-bold text-slate-700">Y-{row.y} <Icon name={expandedGoalYear.id === g.id && expandedGoalYear.idx === idx ? "chevron-up" : "chevron-right"} size={12} className="inline text-slate-400 ml-1.5"/></td>
                                                                    <td className="py-2 px-2 text-right">{row.age}</td>
                                                                    <td className="py-2 px-2 text-right text-teal-800 font-bold">{formatCurrency(row.sip)}</td>
                                                                    <td className="py-2 px-2 text-right text-slate-900 font-bold">{formatCurrency(row.balance)}</td>
                                                                </tr>
                                                                {expandedGoalYear.id === g.id && expandedGoalYear.idx === idx && (
                                                                    <tr className="bg-white/80 animate-in slide-in-from-top-2 shadow-[inset_0_2px_4px_rgba(0,0,0,0.02)] border-y border-white/60">
                                                                        <td colSpan="4" className="p-4">
                                                                            <div className="grid grid-cols-4 text-[9px] font-bold uppercase text-teal-700 mb-2 border-b border-white/60 pb-2 tracking-widest">
                                                                                <div>Month</div><div>Opening</div><div>SIP Flow</div><div className="text-right">Closing</div>
                                                                            </div>
                                                                            {row.months.map((mth) => (
                                                                                <div key={mth.m} className="grid grid-cols-4 text-[10px] font-bold py-1.5 border-b border-white/40 last:border-0 hover:bg-white transition-colors">
                                                                                    <div className="text-slate-600">M-{mth.m}</div>
                                                                                    <div className="text-slate-900">{formatCurrency(mth.opening)}</div>
                                                                                    <div className="text-teal-700">{formatCurrency(mth.sip)}</div>
                                                                                    <div className="text-right text-slate-900">{formatCurrency(mth.closing)}</div>
                                                                                </div>
                                                                            ))}
                                                                        </td>
                                                                    </tr>
                                                                )}
                                                            </React.Fragment>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                        
                        {/* Master Projection Portal Overlay Link */}
                        <div className="flex justify-center pt-8 mt-6 border-t border-white/50 group relative z-20 no-print">
                            <button 
                                onClick={() => setShowFullPreview(true)} 
                                className="relative z-10 px-8 py-4 text-white rounded-xl font-bold uppercase text-xs tracking-widest shadow-[0_10px_20px_rgba(79,70,229,0.3)] transition-all flex items-center gap-2 master-glow-btn hover:scale-[1.02] active:scale-95"
                                title="Simulate compounded growth & goal redemptions year-by-year"
                            >
                                <Icon name="monitor-play" size={18}/> View Master Projection
                            </button>
                        </div>
                    </PhaseWrapper>
                    
                    {/* Master Projection Modal Portal */}
                    {showFullPreview && ReactDOM.createPortal(
                        <div className="fixed inset-0 z-[9999] flex items-start justify-center p-0 no-print overflow-y-auto bg-slate-900/60 backdrop-blur-md text-left animate-in fade-in">
                            <div className="relative w-full max-w-[1600px] mx-auto min-h-screen bg-slate-100 shadow-2xl flex flex-col animate-in slide-in-from-bottom-8">
                                <div className="flex justify-between items-start mb-6 text-left border-b border-slate-200 pb-6 p-8 lg:px-12 bg-white">
                                    <div className="text-left">
                                        <h3 className="text-2xl md:text-3xl font-black uppercase text-slate-900 tracking-tighter">Master Wealth Projection</h3>
                                        <p className="text-[10px] font-bold uppercase text-teal-700 tracking-widest mt-1.5">Quantum Simulation Engine v2 (Includes Redemptions)</p>
                                    </div>
                                    
                                    <div className="flex items-center gap-3">
                                        <div className="flex items-center gap-2 bg-slate-50 border border-slate-200 p-1.5 rounded-lg shadow-inner">
                                            <button onClick={() => setShowPostTax(!showPostTax)} className={`px-4 py-2 rounded-md text-[10px] font-bold uppercase transition-all ${showPostTax ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-500 hover:bg-white hover:shadow-sm'}`}>⚖️ 12.5% Tax Mode</button>
                                            <button onClick={() => setShowRealValue(!showRealValue)} className={`px-4 py-2 rounded-md text-[10px] font-bold uppercase transition-all ${showRealValue ? 'bg-teal-600 text-white shadow-md' : 'text-slate-500 hover:bg-white hover:shadow-sm'}`}>👁️ Real Value</button>
                                        </div>
                                        <button onClick={downloadCSV} className="px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-[10px] font-bold uppercase hover:bg-white hover:shadow-sm text-slate-700 transition-all shadow-sm">Export Excel</button>
                                        <button onClick={() => setShowFullPreview(false)} className="w-10 h-10 bg-slate-50 border border-slate-200 rounded-lg flex items-center justify-center hover:bg-white hover:shadow-sm transition-all active:scale-95 text-slate-600 shadow-sm"><Icon name="x" size={20}/></button>
                                    </div>
                                </div>
                                
                                <div className="flex gap-5 border-b border-slate-200 mb-6 px-8 lg:px-12">
                                    <button onClick={() => setProjectionTab('strategy')} className={`pb-4 px-2 text-xs font-bold uppercase tracking-widest border-b-4 transition-all ${projectionTab === 'strategy' ? 'border-teal-600 text-teal-700' : 'border-transparent text-slate-400'}`}>Core Strategy (Simulation)</button>
                                    <button onClick={() => setProjectionTab('existing')} className={`pb-4 px-2 text-xs font-bold uppercase tracking-widest border-b-4 transition-all ${projectionTab === 'existing' ? 'border-indigo-600 text-indigo-700' : 'border-transparent text-slate-400'}`}>Existing Wealth Allocations</button>
                                </div>

                                {projectionTab === 'strategy' ? (
                                    <div className="space-y-6 px-8 lg:px-12 pb-12">
                                        <div className="flex flex-col gap-2 p-4 bg-slate-50 rounded-2xl border border-slate-200 max-w-fit shadow-inner">
                                            <div className="flex gap-2">
                                                <button onClick={() => setScenario('bear')} className={`px-5 py-2 rounded-lg text-[10px] font-bold uppercase transition-all shadow-sm ${scenario==='bear' ? 'bg-rose-600 text-white' : 'bg-white border border-slate-200 text-slate-600 hover:text-rose-600'}`}>🐻 Bear</button>
                                                <button onClick={() => setScenario('base')} className={`px-5 py-2 rounded-lg text-[10px] font-bold uppercase transition-all shadow-sm ${scenario==='base' ? 'bg-slate-800 text-white' : 'bg-white border border-slate-200 text-slate-600 hover:text-slate-800'}`}>⚖️ Base</button>
                                                <button onClick={() => setScenario('bull')} className={`px-5 py-2 rounded-lg text-[10px] font-bold uppercase transition-all shadow-sm ${scenario==='bull' ? 'bg-emerald-600 text-white' : 'bg-white border border-slate-200 text-slate-600 hover:text-emerald-600'}`}>🐂 Bull</button>
                                            </div>
                                            <p className="text-[10px] font-medium text-slate-500 tracking-widest uppercase mt-1 px-1">
                                                {scenario === 'bear' ? 'Stress Test: Simulates a massive -15% market crash in Year 3, followed by sluggish recovery.' : scenario === 'bull' ? 'Optimistic Mode: Computes with a +3% boost to expected returns.' : 'Standard Mode: Computes using standard expected baseline returns.'}
                                            </p>
                                        </div>

                                        <div className="overflow-x-auto text-left border border-slate-200 rounded-2xl shadow-sm bg-white">
                                            <table className="w-full text-left text-sm border-collapse">
                                                <thead className="border-b-2 border-slate-200 text-[10px] font-bold uppercase text-slate-500 tracking-widest text-left bg-slate-50">
                                                    <tr><th className="py-4 px-6">Year</th><th className="py-4 px-6">Age</th><th className="py-4 px-6 text-teal-700">Total SIP Flow</th><th className="py-4 px-6 text-emerald-700">Market Growth</th><th className="py-4 px-6 text-rose-600">Redemptions & Paychecks</th><th className="py-4 px-6 text-right text-slate-900">Closing Corpus</th></tr>
                                                </thead>
                                                <tbody className="font-medium text-slate-700 text-left text-sm">
                                                    {masterSimulationData.map((row, i) => {
                                                        let displayBal = row.closing;
                                                        let displaySip = row.sip;
                                                        let displayInterest = row.growth;
                                                        let displayWithdrawal = row.withdrawals;

                                                        if (showPostTax) {
                                                            let totalGrowthComponent = Math.max(0, displayBal - row.totalPrincipal);
                                                            let taxEstimate = totalGrowthComponent > 100000 ? (totalGrowthComponent - 100000) * 0.125 : 0;
                                                            displayBal -= taxEstimate;
                                                        }

                                                        if (showRealValue) {
                                                            const discount = Math.pow(1.06, row.yr);
                                                            displayBal /= discount; displaySip /= discount;
                                                            displayInterest /= discount; displayWithdrawal /= discount;
                                                        }

                                                        return (
                                                            <React.Fragment key={i}>
                                                                <tr onClick={() => setExpandedSimYear(expandedSimYear === i ? null : i)} className={`border-b border-slate-100 hover:bg-slate-50/80 text-left transition-colors cursor-pointer ${displayBal === 0 ? 'opacity-50' : ''}`}>
                                                                    <td className="py-4 px-6 text-slate-500 font-bold">Y-{row.yr} <Icon name={expandedSimYear === i ? "chevron-up" : "chevron-right"} size={14} className="inline ml-1.5 text-slate-400"/></td>
                                                                    <td className="py-4 px-6 text-slate-900 font-bold">{row.age}Y</td>
                                                                    <td className="py-4 px-6 text-teal-700 font-bold">{formatCurrency(displaySip)}</td>
                                                                    <td className="py-4 px-6 text-emerald-600 font-bold">+{formatCurrency(displayInterest)}</td>
                                                                    <td className="py-4 px-6 text-rose-600">
                                                                        {displayWithdrawal > 0 ? (
                                                                            <div>
                                                                                <span className="font-bold">-{formatCurrency(displayWithdrawal)}</span>
                                                                                <span className="block text-[9px] opacity-75 leading-tight uppercase tracking-widest mt-0.5">{row.withdrawalNames.join(" + ")}</span>
                                                                            </div>
                                                                        ) : "—"}
                                                                    </td>
                                                                    <td className="py-4 px-6 text-right font-black text-slate-900 text-base">
                                                                        {formatCurrency(displayBal)} 
                                                                        {showPostTax && displayBal > 0 && <span className="block text-[8px] font-bold text-indigo-500 uppercase tracking-widest mt-1">Post 12.5% Tax</span>}
                                                                        {displayBal===0 && <span className="text-xs text-rose-500 ml-2 font-bold">(Depleted)</span>}
                                                                    </td>
                                                                </tr>
                                                                {expandedSimYear === i && (
                                                                    <tr className="bg-slate-50/80 shadow-inner animate-in slide-in-from-top-2 border-y border-slate-200">
                                                                        <td colSpan="6" className="p-6">
                                                                            <div className="grid grid-cols-5 text-[9px] font-bold uppercase text-teal-700 mb-3 border-b border-slate-200 pb-2 tracking-widest">
                                                                                <div>Month</div><div>Opening Bal</div><div>SIP Inflow</div><div className="text-rose-600">Withdrawals</div><div className="text-right">Closing Bal (incl. Growth)</div>
                                                                            </div>
                                                                            {row.monthlyFlows.map((mth, mIdx) => {
                                                                                let dOp = mth.opening; let dSip = mth.sip; let dCl = mth.closing; let dW = mth.withdrawal;
                                                                                if (showRealValue) {
                                                                                    const dsc = Math.pow(1.06, row.yr);
                                                                                    dOp /= dsc; dSip /= dsc; dCl /= dsc; dW /= dsc;
                                                                                }
                                                                                return (
                                                                                <div key={mIdx} className="grid grid-cols-5 text-xs font-bold py-2 border-b border-slate-100 last:border-0 hover:bg-white transition-colors">
                                                                                    <div className="text-slate-500">Month {mth.m}</div>
                                                                                    <div className="text-slate-800">{formatCurrency(dOp)}</div>
                                                                                    <div className="text-teal-600">{formatCurrency(dSip)}</div>
                                                                                    <div className="text-rose-600">
                                                                                        {dW > 0 ? (
                                                                                            <span title={row.withdrawalNames.includes("Freedom Paycheck") && dW >= row.monthlyFreedomPaycheck ? `Includes Paycheck: ${formatCurrency(row.monthlyFreedomPaycheck)}` : ""}>
                                                                                                -{formatCurrency(dW)}
                                                                                            </span>
                                                                                        ) : '-'}
                                                                                    </div>
                                                                                    <div className="text-right text-slate-900">{formatCurrency(dCl)}</div>
                                                                                </div>
                                                                            )})}
                                                                            
                                                                            {row.withdrawalNames.includes("Freedom Paycheck") && (
                                                                                <div className="mt-4 p-3 bg-teal-50 border border-teal-100 rounded-lg text-teal-800 text-[11px] font-bold flex justify-between items-center shadow-inner">
                                                                                    <div className="flex items-center gap-2">
                                                                                        <Icon name="umbrella" size={14}/>
                                                                                        <span>RETIREMENT FREEDOM PAYCHECK ACTIVE</span>
                                                                                    </div>
                                                                                    <div className="flex gap-4">
                                                                                        <span>Monthly: {formatCurrency(row.monthlyFreedomPaycheck)}</span>
                                                                                        <span>Annual Paycheck Sum: {formatCurrency(row.withdrawals)}</span>
                                                                                    </div>
                                                                                </div>
                                                                            )}
                                                                        </td>
                                                                    </tr>
                                                                )}
                                                            </React.Fragment>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-6 px-8 lg:px-12 pb-12">
                                        <div className="p-6 bg-indigo-50 border border-indigo-100 rounded-2xl shadow-sm">
                                            <h4 className="text-sm font-bold uppercase tracking-widest text-indigo-900 mb-2">Existing Wealth Distribution</h4>
                                            <p className="text-xs text-indigo-700 font-medium mb-6 max-w-3xl">Here is how your total current assets of <strong className="font-extrabold text-indigo-900">{formatCurrency(totalAssets)}</strong> are being utilized across your master plan.</p>
                                            
                                            {isWealthAllocated ? (
                                                <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
                                                    {Object.entries(allocMap).filter(([_, val]) => safeNumber(val) > 0).map(([id, val]) => {
                                                        const g = plan.find(x => x.id === id);
                                                        return (
                                                            <div key={id} className="p-5 bg-white border border-indigo-100 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                                                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest truncate mb-1">{g ? g.name : 'Goal'}</p>
                                                                <p className="text-2xl font-black text-teal-700">{formatCurrency(totalAssets * (safeNumber(val)/100))}</p>
                                                                <p className="text-[10px] font-bold text-teal-800 bg-teal-50 px-2 py-0.5 rounded-lg inline-block mt-2 border border-teal-100">{val}% of total assets</p>
                                                            </div>
                                                        );
                                                    })}
                                                    <div className="p-5 bg-slate-900 border border-slate-800 rounded-xl shadow-xl text-white">
                                                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Legacy Pot (Unallocated)</p>
                                                        <p className="text-2xl font-black text-white">{formatCurrency(unallocatedData.remaining)}</p>
                                                        <p className="text-[10px] font-bold text-slate-300 mt-2 bg-slate-800 px-2 py-0.5 rounded-lg border border-slate-700 inline-block">Growing independently at {getScenarioReturn(portfolioWeightedReturn).toFixed(1)}%</p>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="p-10 bg-white border border-indigo-100 rounded-2xl text-center shadow-sm">
                                                    <Icon name="lock" size={40} className="mx-auto text-indigo-300 mb-4" />
                                                    <p className="text-base font-bold text-indigo-900 uppercase tracking-widest">Wealth is Locked (Unallocated)</p>
                                                    <p className="text-xs text-indigo-600 mt-3 max-w-xl mx-auto font-medium leading-relaxed">You have chosen not to deploy your existing wealth toward any specific goals. It will grow independently as a Legacy Pot.</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>,
                        document.body
                    )}
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('cover');
            const [step, setStep] = useState(1);
            const [isTaskSwitcherOpen, setIsTaskSwitcherOpen] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const parallaxRef = useRef(null);
            const scrollContainerRef = useRef(null);
            
            const emptyProfile = { 
                name: '', age: '', retireAge: '', salary: '', businessIncome: '', 
                married: false, hasChildren: false, childCount: 0, 
                rent: '', emi: '', emiEndYear: '', loanOutstanding: '', household: '', lifestyle: '', vacation: '', 
                insuranceActive: false, healthPremium: '', lifePremium: '', 
                mfPool: '', stockPool: '', debtPool: '', cashPool: '', fdPool: '', realAssets: '', 
                customReservoirs: [], horizonAge: '', hasGoals: false, customGoals: [],
                childAges: {}, activeChildMilestones: {}, childMilestoneData: {}
            };

            const [profile, setProfile] = useState(() => {
                const saved = localStorage.getItem('financial_brain_profile');
                return saved ? JSON.parse(saved) : emptyProfile;
            });

            useEffect(() => {
                localStorage.setItem('financial_brain_profile', JSON.stringify(profile));
            }, [profile]);

            useEffect(() => {
                if (scrollContainerRef.current) {
                    scrollContainerRef.current.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }, [step, view]);

            // PERFORMANCE FIX: Detached mouse parallax from React State
            useEffect(() => { 
                let frame;
                const handleMove = (e) => { 
                    if (!parallaxRef.current) return;
                    const x = (e.clientX / window.innerWidth) - 0.5;
                    const y = (e.clientY / window.innerHeight) - 0.5;
                    cancelAnimationFrame(frame);
                    frame = requestAnimationFrame(() => {
                        if (parallaxRef.current) {
                            parallaxRef.current.style.transform = `translate(${x * -20}px, ${y * -20}px)`;
                        }
                    });
                }; 
                window.addEventListener('mousemove', handleMove); 
                return () => { window.removeEventListener('mousemove', handleMove); cancelAnimationFrame(frame); }; 
            }, []);

            const handleNav = (id) => { if (id === 5 && (safeNumber(profile.retireAge) <= safeNumber(profile.age))) return; setStep(id); };

            const confirmResetJourney = () => { 
                localStorage.removeItem('financial_brain_profile');
                setProfile({...emptyProfile}); 
                setStep(1); 
                setView('cover'); 
                setShowResetConfirm(false);
            };

            const isBlueprintMode = view === 'flow' && step === 5;

            return (
                <div className="relative h-screen w-screen overflow-hidden text-left">
                    {/* Custom Confirmation Modal */}
                    {showResetConfirm && (
                        <div className="fixed inset-0 z-[9999] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-md animate-in fade-in duration-200">
                            <div className="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl animate-in zoom-in-95 text-center border border-slate-100">
                                <div className="w-16 h-16 bg-rose-50 rounded-full flex items-center justify-center mx-auto mb-5 text-rose-500 border border-rose-100">
                                    <Icon name="refresh-cw" size={32} />
                                </div>
                                <h3 className="text-xl font-black text-slate-900 mb-2 uppercase tracking-tighter">Restart Journey?</h3>
                                <p className="text-xs font-semibold text-slate-500 mb-8 leading-relaxed px-2">This will wipe all current inputs and return you to the command center. This action cannot be undone.</p>
                                <div className="flex gap-3 w-full">
                                    <button onClick={() => setShowResetConfirm(false)} className="flex-1 py-3 rounded-xl text-xs font-bold uppercase tracking-widest text-slate-600 bg-slate-50 border border-slate-200 hover:bg-slate-100 transition-colors shadow-sm">Cancel</button>
                                    <button onClick={confirmResetJourney} className="flex-1 py-3 rounded-xl text-xs font-bold uppercase tracking-widest text-white bg-rose-600 hover:bg-rose-700 shadow-lg shadow-rose-200 transition-all active:scale-95">Restart</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <div ref={parallaxRef} className={`parallax-wrapper ${isBlueprintMode ? 'bg-blur-active' : ''}`}>
                        <LiquidBackground view={view} isBlueprintMode={isBlueprintMode} />
                        <FloatingPillCloud active={view === 'cover'} />
                    </div>

                    <div className="relative h-full w-full overflow-hidden flex flex-col text-left">
                        {view !== 'cover' && (
                            <header className="px-6 py-4 premium-card border-b border-white/60 flex justify-between items-center no-print animate-in slide-in-from-top duration-700 shrink-0 text-left z-50 rounded-none shadow-[0_4px_20px_rgba(15,23,42,0.03)]">
                                <div className="flex items-center gap-3 cursor-pointer group text-left" onClick={() => setView('cover')}>
                                    <div className="p-2 bg-slate-900 text-white rounded-lg shadow-lg brain-glow leading-none flex items-center justify-center text-left"><Icon name="brain" size={16}/></div>
                                    <div className="text-left"><h1 className="text-sm font-black text-slate-900 uppercase tracking-tighter leading-none text-left">Financial Brain</h1><p className="text-[8px] font-bold text-slate-600 mt-1 uppercase tracking-widest leading-none text-left">Powered by BABA Tools</p></div>
                                </div>
                                <button onClick={() => setShowResetConfirm(true)} className="px-4 py-2.5 bg-white/60 backdrop-blur-md text-slate-800 border border-white/80 rounded-lg font-bold text-[10px] uppercase tracking-widest shadow-sm flex items-center gap-2 hover:bg-white active:scale-95 transition-all"><Icon name="refresh-cw" size={14}/> Start New Journey</button>
                            </header>
                        )}
                        
                        <div ref={scrollContainerRef} className="page-transition-container flex-1 custom-scrollbar text-left">
                            <div className={view !== 'cover' ? "pt-6 pb-28 text-left" : "text-left"}>
                                {view === 'cover' && (
                                    <div className="min-h-screen flex items-center justify-center p-6 relative text-left cinematic-enter">
                                        <div className="relative max-w-md w-full">
                                            {/* Aura emits from behind the precise card structure */}
                                            <div className="hero-glow-aura"></div>
                                            
                                            <div className="hero-card p-12 text-center relative z-10">
                                                <div className="w-24 h-24 bg-gradient-to-br from-white to-slate-50 rounded-[28px] flex items-center justify-center mx-auto shadow-[0_20px_40px_-10px_rgba(15,118,110,0.2),_inset_0_2px_4px_rgba(255,255,255,1)] border border-white mb-8 text-teal-700 transition-transform hover:scale-105 hover:-rotate-3 relative group">
                                                    <div className="absolute inset-0 bg-teal-400/20 rounded-[28px] opacity-0 group-hover:opacity-100 transition-opacity blur-md"></div>
                                                    <Icon name="brain" size={48} className="relative z-10 drop-shadow-md" />
                                                </div>
                                                
                                                <h1 className="text-[40px] font-black heading-font uppercase mb-3 tracking-tighter leading-none text-center text-transparent bg-clip-text bg-gradient-to-br from-slate-900 via-slate-800 to-slate-500 drop-shadow-sm">Financial Brain</h1>
                                                <p className="text-teal-700 text-[10px] font-extrabold uppercase tracking-[0.5em] mb-10 text-center">Powered by BABA Tools</p>
                                                
                                                <button onClick={() => setView('flow')} className="w-full hero-btn py-5 rounded-2xl font-extrabold uppercase text-xs tracking-widest flex items-center justify-center gap-3 group text-center relative overflow-hidden">
                                                    <span className="relative z-10 flex items-center gap-2">Start Your Journey <Icon name="chevron-right" size={18} className="group-hover:translate-x-1.5 transition-transform duration-300"/></span>
                                                    <div className="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite]"></div>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {view === 'flow' && step < 5 && (
                                    <CalibrationFlow profile={profile} setProfile={setProfile} step={step} />
                                )}
                                {view === 'flow' && step === 5 && (
                                    <SynthesisView profile={profile} setProfile={setProfile} />
                                )}
                            </div>
                        </div>

                        {view !== 'cover' && (
                            <div className="fixed bottom-0 left-0 right-0 z-50 px-4 py-2 bg-white/60 backdrop-blur-xl border-t border-white/80 no-print animate-in slide-in-from-bottom-8 duration-700 shadow-[0_-10px_30px_rgba(15,23,42,0.05)] text-left">
                                <div className="max-w-[1800px] w-full mx-auto px-4 md:px-8 flex items-center justify-between gap-6 text-left">
                                    <div className="flex-1 flex items-center gap-4 text-left">
                                        <button onClick={() => setIsTaskSwitcherOpen(true)} className="w-10 h-10 bg-slate-900 text-white rounded-lg flex items-center justify-center shadow-md hover:scale-110 active:scale-95 transition-all group text-left"><Icon name="grid" size={16}/></button>
                                        <div className="flex-1 max-w-xs hidden sm:block text-left">
                                            <div className="flex justify-between items-end mb-1 text-left">
                                                <span className="text-[8px] font-bold uppercase tracking-[0.4em] text-slate-500 text-left">Sequence Progress</span>
                                                <span className="text-[9px] font-bold text-teal-800 bg-teal-50/80 px-2 py-0.5 rounded border border-teal-200/50 text-left">{Math.round((step/5)*100)}%</span>
                                            </div>
                                            <div className="h-1 bg-slate-200/50 rounded-full overflow-hidden shadow-[inset_0_1px_2px_rgba(0,0,0,0.05)] border border-white/50 text-left"><div className="h-full bg-teal-500 transition-all duration-1000 ease-out shadow-[0_0_15px_rgba(20,184,166,0.8)] text-left" style={{width: `${(step/5)*100}%`}} /></div>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-4 text-left">
                                        {step === 5 ? (
                                            <>
                                                <button onClick={() => setIsTaskSwitcherOpen(true)} className="px-5 h-10 bg-white/80 border border-white rounded-lg font-bold uppercase text-[10px] tracking-widest shadow-sm active:scale-95 transition-all flex items-center gap-2 hover:shadow-md hover:bg-white text-slate-800 text-left">Edit Inputs</button>
                                            </>
                                        ) : (
                                            <div className="flex flex-col items-end gap-1">
                                                <div className="flex gap-2">
                                                    <button onClick={() => step > 1 ? setStep(step-1) : setView('cover')} className="w-10 h-10 bg-white/80 border border-white/60 text-slate-700 rounded-lg flex items-center justify-center hover:bg-white active:scale-95 transition-all shadow-sm text-left"><Icon name="arrow-left" size={16}/></button>
                                                    <button 
                                                        disabled={(step === 1 && (safeNumber(profile.retireAge) <= safeNumber(profile.age))) || (step === 4 && (!profile.horizonAge || safeNumber(profile.horizonAge) <= safeNumber(profile.retireAge)))}
                                                        onClick={() => { if(step < 5) setStep(step+1); }} 
                                                        className="px-6 h-10 bg-slate-900 text-white rounded-lg font-bold uppercase text-[10px] tracking-widest shadow-md active:scale-95 transition-all flex items-center gap-2 disabled:opacity-40 disabled:cursor-not-allowed hover:shadow-lg hover:bg-slate-950 text-left"
                                                    > {step === 4 ? 'Generate Blueprint' : 'Next Step'} <Icon name="arrow-right" size={14}/> </button>
                                                </div>
                                                {step === 4 && (!profile.horizonAge || safeNumber(profile.horizonAge) <= safeNumber(profile.retireAge)) && (
                                                    <span className="text-[8px] text-rose-600 font-bold animate-pulse text-right px-1">Horizon Age must be > Retirement</span>
                                                )}
                                                {step === 1 && (safeNumber(profile.retireAge) <= safeNumber(profile.age)) && (
                                                    <span className="text-[8px] text-rose-600 font-bold animate-pulse text-right px-1">Retirement Age must be > Current Age</span>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    <TaskSwitcher isOpen={isTaskSwitcherOpen} onToggle={() => setIsTaskSwitcherOpen(!isTaskSwitcherOpen)} currentStep={step} onJump={handleNav} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
